(function(e){if(!BX.Sale)BX.Sale={};if(BX.Sale.Cashbox)return;BX.Sale.Cashbox={ajaxUrl:"/bitrix/admin/sale_cashbox_ajax.php",init:function(){this.toggleKkmList()},getRestrictionParamsHtml:function(t){if(!t.class)return;t.params=t.params||{};t.restrictionId=t.restrictionId||0;t.sort=t.sort||100;ShowWaitWindow();var a={action:"get_restriction_params_html",className:t.class,params:t.params,cashboxId:t.cashboxId,sort:t.sort,lang:t.lang,sessid:BX.bitrix_sessid()};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:a,onsuccess:function(a){CloseWaitWindow();if(a&&a.RESTRICTION_HTML&&!a.ERROR){var i=BX.processHTML(a.RESTRICTION_HTML);BX.Sale.Cashbox.showRestrictionParamsDialog(i["HTML"],t);e["cashboxGetRestrictionHtmlScriptsLoadingStarted"]=false;var s=function(t){if(!t)BX.removeCustomEvent("cashboxGetRestrictionHtmlScriptsReady",s);for(var a in i["SCRIPT"]){BX.evalGlobal(i["SCRIPT"][a]["JS"]);delete i["SCRIPT"][a];if(t&&e["cashboxGetRestrictionHtmlScriptsLoadingStarted"])return}};BX.addCustomEvent("cashboxGetRestrictionHtmlScriptsReady",s);s(true);BX.loadCSS(i["STYLE"])}else if(a&&a.ERROR){BX.debug("Error receiving restriction params html: "+a.ERROR)}else{BX.debug("Error receiving restriction params html!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error adding restriction!")}})},showRestrictionParamsDialog:function(e,t){var a=460,i=new BX.CDialog({content:'<form id="sale-cashbox-restriction-edit-form">'+e+"</form>",title:BX.message("SALE_RDL_RESTRICTION")+": "+t.title,width:a,height:500,resizable:true});i.ClearButtons();i.SetButtons([{title:BX.message("SALE_RDL_SAVE"),action:function(){var e=BX("sale-cashbox-restriction-edit-form"),a=BX.ajax.prepareForm(e),i=!!a&&a.data?a.data:{};BX.Sale.Cashbox.saveRestriction(t,i);this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);BX.addCustomEvent(i,"onWindowClose",function(e){e.DIV.parentNode.removeChild(e.DIV)});i.Show();i.adjustSizeEx()},saveRestriction:function(e,t){ShowWaitWindow();var a=t.RESTRICTION||{},i={action:"save_restriction",params:a,sort:t.SORT,className:e.class,cashboxId:e.cashboxId,restrictionId:e.restrictionId,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:i,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.Cashbox.insertAjaxRestrictionHtml(e.HTML)}else{alert(e.ERROR)}},onfailure:function(){CloseWaitWindow()}})},deleteRestriction:function(e,t){if(!e)return;ShowWaitWindow();var a={action:"delete_restriction",restrictionId:e,cashboxId:t,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:a,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.Cashbox.insertAjaxRestrictionHtml(e.HTML);if(e.ERROR)BX.debug("Error deleting restriction: "+e.ERROR)}else{BX.debug("Error deleting restriction!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error refreshing restriction!")}})},insertAjaxRestrictionHtml:function(e){var t=BX.processHTML(e),a=BX("sale-cashbox-restriction-container");if(!a)return;BX.loadCSS(t["STYLE"]);a.innerHTML=t["HTML"];for(var i in t["SCRIPT"])BX.evalGlobal(t["SCRIPT"][i]["JS"])},generateConnectionLink:function(){var e={action:"generate_link",sessid:BX.bitrix_sessid()};BX.showWait();BX.ajax({data:e,method:"POST",dataType:"json",url:this.ajaxUrl,onsuccess:BX.delegate(function(e){BX.closeWait();if(e){if(!e.ERROR){text='<div style="margin-bottom: 50px;">'+'<ul class="adm-cashbox-list2 adm-cashbox-inner">'+'<li style="margin-bottom: 20px;">'+BX.message("SALE_CASHBOX_WINDOW_STEP_1")+'<br> <b id="generated-link">'+e.LINK+"</b></li>"+"<li>"+BX.message("SALE_CASHBOX_WINDOW_STEP_2")+"</li>"+"</ul>"+"</div>";var t=new BX.CAdminDialog({content:text,title:BX.message("SALE_CASHBOX_WINDOW_TITLE"),resizable:false,draggable:false,height:"145",width:"516",buttons:[{title:top.BX.message("SALE_CASHBOX_COPY"),id:"copyCheckBtn",name:"copybtn",className:top.BX.browser.IsIE()&&top.BX.browser.IsDoctype()&&!top.BX.browser.IsIE10()?"":"adm-btn-save"},BX.CAdminDialog.btnCancel]});t.Show();var a=BX("copyCheckBtn");if(a)BX.clipboard.bindCopyClick(a,{text:e.LINK})}else{BX.debug(e.ERROR)}}},this),onfailure:function(){BX.debug("onfailure: generateConnectionLink")}})},connectToKKM:function(e){BX.ajax({data:{action:"generate_link",sessid:BX.bitrix_sessid()},method:"POST",dataType:"json",url:this.ajaxUrl,onsuccess:BX.delegate(function(t){BX.closeWait();if(t){if(!t.ERROR){var a=e.parentNode;BX.hide(a);var i=BX("container-instruction");i.style.display="block";BX("cashbox-url").innerHTML=t.LINK}else{BX.debug(t.ERROR)}}},this),onfailure:function(){BX.debug("onfailure: generateConnectionLink")}})},toggleKkmList:function(){var e=BX("HANDLER").value;var t=BX("KKM_ID").parentNode.parentNode;if(t){if(e==="\\Bitrix\\Sale\\Cashbox\\CashboxBitrix"){t.style.display="table-row";BX("KKM_ID").disabled=false}else{t.style.display="none";BX("KKM_ID").disabled=true}}},reloadSettings:function(){this.toggleKkmList();BX.ajax({data:{action:"reload_settings",kkmId:BX("KKM_ID").value||0,handler:BX("HANDLER").value||"",sessid:BX.bitrix_sessid()},method:"POST",dataType:"json",url:this.ajaxUrl,onsuccess:BX.delegate(function(e){BX.closeWait();if(e&&e.hasOwnProperty("HTML"))BX("sale-cashbox-settings-container").innerHTML=e.HTML},this),onfailure:function(){BX.debug("onfailure: reloadSettings")}})},showCreateCheckWindow:function(e){var t={action:"addCheckOrder",type:e||null,returnHtml:true,sessid:BX.bitrix_sessid()};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_order_ajax.php",data:t,onsuccess:function(e){if(e.ERROR&&e.ERROR.length>0){alert(e.ERROR)}else{var t=new BX.CAdminDialog({title:BX.message("CASHBOX_CREATE_WINDOW_TITLE"),content:e.HTML,resizable:false,draggable:true,height:"300",width:"516",buttons:[{title:BX.message("JS_CORE_WINDOW_SAVE"),id:"saveCheckBtn",name:"savebtn",className:top.BX.browser.IsIE()&&top.BX.browser.IsDoctype()&&!top.BX.browser.IsIE10()?"":"adm-btn-save"},{title:top.BX.message("JS_CORE_WINDOW_CANCEL"),id:"cancelCheckBtn",name:"cancel"}]});var a=BX("checkInputOrder");var i=BX("checkSelectPayment");var s=BX("checkSelectShipment");var o=BX("checkSelectType");t.Show();BX.bind(BX("checkInputOrder"),"input",BX.delegate(function(){var e={sessid:BX.bitrix_sessid(),orderId:a.value,paymentId:i.value,shipmentId:s.value,typeId:o.value,action:"addCheckOrder"};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_order_ajax.php",data:e,onsuccess:function(e){var t="";if(e.ERROR&&e.ERROR.length>0){alert(e.ERROR)}else{t="<option selected='selected' value=''>"+BX.message("CASHBOX_CREATE_WINDOW_NOT_SELECT")+"</option>";if(e.ORDER_DATA.PAYMENT&&e.ORDER_DATA.PAYMENT.length>0){i.removeAttribute("disabled");for(var a in e.ORDER_DATA.PAYMENT){t=t+'<option value="'+e.ORDER_DATA.PAYMENT[a].ID+'">'+e.ORDER_DATA.PAYMENT[a].NAME+"</option>"}}else{i.setAttribute("disabled","disabled")}i.innerHTML=t;t="<option selected='selected' value=''>"+BX.message("CASHBOX_CREATE_WINDOW_NOT_SELECT")+"</option>";if(e.ORDER_DATA.SHIPMENT&&e.ORDER_DATA.SHIPMENT.length>0){s.removeAttribute("disabled");for(a in e.ORDER_DATA.SHIPMENT){t=t+'<option value="'+e.ORDER_DATA.SHIPMENT[a].ID+'">'+e.ORDER_DATA.SHIPMENT[a].NAME+"</option>"}}else{s.setAttribute("disabled","disabled")}s.innerHTML=t}},onfailure:function(){BX.debug("Select params error")}})}),this);BX.bind(BX("cancelCheckBtn"),"click",BX.delegate(function(){t.Close();t.DIV.parentNode.removeChild(t.DIV)}),this);BX.bind(BX("saveCheckBtn"),"click",BX.delegate(function(){var e={sessid:BX.bitrix_sessid(),orderId:a.value,paymentId:i.value,shipmentId:s.value,typeId:o.value,action:"saveCheck"};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_order_ajax.php",data:e,onsuccess:function(e){if(e.ERROR&&e.ERROR.length>0){alert(e.ERROR)}else{t.Close();location.reload()}},onfailure:function(){BX.debug("Select params error")}})}),this)}},onfailure:function(){BX.debug("Create window error")}})}}})(window);
//# sourceMappingURL=cashbox.map.js