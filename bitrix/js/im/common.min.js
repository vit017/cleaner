(function(e){if(e.BX.MessengerCommon)return;var s=e.BX;s.MessengerCommon=function(){this.BXIM={};this.sendBotCommand=false;this.sendBotCommandBlock={};this.tryCheckConnect={}};s.MessengerCommon.prototype.setBxIm=function(e){this.BXIM=e};s.MessengerCommon.prototype.isPage=function(){return typeof s.MessengerWindow!="undefined"&&!(this.BXIM.context=="POPUP-FULLSCREEN"&&s.browser.IsMobile())};s.MessengerCommon.prototype.isDesktop=function(){return typeof s.desktop!="undefined"&&s.desktop.apiReady};s.MessengerCommon.prototype.isMobile=function(){return this.BXIM.mobileVersion};s.MessengerCommon.prototype.isLinesOperator=function(){return this.BXIM.messenger.openlines&&this.BXIM.messenger.openlines.queue&&this.BXIM.messenger.openlines.queue.length>0};s.MessengerCommon.prototype.isBot=function(e){return typeof this.BXIM.messenger.bot[e]!="undefined"};s.MessengerCommon.prototype.getDebugInfo=function(){return{context:this.BXIM.context,design:this.BXIM.design,isDesktop:this.isDesktop()?"Y":"N",isPage:this.isPage()?"Y":"N",isMobile:this.isMobile()?"Y":"N",vInitedCall:s.localStorage.get("vInitedCall")?"Y":"N",desktopStatus:this.BXIM.desktopStatus?"Y":"N",callInit:this.BXIM.webrtc.callInit?"Y":"N",callActive:this.BXIM.webrtc.callActive?"Y":"N",appVersion:navigator.appVersion}};s.MessengerCommon.prototype.checkInternetConnection=function(e,t,r,i){if(typeof e!="function"){e=function(){if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("online",false)}}}if(typeof t!="function")t=function(){};if(typeof r!="number")r=1;if(!i&&r>1)i=+new Date;if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("connecting")}s.ajax({url:"//www.bitrixsoft.com/200.ok."+ +new Date,method:"GET",dataType:"html",skipAuthCheck:true,skipBxHeader:true,timeout:1,onsuccess:function(n){if(n=="OK"){console.log("Checking internet connection... success!");delete s.MessengerCommon.tryCheckConnect[i];e()}else{if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("offline")}console.log("Checking internet connection... failure!");if(r==1){delete s.MessengerCommon.tryCheckConnect[i];t()}else{if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("connecting")}clearTimeout(s.MessengerCommon.tryCheckConnect[i]);s.MessengerCommon.tryCheckConnect[i]=setTimeout(function(){s.MessengerCommon.checkInternetConnection(e,t,r-1,i)},5e3)}}},onfailure:function(){console.log("Checking internet connection... failure!");if(r==1){delete s.MessengerCommon.tryCheckConnect[i];t()}else{clearTimeout(s.MessengerCommon.tryCheckConnect[i]);s.MessengerCommon.tryCheckConnect[i]=setTimeout(function(){s.MessengerCommon.checkInternetConnection(e,t,r-1,i)},5e3)}}});return true};s.MessengerCommon.prototype.muteMessageChat=function(e,t,r){var i=0;var n=false;if(e.toString().substr(0,4)=="chat"){i=e.toString().substr(4);if(!this.BXIM.messenger.chat[i])return false}else{i=this.BXIM.messenger.userChat[e];if(!i)return false}r=r!=false;if(!this.BXIM.messenger.userChatBlockStatus[i])this.BXIM.messenger.userChatBlockStatus[i]={};if(t){this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=t}else{if(this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=="Y")this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]="N";else this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]="Y"}this.BXIM.messenger.dialogStatusRedraw();this.BXIM.messenger.updateMessageCount();if(r){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_MUTE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_MUTE:"Y",CHAT_ID:i,MUTE:this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId],IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}};s.MessengerCommon.prototype.MobileActionEqual=function(e){if(!this.isMobile())return true;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return true}return false};s.MessengerCommon.prototype.MobileActionNotEqual=function(e){if(!this.isMobile())return false;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return false}return true};s.MessengerCommon.prototype.isScrollMax=function(s,t){if(!s)return true;t=typeof t=="number"?t:0;if(this.isMobile()){var r=e.orientation==0?screen.height-125:screen.width-113;return document.body.scrollHeight-r-r/2<=s.scrollTop}else{return s.scrollHeight-s.offsetHeight-t<=s.scrollTop}};s.MessengerCommon.prototype.isScrollMin=function(e){if(!e)return false;return 0==e.scrollTop};s.MessengerCommon.prototype.enableScroll=function(e,s,t){if(!e)return false;if(this.BXIM.messenger.isBodyScroll)return false;t=t!==false;s=400;return t&&this.isScrollMax(e,s)};s.MessengerCommon.prototype.preventDefault=function(t){t=t||e.event;if(t.stopPropagation)t.stopPropagation();else t.cancelBubble=true;if(typeof BXIM!="undefined"&&BXIM.messenger&&BXIM.messenger.closeMenuPopup)BXIM.messenger.closeMenuPopup();if(typeof s!="undefined"&&s.calendar&&s.calendar.get().popup)s.calendar.get().popup.close()};s.MessengerCommon.prototype.countObject=function(e){var s=0;for(var t in e){if(e.hasOwnProperty(t)){s++}}return s};s.MessengerCommon.prototype.isElementCoordsBelow=function(e,s,t,r){if(this.isMobile()){return true}if(!s||typeof s.getElementsByClassName=="undefined"){return false}t=t?t:0;var i=this.getElementCoords(e,s);i.bottom=i.top+e.offsetHeight;var n=i.top>=t;var a=i.bottom>t;if(r){return{top:n,bottom:a,coords:i}}else{return n||a}};s.MessengerCommon.prototype.isElementVisibleOnScreen=function(e,s,t){if(this.isMobile()){return BitrixMobile.isElementVisibleOnScreen(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var r=this.getElementCoords(e,s);r.bottom=r.top+e.offsetHeight;var i=s.scrollTop;var n=i+s.clientHeight;var a=r.top>=0&&r.top<n;var o=r.bottom>0&&r.bottom<s.clientHeight;if(t){return{result:a||o,top:a,bottom:o,coords:r}}else{return a||o}};s.MessengerCommon.prototype.getElementCoords=function(e,s){if(this.isMobile()){return BitrixMobile.getElementCoords(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var t=e.getBoundingClientRect();var r=s.getBoundingClientRect();return{originTop:t.top,originLeft:t.left,top:t.top-r.top,left:t.left-r.left}};s.MessengerCommon.prototype.getDateFormatType=function(e){e=e?e.toString().toUpperCase():"DEFAULT";var t=[];if(e=="MESSAGE_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.date.convertBitrixFormat(s.message("IM_M_MESSAGE_TITLE_FORMAT_DATE"))]]}else if(e=="MESSAGE"){t=[["",s.message("IM_M_MESSAGE_FORMAT_TIME")]]}else if(e=="RECENT_TITLE"){t=[["tommorow","today"],["today","today"],["yesterday","yesterday"],["",s.date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else if(e=="RECENT_OL_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else{t=[["tommorow","tommorow, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["today","today, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["yesterday","yesterday, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["",s.date.convertBitrixFormat(s.message("FORMAT_DATETIME"))]]}return t};s.MessengerCommon.prototype.formatDate=function(e,t){if(typeof t=="undefined"){t=this.getDateFormatType("DEFAULT")}return s.date.format(t,parseInt(e)+parseInt(s.message("SERVER_TZ_OFFSET")),this.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),true)};s.MessengerCommon.prototype.getNowDate=function(e){var t=new Date;if(e==true)t=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0);return Math.round(+t/1e3)+parseInt(s.message("USER_TZ_OFFSET"))};s.MessengerCommon.prototype.getDateDiff=function(e){var t=s.message("USER_TZ_OFFSET");if(t==="")return 0;var r=this.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET"));var i=parseInt(e)+parseInt(s.message("SERVER_TZ_OFFSET"));return r-i};s.MessengerCommon.prototype.isBlankAvatar=function(e){return e==""||e.indexOf(this.BXIM.pathToBlankImage)>=0};s.MessengerCommon.prototype.getDefaultAvatar=function(e){return"/bitrix/js/im/images/default-avatar-"+e+".png"};s.MessengerCommon.prototype.hideErrorImage=function(e){var s=e.src;if(e.parentNode&&e.parentNode.parentNode){e.parentNode.parentNode.className="";e.parentNode.parentNode.innerHTML='<a href="'+s+'" target="_blank">'+s+"</a>"}};s.MessengerCommon.prototype.prepareText=function(e,t,r,i,n){var a=e;t=t==true;r=r==true;i=i==true;n=n?n:false;a=s.util.trim(a);if(a.indexOf("/me")==0){a=a.substr(4);a="<i>"+a+"</i>"}else if(a.indexOf("/loud")==0){a=a.substr(6);a="<b>"+a+"</b>"}var o="&gt;&gt;";if(r&&a.indexOf(o)>=0){var l=false;var m=a.split("<br />");for(var h=0;h<m.length;h++){if(m[h].substring(0,o.length)==o){m[h]=m[h].replace(o,'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">');while(++h<m.length&&m[h].substring(0,o.length)==o){m[h]=m[h].replace(o,"")}m[h-1]+="</div></div>";l=true}}a=m.join("<br />")}if(t){a=s.util.htmlspecialchars(a)}a=this.decodeBbCode(a,r);if(r){a=a.replace(/------------------------------------------------------<br \/>(.*?)\[(.*?)\]<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i,n){return(n>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap"><div class="bx-messenger-content-quote-name">'+s+' <span class="bx-messenger-content-quote-time">'+t+"</span></div>"+r+"</div></div><br />"});a=a.replace(/------------------------------------------------------<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i){return(i>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">'+s+"</div></div><br />"})}if(t){a=a.replace(/\n/gi,"<br />")}a=a.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");if(i){a=a.replace(/<a(.*?)>(http[s]{0,1}:\/\/.*?)<\/a>/gi,function(e,t,r,i){if(!r.match(/(\.(jpg|jpeg|png|gif)\?|\.(jpg|jpeg|png|gif)$)/i)||r.indexOf("/docs/pub/")>0||r.indexOf("logout=yes")>0){return e}else if(s.MessengerCommon.isMobile()){return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(this.src);" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span><br>'}else{return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><a'+t+' target="_blank" class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></a></span><br>'}})}if(n){a=a.replace(new RegExp("("+n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"),'<span class="bx-messenger-highlight">$1</span>')}if(this.BXIM.settings.enableBigSmile){a=a.replace(/^(\s*<img\s+src=[^>]+?data-code=[^>]+?data-definition="UHD"[^>]+?style="width:)(\d+)(px[^>]+?height:)(\d+)(px[^>]+?class="bx-smile"\s*\/?>\s*)$/,function g(e,s,t,r,i,n){return s+parseInt(t,10)*2+r+parseInt(i,10)*2+n})}if(a.substr(-6)=="<br />"){a=a.substr(0,a.length-6)}a=a.replace(/<br><br \/>/gi,"<br />");a=a.replace(/<br \/><br>/gi,"<br />");return a};s.MessengerCommon.prototype.purifyText=function(e){e=e.replace(/\[RATING\=([1-5]{1})\]/gi,s.delegate(function(e,t){return"["+s.message("IM_F_RATING")+"] "},this));e=this.prepareText(e);e=e.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");e=e.replace(/<span.*?title="([^"]*)".*?>.*?<\/span>/gi,"($1)");e=e.replace(/<img.*?title="([^"]*)".*?>/gi,"($1)");e=e.replace(/\[ATTACH=([0-9]{1,})\]/gi,s.delegate(function(e,t,r){return t==1e4?"":"["+s.message("IM_F_ATTACH")+"] "},this));e=e.replace(/<s>([^"]*)<\/s>/gi," ");e=e.replace(/\[s\]([^"]*)\[\/s\]/gi," ");e=e.replace(/\[[buis]\](.*?)\[\/[buis]\]/gi,"$1");e=e.replace("<br />"," ").replace(/<\/?[^>]+>/gi,"").replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim," ["+s.message("IM_M_QUOTE_BLOCK")+"] ");if(e.length<=0){e=s.message("IM_M_DELETED")}return e};s.MessengerCommon.prototype.decodeBbCode=function(e,t){t=typeof t?false:t;e=e.replace(/\[LIKE\]/gi,'<span class="bx-smile bx-im-smile-like" title="'+s.message("IM_MESSAGE_LIKE")+'"></span>');e=e.replace(/\[DISLIKE\]/gi,'<span class="bx-smile bx-im-smile-dislike" title="'+s.message("IM_MESSAGE_DISLIKE")+'"></span>');e=e.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,s.delegate(function(e,s,r){var i="";if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="livechat")return r;s=parseInt(s);if(!t&&r&&s>0)i='<span class="bx-messenger-ajax '+(s==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+s+'">'+r+"</span>";else i=r;return i},this));e=e.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,function(e,s,r,i){var n="";r=parseInt(r);if(!t&&i&&r>0&&typeof BXIM!="undefined"){if(s){n='<span class="bx-messenger-ajax" data-entity="openlines" data-sessionId="'+r+'">'+i+"</span>"}else{n='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+r+'">'+i+"</span>"}}else{n=i}return n});e=e.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,s,r){var i="";s=parseInt(s);if(!t&&r&&s>0)i='<span class="bx-messenger-ajax" data-entity="phoneCallHistory" data-historyId="'+s+'">'+r+"</span>";else i=r;return i});e=e.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,function(e,r,i){var n="";i=i?i:r;r=r?r:i;if(!t&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);n='<span class="bx-messenger-command" data-entity="send" title="'+s.message("IM_BB_SEND")+'">'+i+"</span>";n+='<span class="bx-messenger-command-data">'+r+"</span>"}else{n=i}return n});e=e.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,function(e,r,i){var n="";i=i?i:r;r=r?r:i;if(!t&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\/\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);n='<span class="bx-messenger-command" data-entity="put" title="'+s.message("IM_BB_PUT")+'">'+i+"</span>";n+='<span class="bx-messenger-command-data">'+r+"</span>"}else{n=i}return n});e=e.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,function(e,r,i){var n="";i=i?i:r;r=r?r:i;if(!t&&i)n='<span class="bx-messenger-command" data-entity="call" data-command="'+s.util.htmlspecialchars(r)+'">'+i+"</span>";else n=i;return n});var r=0;if(this.BXIM.settings.enableBigSmile){var r=s.util.trim(e.replace(/\[icon\=([^\]]*)\]/gi,"")).length}e=e.replace(/\[icon\=([^\]]*)\]/gi,s.delegate(function(e){var t=e.match(/icon\=(\S+[^\s.,> )\];\'\"!?])/i);if(t&&t[1]){t=t[1]}else{return""}var i={src:t,border:0};var n=e.match(/size\=(\d+)/i);if(n&&n[1]){i["width"]=n[1];i["height"]=n[1]}else{var a=e.match(/width\=(\d+)/i);if(a&&a[1]){i["width"]=a[1]}var o=e.match(/height\=(\d+)/i);if(o&&o[1]){i["height"]=o[1]}if(i["width"]&&!i["height"]){i["height"]=i["width"]}else if(i["height"]&&!i["width"]){i["width"]=i["height"]}else if(i["height"]&&i["width"]){}else{i["width"]=20;i["height"]=20}}i["width"]=i["width"]>100?100:i["width"];i["height"]=i["height"]>100?100:i["height"];if(this.BXIM.settings.enableBigSmile&&r==0&&i["width"]==i["height"]&&i["width"]==20){i["width"]=40;i["height"]=40}var l=e.match(/title\=(.*[^\s\]])/i);if(l&&l[1]){l=l[1];if(l.indexOf("width=")>-1){l=l.substr(0,l.indexOf("width="))}if(l.indexOf("height=")>-1){l=l.substr(0,l.indexOf("height="))}if(l.indexOf("size=")>-1){l=l.substr(0,l.indexOf("size="))}if(l){l=s.util.trim(l);i["title"]=l;i["alt"]=l}}else{i["title"]=s.message("IM_M_ICON");i["alt"]=i["title"]}return s.create("img",{attrs:i,props:{className:"bx-smile bx-icon"}}).outerHTML},this));e=e.replace(/\[RATING\=([1-5]{1})\]/gi,s.delegate(function(e,s){return this.linesVoteHeadNodes(0,s,false).outerHTML},this));return e};s.MessengerCommon.prototype.prepareTextBack=function(e,t){var r=e;t=t===true;r=s.util.htmlspecialcharsback(r);r=r.replace(/<(\/*)([buis]+)>/gi,"[$1$2]");r=r.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");r=r.replace(/<a.*?href="([^"]*)".*?>.*?<\/a>/gi,"$1");if(!t){r=r.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim,"["+s.message("IM_M_QUOTE_BLOCK")+"]")}r=r.split("&nbsp;&nbsp;&nbsp;&nbsp;").join("	");r=r.split("&nbsp;").join(" ");r=r.split("<br />").join("\n");return r};s.MessengerCommon.prototype.addMentionList=function(e,s,t){if(!e||!s)return false;if(!this.BXIM.messenger.mentionList[e])this.BXIM.messenger.mentionList[e]={};this.BXIM.messenger.mentionList[e][s]=t};s.MessengerCommon.prototype.prepareMention=function(e,s){if(!this.BXIM.messenger.mentionList[e])return s;for(var t in this.BXIM.messenger.mentionList[e]){var r=this.BXIM.messenger.mentionList[e][t];if(r.toString().substr(0,4)=="chat"){s=s.split(t).join("[CHAT="+r.toString().substr(4)+"]"+t+"[/CHAT]")}else{s=s.split(t).join("[USER="+r+"]"+t+"[/USER]")}}this.clearMentionList(e);return s};s.MessengerCommon.prototype.clearMentionList=function(e){delete this.BXIM.messenger.mentionList[e]};s.MessengerCommon.prototype.getRecipientByChatId=function(e){var s=0;if(this.BXIM.messenger.chat[e]){s="chat"+e}else{for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}}return s};s.MessengerCommon.prototype.getUserIdByChatId=function(e){var s=0;for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}return s};s.MessengerCommon.prototype.getUserParam=function(e,t){e=typeof e=="undefined"?this.BXIM.userId:e;t=typeof t=="boolean"?t:false;if(e.toString().substr(0,4)=="chat"||e.toString().substr(0,2)=="sg"){var r=e.toString().substr(0,4)=="chat"?e.toString().substr(4):e;if(t||!(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].id)){this.BXIM.messenger.chat[r]={id:r,name:s.message("IM_M_LOAD_USER"),owner:0,workPosition:"",avatar:this.BXIM.pathToBlankImage,type:"chat",color:"#556574",fake:true};if(t){this.BXIM.messenger.chat[r].fake=false}}return this.BXIM.messenger.chat[r]}else{if(t||!(this.BXIM.messenger.users[e]&&this.BXIM.messenger.users[e].id)){var i=parseInt(e)?this.BXIM.path.profileTemplate.replace("#user_id#",e):"";this.BXIM.messenger.users[e]={id:e,avatar:this.BXIM.pathToBlankImage,name:s.message("IM_M_LOAD_USER"),profile:i,status:"guest",workPosition:"",extranet:false,network:false,color:"#556574",fake:true};this.BXIM.messenger.hrphoto[e]="/bitrix/js/im/images/hidef-avatar-v3.png";if(t){this.BXIM.messenger.users[e].fake=false}}return this.BXIM.messenger.users[e]}};s.MessengerCommon.prototype.userInChat=function(e,s){if(!this.BXIM.messenger.userInChat[e])return false;if(typeof s=="undefined"){s=this.BXIM.userId}else{s=parseInt(s)}var t=false;if(typeof this.BXIM.messenger.userInChat[e].indexOf!="undefined"){if(this.BXIM.messenger.userInChat[e].indexOf(s.toString())!=-1||this.BXIM.messenger.userInChat[e].indexOf(parseInt(s))!=-1){t=true}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(parseInt(this.BXIM.messenger.userInChat[e][r])==parseInt(s)){t=true;break}}}return t};s.MessengerCommon.prototype.getUserStatus=function(e,t){if(!e||e.toString().substr(0,7)!="network"){e=parseInt(e);e=isNaN(e)?this.BXIM.userId:e}t=t===true;var r="";var i="";if(typeof this.BXIM.messenger.users[e]=="undefined"){r="guest";i=s.message("IM_STATUS_GUEST")}else if(this.BXIM.messenger.users[e].bot&&this.BXIM.messenger.bot[e]&&this.BXIM.messenger.bot[e].type=="network"){r="network";i=s.message("IM_STATUS_NETWORK")}else if(this.BXIM.messenger.users[e].bot){r="bot";i=s.message("IM_STATUS_BOT")}else if(this.BXIM.messenger.users[e].connector){r=this.BXIM.messenger.users[e].status=="offline"?"lines":"lines-online";i=s.message("IM_CL_USER_LINES")}else if(this.BXIM.messenger.users[e].network){r="network-user";i=s.message("IM_STATUS_NETWORK")}else if(this.BXIM.messenger.users[e].status=="offline"){r="offline";i=s.message("IM_STATUS_OFFLINE")}else if(this.BXIM.messenger.users[e].status=="guest"){r="guest";i=s.message("IM_STATUS_GUEST")}else if(this.BXIM.userId==e){r=this.BXIM.messenger.users[e].status?this.BXIM.messenger.users[e].status.toString():"";i=r?s.message("IM_STATUS_"+r.toUpperCase()):""}else if(this.getUserMobileStatus(e)){r="mobile";i=s.message("IM_STATUS_MOBILE")}else if(this.BXIM.messenger.users[e].idle>0){r="idle";i=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(this.BXIM.messenger.users[e].birthday&&(this.BXIM.messenger.users[e].status=="online"||this.BXIM.messenger.users[e].status=="offline")){r="birthday";if(this.BXIM.messenger.users[e].status=="offline"){i=s.message("IM_STATUS_OFFLINE")}else{i=s.message("IM_M_BIRTHDAY_MESSAGE_SHORT")}}else{r=this.BXIM.messenger.users[e].status?this.BXIM.messenger.users[e].status.toString():"";i=s.message("IM_STATUS_"+r.toUpperCase())}return t?i:r};s.MessengerCommon.prototype.getUserIdle=function(e){e=parseInt(e);e=isNaN(e)?this.BXIM.userId:e;var s="";if(this.BXIM.messenger.users[e].idle>0){var t=parseInt(this.BXIM.messenger.users[e].idle);s=this.formatDate(this.BXIM.messenger.users[e].idle,this.getNowDate()-t>=3600?"Hdiff":"idiff")}return s};s.MessengerCommon.prototype.getUserMobileStatus=function(e){e=parseInt(e);e=isNaN(e)?this.BXIM.userId:e;var t=false;if(this.BXIM.messenger.users[e].mobileLastDate>0){var r=parseInt(this.BXIM.messenger.users[e].mobileLastDate);if(this.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET"))-(parseInt(r)+parseInt(s.message("SERVER_TZ_OFFSET")))<240){t=true}}return t};s.MessengerCommon.prototype.getUserPosition=function(e){var t="";if(!this.BXIM.messenger.users[e])return"";if(this.BXIM.messenger.users[e].workPosition){t=this.BXIM.messenger.users[e].workPosition}else if(this.BXIM.messenger.users[e].extranet){t=s.message("IM_CL_USER_EXTRANET")}else if(this.BXIM.messenger.users[e].bot){t=s.message("IM_CL_BOT")}else if(this.BXIM.bitrixIntranet){t=s.message("IM_CL_USER_B24")}else{t=s.message("IM_CL_USER")}return t};s.MessengerCommon.prototype.setColor=function(e,t){if(!this.BXIM.init&&this.isDesktop()){s.desktop.onCustomEvent("bxSaveColor",[{color:e,chatId:t}]);return false}if(typeof e!="string"){return false}else{e=e.toUpperCase()}if(typeof t!="undefined"){if(typeof this.BXIM.messenger.chat[t]=="undefined"){return false}}else{t=0;if(this.BXIM.userColor==e){return false}}s.ajax({url:this.BXIM.pathToAjax+"?SET_COLOR&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SET_COLOR:"Y",COLOR:e,CHAT_ID:t,sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(parseInt(e.CHAT_ID)==0){this.BXIM.userColor=e.COLOR;if(this.isPage()){setTimeout(function(){s.MessengerWindow.setUserInfo(s.MessengerCommon.getUserParam())},500)}}}},this)})};s.MessengerCommon.prototype.checkRestriction=function(e,s){if(!this.BXIM.messenger.chat[e])return null;if(!this.BXIM.messenger.chat[e].entity_type)return false;var t=this.BXIM.messenger.chat[e].entity_type;if(typeof this.BXIM.messenger.userChatOptions[t]=="undefined"||typeof this.BXIM.messenger.userChatOptions[t][s]=="undefined")return false;if(!this.BXIM.messenger.userChatOptions[t][s])return true;return false};s.MessengerCommon.prototype.getEntityTypePath=function(e){if(!this.BXIM.messenger.chat[e])return null;if(!this.BXIM.messenger.chat[e].entity_type)return null;var s=this.BXIM.messenger.chat[e].entity_type;if(typeof this.BXIM.messenger.userChatOptions[s]=="undefined")return null;if(!this.BXIM.messenger.userChatOptions[s]["PATH"])return null;return{PATH:this.BXIM.messenger.userChatOptions[s]["PATH"].replace("#ID#",this.BXIM.messenger.chat[e].entity_id),TITLE:this.BXIM.messenger.userChatOptions[s]["PATH_TITLE"]}};s.MessengerCommon.prototype.renameChat=function(e,t){e=parseInt(e);if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"||!t||e<=0)return false;t=s.util.trim(t);if(t.length<=0||this.BXIM.messenger.chat[e].name==s.util.htmlspecialchars(t))return false;var r=this.BXIM.messenger.chat[e].name;this.BXIM.messenger.chat[e].name=s.util.htmlspecialchars(t);s.ajax({url:this.BXIM.pathToAjax+"?CHAT_RENAME&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_RENAME:"Y",CHAT_ID:e,CHAT_TITLE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR){if(this.BXIM.messenger.popupMessengerPanelChatTitle){this.BXIM.messenger.popupMessengerPanelChatTitle.innerHTML=r}this.BXIM.messenger.chat[e].name=r}if(!this.BXIM.ppServerStatus){s.PULL.updateState(true)}},this)});return true};s.MessengerCommon.prototype.userListRedraw=function(e){if(this.isMobile()){if(!this.MobileActionEqual("RECENT")){return false}}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0){this.recentListRedraw(e)}else if(this.BXIM.messenger.chatList){this.chatListRedraw(e)}else{this.contactListRedraw(e);if(this.BXIM.messenger.recentListExternal){this.recentListRedraw(e)}}};s.MessengerCommon.prototype.contactListRedraw=function(e){if(this.BXIM.messenger.popupMessenger==null)return false;e=e||{};if(!this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.contactList=true;this.BXIM.messenger.recentList=false;if(this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}}if(this.BXIM.messenger.contactListSearchText.length>0){this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,e.FORCE?{}:{params:false,timeout:this.isMobile()?500:100})}else{if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.contactListPrepare());if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}e.SEND=e.SEND==true;if(!this.isMobile()&&e.SEND){s.localStorage.set("mrd",{viewGroup:this.BXIM.settings.viewGroup,viewOffline:this.BXIM.settings.viewOffline},5)}};s.MessengerCommon.prototype.contactListPrepareSearch=function(e,t,r,i){if(!t)return false;if(this.BXIM.messenger.openLinesFlag&&(e=="popupChatDialogContactListElements"&&this.BXIM.messenger.popupChatDialogDestType=="CHAT_EXTEND"||e=="popupTransferDialogContactListElements")){i.viewOffline=true;i.viewOnlyIntranet=true;i.viewOnlyBusiness=true;i.viewChat=false;i.viewOfflineWithPhones=false}var n={listName:e,groupOpen:true,viewSelf:e=="contactList",viewOffline:true,viewOnlyBusiness:false,viewGroup:true,viewChat:true,viewBot:true,viewTransferViQueue:false,viewTransferOlQueue:false,viewOpenChat:true,viewOfflineWithPhones:false,extra:false,searchText:r,callback:{empty:function(){}}};if(i!=false){for(var a in i){if(a=="timeout"||a=="params")continue;n[a]=i[a]}}var o=i.timeout?i.timeout:0;if(o>0){clearTimeout(this.BXIM.messenger.redrawContactListTimeout[e]);this.BXIM.messenger.redrawContactListTimeout[e]=setTimeout(s.delegate(function(){t.innerHTML="";t.appendChild(this.contactListPrepare(n));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}},this),o)}else{t.innerHTML="";t.appendChild(this.contactListPrepare(n));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}};s.MessengerCommon.prototype.contactListPrepare=function(e){e=typeof e=="object"?e:{};return this.chatListPrepare(e)};s.MessengerCommon.prototype.contactListClickItem=function(e){this.BXIM.messenger.closeMenuPopup();var t=s.proxy_context.getAttribute("data-userId");if(t.toString().substr(0,9)=="structure"){var r=t.toString().substr(9);var i=this.BXIM.messenger.groups[r].name.split(" / ")[0];this.BXIM.messenger.popupContactListSearchInput.value=i;this.BXIM.messenger.contactListSearchText=t;this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,{});return s.PreventDefault(e)}if(this.BXIM.messenger.contactList){s.MessengerCommon.recentListElementToTop(s.proxy_context.getAttribute("data-userId"))}if(this.isMobile()||!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText="";s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.realSearch=false;this.userListRedraw()}if(this.isMobile()){this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"),s.proxy_context)}else{this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"))}return s.PreventDefault(e)};s.MessengerCommon.prototype.contactListToggleGroup=function(){var e="";var t=s.findNextSibling(s.proxy_context,{className:"bx-messenger-cl-group-wrapper"});if(t.childNodes.length>0){var r=s.findChildrenByClassName(t,"bx-messenger-cl-avatar-img");if(s.hasClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")){e="close";s.removeClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open");if(!this.isMobile()&&r){for(var i=0;i<r.length;i++){r[i].setAttribute("_src",r[i].src);r[i].src=this.BXIM.pathToBlankImage}}}else{e="open";s.addClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open");if(!this.isMobile()&&r){for(var i=0;i<r.length;i++){r[i].src=r[i].getAttribute("_src");r[i].setAttribute("_src",this.BXIM.pathToBlankImage)}}}}else{if(s.hasClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")){e="close";s.removeClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")}else{e="open";s.addClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")}}var n=s.proxy_context.getAttribute("data-groupId");var a=this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length>0?false:this.BXIM.settings.viewGroup;if(a)this.BXIM.messenger.groups[n].status=e;else if(this.BXIM.messenger.woGroups[n])this.BXIM.messenger.woGroups[n].status=e;s.userOptions.save("IM","groupStatus",n,e);s.localStorage.set("mgp",{id:n,status:e},5)};s.MessengerCommon.prototype.contactListGetFromServer=function(t){if(this.BXIM.messenger.contactListLoad)return false;if(!s.type.isFunction(t))t=s.DoNothing;this.BXIM.messenger.contactListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CONTACT_LIST:"Y",IM_AJAX_CALL:"Y",DESKTOP:this.isDesktop()?"Y":"N",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR==""){for(var i in r.USERS)this.BXIM.messenger.users[i]=r.USERS[i];for(var i in r.GROUPS)this.BXIM.messenger.groups[i]=r.GROUPS[i];for(var i in r.CHATS){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)r.CHATS[i].fake=true;else if(!this.BXIM.messenger.chat[i])r.CHATS[i].fake=true;this.BXIM.messenger.chat[i]=r.CHATS[i]}for(var i in r.PHONES){this.BXIM.messenger.phones[i]={};for(var n in r.PHONES[i]){this.BXIM.messenger.phones[i][n]=s.util.htmlspecialcharsback(r.PHONES[i][n])}}for(var i in r.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=r.USER_IN_GROUP[i]}else{for(var n=0;n<r.USER_IN_GROUP[i].users.length;n++)this.BXIM.messenger.userInGroup[i].users.push(r.USER_IN_GROUP[i].users[n]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}for(var i in r.WO_GROUPS)this.BXIM.messenger.woGroups[i]=r.WO_GROUPS[i];for(var i in r.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[i]=="undefined"){this.BXIM.messenger.woUserInGroup[i]=r.WO_USER_IN_GROUP[i];

}else{for(var n=0;n<r.WO_USER_IN_GROUP[i].users.length;n++)this.BXIM.messenger.woUserInGroup[i].users.push(r.WO_USER_IN_GROUP[i].users[n]);this.BXIM.messenger.woUserInGroup[i].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[i].users)}}this.userListRedraw();if(!this.isMobile()){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.popupChatDialogContactListElements!=null){this.contactListPrepareSearch("popupChatDialogContactListElements",this.BXIM.messenger.popupChatDialogContactListElements,this.BXIM.messenger.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.BXIM.messenger.popupChatDialogContactListElementsType=="MENTION"})}if(this.BXIM.webrtc.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.webrtc.popupTransferDialogContactListElements,this.BXIM.webrtc.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true})}if(this.BXIM.messenger.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.messenger.popupTransferDialogContactListElements,this.BXIM.messenger.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewTransferOlQueue:true,viewOnlyIntranet:true,viewOfflineWithPhones:false})}}t()}else{this.BXIM.messenger.contactListLoad=false;if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.contactListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()){setTimeout(s.delegate(this.contactListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.contactListLoad=false},this)})};s.MessengerCommon.prototype.contactListRealSearch=function(e,t){if(!this.BXIM.messenger.realSearch)return false;this.contactListRealSearchText=e;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);this.BXIM.messenger.contactListSearchTimeout=setTimeout(s.delegate(function(){if(this.contactListRealSearchText.length<3){this.BXIM.messenger.realSearchFound=true;return false}s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CONTACT_LIST_SEARCH:"Y",SEARCH:this.contactListRealSearchText,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};this.BXIM.messenger.woUserInGroup["search"]={id:"search",users:[]};for(var s in e.USERS){if(!this.BXIM.messenger.woUserInGroup["all"]){this.BXIM.messenger.woUserInGroup["all"]={users:[]}}if(this.BXIM.messenger.woUserInGroup["all"].users.indexOf(s)>=0){continue}this.BXIM.messenger.users[s]=e.USERS[s];this.BXIM.messenger.userInGroup["search"]["users"].push(s);this.BXIM.messenger.woUserInGroup["search"]["users"].push(s);if(e.USERS[s].bot&&e.USERS[s].network){this.BXIM.messenger.bot[s]={type:"network"};this.BXIM.messenger.users[s].extranet=false}}if(typeof t!="undefined"){t()}else if(this.BXIM.messenger.contactList){this.contactListRedraw({FORCE:true})}},this),onfailure:s.delegate(function(){this.BXIM.messenger.realSearchFound=true},this)})},this),1500)};s.MessengerCommon.prototype.contactListSearchClear=function(e){if(!this.BXIM.messenger.popupContactListSearchInput)return;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.realSearch=false;this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};this.BXIM.messenger.woUserInGroup["search"]={id:"search",users:[]};this.userListRedraw()};s.MessengerCommon.prototype.contactListSearch=function(e){if(e.keyCode==16||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==91)return false;if(e.keyCode==37||e.keyCode==39)return true;if(this.BXIM.messenger.popupContactListSearchInput.value!=this.BXIM.messenger.contactListSearchLastText||this.BXIM.messenger.popupContactListSearchInput.value==""){}else if(e.keyCode==224||e.keyCode==18||e.keyCode==17){return true}if(e.keyCode==38||e.keyCode==40){return true}if(this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(!app.enableInVersion(10)){setTimeout(function(){document.body.scrollTop=0},100)}}else{if(e.keyCode==27){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}if(this.BXIM.messenger.contactListSearchText<=0&&!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";if(!this.isMobile()&&this.BXIM.messenger.popupMessenger&&!this.BXIM.messenger.desktop.ready()&&!this.BXIM.messenger.webrtc.callInit){this.BXIM.messenger.popupMessenger.destroy();return true}}else{this.contactListSearchClear();this.BXIM.messenger.popupMessengerTextarea.focus();return true}}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(e.keyCode==13){var t=true;var r=s.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-item");if(r){this.recentListElementToTop(r.getAttribute("data-userId"));this.BXIM.messenger.openMessenger(r.getAttribute("data-userid"))}else{var r=s.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-chatlist-search-button");if(r){t=false;this.BXIM.messenger.chatListSearchAction(r);return true}}if(t){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}this.BXIM.messenger.popupContactListSearchInput.value=""}}}if(this.BXIM.messenger.popupContactListSearchInput.value==this.BXIM.messenger.contactListSearchLastText){return true}this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);this.BXIM.messenger.contactListSearchLastText=this.BXIM.messenger.contactListSearchText;if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=this.BXIM.messenger.contactListSearchText.length<3}if(!this.isMobile()){s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5)}if(this.BXIM.messenger.contactListSearchText==""){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.realSearch=false}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}else{s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.contactListRealSearch(this.BXIM.messenger.contactListSearchText)}this.userListRedraw()};s.MessengerCommon.prototype.recentListRedraw=function(e){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.MobileActionNotEqual("RECENT"))return false;if(this.BXIM.messenger.recentList&&this.BXIM.messenger.popupMessenger){if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false;this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false}if(this.BXIM.messenger.popupContactListActive){s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}if(this.BXIM.messenger.contactListSearchText==null||this.BXIM.messenger.contactListSearchText.length>0){this.BXIM.messenger.contactListSearchText="";this.BXIM.messenger.popupContactListSearchInput.value=""}if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";if(this.isPage()&&s.MessengerWindow.currentTab=="im-ol"){s.addClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.recentLinesListPrepare(e))}else{s.removeClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.recentListPrepare(e))}if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML=this.BXIM.messenger.popupContactListElementsWrap.innerHTML}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}else if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML="";this.BXIM.messenger.recentListExternal.appendChild(this.recentListPrepare(e))}};s.MessengerCommon.prototype.recentListPrepare=function(e){var t=document.createDocumentFragment();var r={};e=typeof e=="object"?e:{};var i=e.showOnlyChat;if(!this.BXIM.messenger.recentListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.recentListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}this.BXIM.messenger.recent.sort(function(e,s){var t=parseInt(e.date);var r=parseInt(s.date);if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}});this.BXIM.messenger.recentListIndex=[];var n=this.isMobile()?49:99;var a={};for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(typeof this.BXIM.messenger.recent[o].userIsChat=="undefined"){this.BXIM.messenger.recent[o].userIsChat=this.BXIM.messenger.recent[o].recipientId.toString().substr(0,4)=="chat"}var l=s.clone(this.BXIM.messenger.recent[o]);if(o>n){if(!this.BXIM.messenger.unreadMessage[l.userId]||this.BXIM.messenger.unreadMessage[l.userId]&&this.BXIM.messenger.unreadMessage[l.userId].length==0){continue}}var m="";if(l.userIsChat){var h=this.BXIM.messenger.chat[l.userId.toString().substr(4)];if(typeof h=="undefined"||typeof h.name=="undefined"||this.isPage()&&h.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable&&this.isLinesOperator())continue;var g="chat"+h.id}else if(!i){var h=this.BXIM.messenger.users[l.userId];if(typeof h=="undefined"||typeof h.name=="undefined")continue;if(typeof h.active!="undefined"&&!h.active&&!this.BXIM.messenger.unreadMessage[h.id])continue;var g=h.id}else{continue}a[g]=true;if(parseInt(l.date)>0){l.date=this.formatDate(l.date,this.getDateFormatType("RECENT_TITLE"));if(!r[l.date]){r[l.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:l.date})]}))}}else{if(!r["never"]){r["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}t.appendChild(this.drawContactListElement({id:g,data:h,text:l.text,textSenderId:l.senderId,textParams:l.params}));this.BXIM.messenger.recentListIndex.push(g)}var I={};for(var g in this.BXIM.messenger.unreadMessage){if(a[g])continue;I[g]=true}for(var g in I){if(!r["30days"]){r["30days"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_M_RECENT_MORE")})]}))}if(g.toString().substr(0,4)=="chat"){var h=this.BXIM.messenger.chat[g.toString().substr(4)]}else{var h=this.BXIM.messenger.users[g]}if(typeof h=="undefined"||typeof h.name=="undefined"){continue}var l={text:"",textSenderId:0,textParams:{}};var p=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[g]);if(this.BXIM.messenger.message[p]){l.text=this.BXIM.messenger.message[p].text;l.textSenderId=this.BXIM.messenger.message[p].senderId;l.textParams=this.BXIM.messenger.message[p].params}t.appendChild(this.drawContactListElement({id:g,data:h,text:l.text,textSenderId:l.senderId,textParams:l.params,showLastMessage:l.text!=""}));this.BXIM.messenger.recentListIndex.push(h.id)}if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}))}return t};s.MessengerCommon.prototype.recentLinesListPrepare=function(e){var t=document.createDocumentFragment();e=typeof e=="object"?e:{};if(!this.BXIM.messenger.recentListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.recentListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var r=this.isMobile()?49:99;var i=[];for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(typeof this.BXIM.messenger.recent[n].userIsChat=="undefined"){this.BXIM.messenger.recent[n].userIsChat=this.BXIM.messenger.recent[n].recipientId.toString().substr(0,4)=="chat"}var a=this.BXIM.messenger.recent[n];if(n>r){if(!this.BXIM.messenger.unreadMessage[a.userId]||this.BXIM.messenger.unreadMessage[a.userId]&&this.BXIM.messenger.unreadMessage[a.userId].length==0){continue}}var o="";if(typeof a.userIsChat=="undefined"){a.userIsChat=a.recipientId.toString().substr(0,4)=="chat"}if(a.userIsChat){var l=this.BXIM.messenger.chat[a.userId.toString().substr(4)];if(typeof l=="undefined"||typeof l.name=="undefined"||l.entity_type!="LINES")continue;a.chatId=l.id;var m="chat"+l.id}else{continue}i.push(a)}if(this.BXIM.settings.linesTabOrder=="group"||this.BXIM.settings.linesTabOrder=="support"){i.sort(s.delegate(function(e,s){if(!this.BXIM.messenger.chat[e.chatId])return-1;if(!this.BXIM.messenger.chat[s.chatId])return 1;var t=this.BXIM.messenger.chat[e.chatId].entity_data_1.toString().split("|");t=typeof t[5]!="undefined"?parseInt(t[5]):Math.round(new Date/1e3)+e.chatId;var r=this.BXIM.messenger.chat[s.chatId].entity_data_1.toString().split("|");r=typeof r[5]!="undefined"?parseInt(r[5]):Math.round(new Date/1e3)+s.chatId;if(t<r){return-1}else if(t>r){return 1}else{return 0}},this))}else{this.BXIM.messenger.recent.sort(function(e,s){var t=parseInt(e.date);var r=parseInt(s.date);if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}})}var h={};for(var n=0;n<i.length;n++){if(n>r){if(!this.BXIM.messenger.unreadMessage[a.userId]||this.BXIM.messenger.unreadMessage[a.userId]&&this.BXIM.messenger.unreadMessage[a.userId].length==0){continue}}var a=s.clone(i[n]);var o="";if(a.userIsChat){var l=this.BXIM.messenger.chat[a.userId.toString().substr(4)];if(typeof l=="undefined"||typeof l.name=="undefined"||l.entity_type!="LINES")continue;if(this.BXIM.settings.linesTabOrder=="group"&&a.senderId!=0&&this.BXIM.messenger.users[a.senderId]&&!this.BXIM.messenger.users[a.senderId].connector&&!this.BXIM.messenger.users[a.senderId].bot&&!(a.params&&a.params.CLASS=="bx-messenger-content-item-system")){continue}var m="chat"+l.id}else{continue}if(!h["groupUnanswered"]&&this.BXIM.settings.linesTabOrder=="group"){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-red"},html:s.message("IM_OL_LIST_UNANSWERED")})]}));h["groupUnanswered"]=true}if(parseInt(a.date)>0){a.date=this.formatDate(a.date,this.getDateFormatType("RECENT_OL_TITLE"));if(!h[a.date]){h[a.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:a.date})]}))}}else{if(!h["never"]){h["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}t.appendChild(this.drawContactListElement({id:m,data:l,text:a.text,textSenderId:a.senderId,textParams:a.params}))}if(this.BXIM.settings.linesTabOrder=="group"){i.sort(function(e,s){var t=parseInt(e.date);var r=parseInt(s.date);if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}});var h={};for(var n=0;n<i.length;n++){if(n>r){if(!this.BXIM.messenger.unreadMessage[a.userId]||this.BXIM.messenger.unreadMessage[a.userId]&&this.BXIM.messenger.unreadMessage[a.userId].length==0){continue}}var a=s.clone(i[n]);var o="";if(a.userIsChat){var l=this.BXIM.messenger.chat[a.userId.toString().substr(4)];if(typeof l=="undefined"||typeof l.name=="undefined"||l.entity_type!="LINES")continue;if(a.senderId==0||!this.BXIM.messenger.users[a.senderId]||this.BXIM.messenger.users[a.senderId]&&(this.BXIM.messenger.users[a.senderId].connector||this.BXIM.messenger.users[a.senderId].bot)||a.params&&a.params.CLASS=="bx-messenger-content-item-system"){continue}var m="chat"+l.id}else{continue}if(!h["groupAnswered"]){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-green"},html:s.message("IM_OL_LIST_ANSWERED")})]}));h["groupAnswered"]=true}if(parseInt(a.date)>0){a.date=this.formatDate(a.date,this.getDateFormatType("RECENT_OL_TITLE"));if(!h[a.date]){h[a.date]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:a.date})]}))}}else{if(!h["never"]){h["never"]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}t.appendChild(this.drawContactListElement({id:m,data:l,text:a.text,textSenderId:a.senderId,textParams:a.params}))}}if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_OL_EMPTY")}))}return t};s.MessengerCommon.prototype.recentListAdd=function(e){if(!e.skipDateCheck){for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e.userId&&parseInt(this.BXIM.messenger.recent[t].date)>parseInt(e.date))return false}}var r=[];r.push(e);for(var t=0;t<this.BXIM.messenger.recent.length;t++)if(this.BXIM.messenger.recent[t].userId!=e.userId)r.push(this.BXIM.messenger.recent[t]);this.BXIM.messenger.recent=r;if(!e.skipRedraw&&this.BXIM.messenger.recentList){if(this.isMobile()){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);this.BXIM.messenger.redrawRecentListTimeout=setTimeout(s.delegate(function(){this.recentListRedraw()},this),300)}else{this.recentListRedraw()}}};s.MessengerCommon.prototype.recentListHide=function(e,t){if(!e)return false;var r=[];var i=false;for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(!i&&this.BXIM.messenger.recent[n].userId==e){i=true;continue}r.push(this.BXIM.messenger.recent[n])}this.BXIM.messenger.recent=r;if(this.BXIM.messenger.recentList)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5);t=t!=false;if(t){s.ajax({url:this.BXIM.pathToAjax+"?RECENT_HIDE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_RECENT_HIDE:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}this.readMessage(e,t,t);if(e.toString().substr(0,4)=="chat"){if(this.isMobile()){app.onCustomEvent("onPullClearWatch",{id:"IM_PUBLIC_"+e.substr(4)})}else{s.PULL.clearWatch("IM_PUBLIC_"+e.substr(4))}}delete this.BXIM.messenger.showMessage[e];delete this.BXIM.messenger.history[e];if(this.BXIM.messenger.currentTab==e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.extraOpen(s.create("div",{attrs:{style:"padding-top: 300px"},props:{className:"bx-messenger-box-empty"},html:s.message("IM_M_EMPTY")}))}};s.MessengerCommon.prototype.recentListElementUpdate=function(e,s,t){if(e.toString().substr(0,4)=="chat"){for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userIsChat&&this.BXIM.messenger.recent[r].recipientId==e){if(this.BXIM.messenger.recent[r].id==s){this.BXIM.messenger.recent[r].text=t}break}}}else{for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(!this.BXIM.messenger.recent[r].userIsChat&&this.BXIM.messenger.recent[r].userId==e){if(this.BXIM.messenger.recent[r].id==s){this.BXIM.messenger.recent[r].text=t}break}}}};s.MessengerCommon.prototype.recentListElementToTop=function(e){var t=false;for(var r=0;r<this.BXIM.messenger.recent.length;r++){if(this.BXIM.messenger.recent[r].userId==e){t=true;this.BXIM.messenger.recent[r].date=s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET"));break}}if(!t){var i="";var n=this.getLastMessageInDialog(e);if(n){if(n.text){i=n.text}else if(n.params&&n.params.FILE_ID&&n.params.FILE_ID.length>1){i="["+s.message("IM_F_FILE")+"]"}else if(n.params&&n.params.ATTACH&&n.params.ATTACH.length>1){item.text="["+s.message("IM_F_ATTACH")+"]"}}if(!i){var a=this.getUserParam(e);if(a.type=="chat"){i=s.message("IM_CL_CHAT_2")}else if(a.type=="open"){i=s.message("IM_CL_OPEN_CHAT")}else if(a.type=="call"){i=s.message("IM_CL_PHONE")}else if(a.type=="lines"){i=s.message("IM_CL_LINES")}else{i=s.util.htmlspecialcharsback(this.getUserPosition(e))}}this.BXIM.messenger.recent.push({id:"tempSort"+ +new Date,date:s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),skipDateCheck:true,recipientId:e,senderId:e,text:s.MessengerCommon.prepareText(i,true),userId:e,params:{}})}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5)};s.MessengerCommon.prototype.recentListGetSortIndex=function(){var e={};var s=0;if(this.BXIM.messenger.recent.length<=0){this.recentListGetFromServer()}for(var t=0;t<this.BXIM.messenger.recent.length;t++){s=this.BXIM.messenger.recent.length-t;e[this.BXIM.messenger.recent[t].userId]=s}return e};s.MessengerCommon.prototype.recentListGetFromServer=function(){if(this.BXIM.messenger.recentListLoad)return false;this.BXIM.messenger.recentListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?RECENT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_RECENT_LIST:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.recent=[];for(var r in t.RECENT){t.RECENT[r].date=parseInt(t.RECENT[r].date)-parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.recent.push(t.RECENT[r])}var i=false;for(var r in this.BXIM.messenger.unreadMessage){for(var n=0;n<this.BXIM.messenger.unreadMessage[r].length;n++){if(!i||i.SEND_DATE<=this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].date){i={ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].id,SEND_DATE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].date,RECIPIENT_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].recipientId,SENDER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].senderId,USER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].text,PARAMS:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].params}}}}if(i){this.recentListAdd({userId:i.RECIPIENT_ID.toString().substr(0,4)=="chat"?i.RECIPIENT_ID:i.USER_ID,id:i.ID,date:i.SEND_DATE,recipientId:i.RECIPIENT_ID,senderId:i.SENDER_ID,text:i.SEND_MESSAGE,userIsChat:i.RECIPIENT_ID.toString().substr(0,4)=="chat",params:i.PARAMS},true)}for(var r in t.CHAT){if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].fake)t.CHAT[r].fake=true;else if(!this.BXIM.messenger.chat[r])t.CHAT[r].fake=true;this.BXIM.messenger.chat[r]=t.CHAT[r]}for(var r in t.USERS)this.BXIM.messenger.users[r]=t.USERS[r];if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();this.BXIM.messenger.smile=t.SMILE;this.BXIM.messenger.smileSet=t.SMILE_SET;this.BXIM.settingsNotifyBlocked=t.NOTIFY_BLOCKED;if(!this.isMobile())this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.recent.length==0){this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.chatListPrepare())}}else{this.BXIM.messenger.recentListLoad=false;if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.recentListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()){setTimeout(s.delegate(this.recentListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[t.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.recentListLoad=false},this)})};s.MessengerCommon.prototype.drawContactListElement=function(e){if(!e||!e.id)return null;e.userIsChat=e.id.toString().substr(0,4)=="chat";e.userIsQueue=e.id.toString().substr(0,5)=="queue";e.userIsStructure=e.id.toString().substr(0,9)=="structure";e.extraClass=e.extraClass||"";e.showLastMessage=e.showLastMessage===false?false:true;e.showCounter=e.showCounter===false?false:true;var t="";var r="";var i="";var n="";if(e.showCounter){if(this.BXIM.messenger.unreadMessage[e.id]&&this.BXIM.messenger.unreadMessage[e.id].length>0){r="bx-messenger-cl-status-new-message";i='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[e.id].length<100?this.BXIM.messenger.unreadMessage[e.id].length:"99+")+"</span>"}if(this.countWriting(e.id))n="bx-messenger-cl-status-writing"}if(e.userIsQueue){e.data.id=e.data.ID;e.data.name=e.data.NAME;e.data.avatar="";e.data.color=this.BXIM.messenger.users[this.BXIM.userId].color}else if(e.userIsStructure){e.data.avatar="";e.data.color=this.BXIM.messenger.users[this.BXIM.userId].color}if(!e.data.avatar)e.data.avatar=this.BXIM.pathToBlankImage;var a="";var o=e.data.avatar;var l="";if(this.isMobile()){if(this.BXIM.messenger.currentTab==e.id){l="bx-messenger-cl-item-active "}var m="mobile-rc-avatar-id-"+e.data.id;a='id="'+m+'" data-src="'+e.data.avatar+'"';o=this.BXIM.pathToBlankImage;BitrixMobile.LazyLoad.registerImage(m)}var h="";var g=false;if(this.BXIM.settings.viewLastMessage&&e.showLastMessage){if(this.BXIM.messenger.message[e.id]&&this.BXIM.messenger.message[e.id].text){e.text=this.BXIM.messenger.message[e.id].text}if(!e.text&&e.textParams&&e.textParams["FILE_ID"]&&e.textParams["FILE_ID"].length>0){e.text="["+s.message("IM_F_FILE")+"]"}else if(!e.text&&e.textParams&&e.textParams["ATTACH"]&&e.textParams["ATTACH"].length>0){e.text="["+s.message("IM_F_ATTACH")+"]"}var I="";if(e.textSenderId==this.BXIM.userId)I='<span class="bx-messenger-cl-user-reply"></span>';e.text=this.purifyText(e.text);h=I+""+e.text}else{if(e.userIsChat){if(e.data.type=="call"){h=s.message("IM_CL_PHONE")}else if(e.data.type=="lines"){h=s.message("IM_CL_LINES")}else if(e.data.type=="open"){h=s.message("IM_CL_OPEN_CHAT")}else{h=s.message("IM_CL_CHAT_2")}}else if(e.userIsQueue){if(e.data.type=="olQueue"){h=s.message("IM_CL_OL_QUEUE")}else if(e.data.type=="viQueue"){h=s.message("IM_CL_VI_QUEUE")}}else if(e.userIsStructure){h=s.message("IM_CL_STRUCTURE")}else{h=this.getUserPosition(e.id)}}if(e.userIsChat){if(e.data.type=="lines"){var p=this.linesGetSession(e.id.substr(4));g=p.crm=="Y";t+=" bx-messenger-cl-avatar-"+this.linesGetSource(e.id.substr(4))}else{t="bx-messenger-cl-item-chat-"+e.data.type}}else if(e.userIsQueue){if(e.data.type=="olQueue"){t=" bx-messenger-cl-avatar-lines"}else if(e.data.type=="viQueue"){t=" bx-messenger-cl-avatar-call"}}else if(e.userIsStructure){t=" bx-messenger-cl-avatar-structure"}var M=this.isBlankAvatar(e.data.avatar)?'style="background-color: '+e.data.color+'"':"";var c=e.userIsChat&&M?"bx-messenger-cl-avatar-status-hide":"";var d=e.data.name;if(!e.userIsChat&&!e.userIsQueue&&!e.userIsStructure&&this.BXIM.userId==e.data.id){d=d+" (<b><i>"+s.message("IM_YOU")+"</i></b>)"}var u="";var f="bx-messenger-cl-item  bx-messenger-cl-id-"+(e.userIsChat?"chat":"")+(e.userIsQueue?"queue":"")+e.data.id+" "+l;if(e.userIsChat){u="bx-messenger-cl-avatar-"+e.data.type+" "+(this.BXIM.messenger.generalChatId==e.data.id?" bx-messenger-cl-item-chat-general":"");f+="bx-messenger-cl-item-chat "+r+" "+n+" "+t+" "+(this.BXIM.messenger.generalChatId==e.data.id?"bx-messenger-cl-item-chat-general":"")}else if(e.userIsQueue){f+=t}else if(e.userIsStructure){f+=t}else{f+="bx-messenger-cl-status-"+this.getUserStatus(e.data.id)+" "+r+" "+n}f+=" "+e.extraClass;return s.create("span",{props:{className:f},attrs:{"data-userId":e.id,"data-name":s.util.htmlspecialcharsback(e.data.name),"data-status":this.getUserStatus(e.data.id),"data-avatar":e.data.avatar,"data-userIsChat":e.userIsChat,"data-userIsQueue":e.userIsQueue},html:'<span class="bx-messenger-cl-count">'+i+"</span>"+'<span title="'+e.data.name+'" class="bx-messenger-cl-avatar '+u+" "+c+'">'+'<img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(e.data.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" src="'+o+'" '+a+" "+M+">"+(g?'<span class="bx-messenger-cl-crm"></span>':"")+(!e.userIsQueue&&!e.userIsStructure?'<span class="bx-messenger-cl-status"></span>':"")+"</span>"+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(e.data.extranet&&e.data.type!="lines"?" bx-messenger-user-extranet":"")+'" title="'+e.data.name+'">'+d+"</div>"+'<div class="bx-messenger-cl-user-desc">'+h+"</div>"+"</span>"})};s.MessengerCommon.prototype.chatListRedraw=function(e){if(this.MobileActionNotEqual("RECENT")||this.BXIM.messenger.popupMessenger==null)return false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");

this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false}this.BXIM.messenger.chatList=true;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=false;clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}if(this.BXIM.messenger.popupContactListElementsWrap){s.removeClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.chatListPrepare(e))}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}};s.MessengerCommon.prototype.chatListPrepare=function(e){var t=document.createDocumentFragment();var r={};e=typeof e=="object"?e:{};var i=typeof e.listName!="undefined"?e.listName:"contactList";var n=typeof e.searchText!="undefined"?e.searchText:this.BXIM.messenger.contactListSearchText;var a=!(n!=null&&n.length==0);var o=a&&n.substr(0,9)=="structure"?n.substr(9):0;var l=this.BXIM.messenger.realSearch&&!this.BXIM.messenger.realSearchFound;var m=typeof e.viewOnlyIntranet!="undefined"?e.viewOnlyIntranet:false;var h=typeof e.viewOnlyBusiness!="undefined"?e.viewOnlyBusiness:false;var g=typeof e.extra!="undefined"?e.extra:true;var I=typeof e.viewOffline!="undefined"?e.viewOffline:a||!this.BXIM.settings?true:this.BXIM.settings.viewOffline;var p=typeof e.viewOfflineWithPhones!="undefined"?e.viewOfflineWithPhones:false;var M=typeof e.viewChat!="undefined"?e.viewChat:true;var c=typeof e.viewOpenChat!="undefined"?e.viewOpenChat:true;var d=typeof e.viewSelf!="undefined"?e.viewSelf:true;var u=typeof e.viewTransferViQueue!="undefined"?e.viewTransferViQueue:false;var f=typeof e.viewTransferOlQueue!="undefined"?e.viewTransferOlQueue:false;var B=typeof e.viewBot!="undefined"?e.viewBot:true;var X=typeof e.callback!="undefined"?e.callback:{};var E=a&&n.length>=3&&this.BXIM.messenger.realSearchAvailable&&!this.BXIM.messenger.realSearch&&!m;var C=i=="contactList"||i=="popupChatDialogContactListElements"&&(this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_ADD"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_EXTEND"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_CREATE"&&this.BXIM.messenger.chatCreateType!="private");var b=i=="contactList";if(typeof X.empty!="function"){X.empty=function(){}}if(!this.BXIM.messenger.contactListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.contactListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var S=this.BXIM.messenger.popupContactListElementsSize;var _=46;var T=29;var A=26;var v=0;var R=a?5:3;var L=[];if(f){L.push({id:"olQueue",name:s.message("IM_CTL_CHAT_OL_QUEUE"),title:"",more:s.message("IM_CL_MORE_QUEUE")})}else if(u){L.push({id:"viQueue",name:s.message("IM_CTL_CHAT_VI_QUEUE"),title:"",more:s.message("IM_CL_MORE_QUEUE")})}var y=this.BXIM.messenger.users;if(a&&o){L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_PRIVATE")});y={};if(this.BXIM.messenger.userInGroup[o]){for(var x=0;x<this.BXIM.messenger.userInGroup[o].users.length;x++){y[this.BXIM.messenger.userInGroup[o].users[x]]=this.BXIM.messenger.users[this.BXIM.messenger.userInGroup[o].users[x]]}}}else if(a){L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_PRIVATE")});L.push({id:"bot",name:s.message("IM_CTL_CHAT_BOT"),title:"",more:s.message("IM_CL_MORE_BOT")});L.push({id:"open",name:s.message("IM_CTL_CHAT_OPEN"),title:s.message("IM_CL_CREATE_OPEN"),more:s.message("IM_CL_MORE_OPEN"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});L.push({id:"chat",name:s.message("IM_CTL_CHAT_CHAT"),title:s.message("IM_CL_CREATE_CHAT"),more:s.message("IM_CL_MORE_CHAT")});L.push({id:"lines",name:s.message("IM_CTL_CHAT_LINES"),title:"",more:s.message("IM_CL_MORE_LINES")});L.push({id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});L.push({id:"ol",name:s.message("IM_CTL_CHAT_OL"),title:"",more:s.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});L.push({id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_EXTRANET")});L.push({id:"structure",name:this.BXIM.bitrixIntranet?s.message("IM_CTL_CHAT_STRUCTURE"):s.message("IM_CL_GROUP"),title:"",more:this.BXIM.bitrixIntranet?s.message("IM_CL_MORE_STRUCTURE"):s.message("IM_CL_MORE_GROUP"),skip:!C});L.push({id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET")})}else{L.push({id:"open",name:s.message("IM_CTL_CHAT_OPEN"),title:s.message("IM_CL_CREATE_OPEN"),more:s.message("IM_CL_MORE_OPEN"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});L.push({id:"chat",name:s.message("IM_CTL_CHAT_CHAT"),title:s.message("IM_CL_CREATE_CHAT"),more:s.message("IM_CL_MORE_CHAT")});L.push({id:"lines",name:s.message("IM_CTL_CHAT_LINES"),title:"",more:s.message("IM_CL_MORE_LINES")});L.push({id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_PRIVATE")});L.push({id:"bot",name:s.message("IM_CTL_CHAT_BOT"),title:"",more:s.message("IM_CL_MORE_BOT")});L.push({id:"ol",name:s.message("IM_CTL_CHAT_OL"),title:"",more:s.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});L.push({id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE"),more:s.message("IM_CL_MORE_EXTRANET")});L.push({id:"structure",name:this.BXIM.bitrixIntranet?s.message("IM_CTL_CHAT_STRUCTURE"):s.message("IM_CTL_CHAT_GROUP"),title:"",more:this.BXIM.bitrixIntranet?s.message("IM_CL_MORE_STRUCTURE"):s.message("IM_CL_MORE_GROUP"),skip:!C});L.push({id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET")})}for(var x=0;x<L.length;x++){if(L[x].skip)continue;v++}var N=S-T*v;var w=parseInt(N/_);var D=Math.max(parseInt(N/v/_),R);var O=0;var k=0;for(var x=0;x<L.length;x++){L[x].countElement=0;if(L[x].skip)continue;L[x].countElement=D}var U=[];if(a){n=n+"";if(!this.isMobile()&&this.BXIM.language=="ru"&&s.correctText){var P=s.correctText(n);if(P!=n){n=n+" "+P}}U=n.split(" ")}var G=this.recentListGetSortIndex();var H={};var F=[];for(var x=0;x<L.length;x++){H[x]=[];if(L[x].id=="private"||L[x].id=="extranet"||L[x].id=="blocked"||L[x].id=="bot"||L[x].id=="ol"){if(!B&&L[x].id=="bot")L[x].skip=true;if(m&&L[x].id=="extranet")L[x].skip=true;if(!M&&L[x].id=="ol")L[x].skip=true;if(L[x].skip)continue;for(var j in y){if(!y.hasOwnProperty(j))continue;if(!d&&j==this.BXIM.userId)continue;if(typeof this.BXIM.messenger.users[j].active!="undefined"&&!this.BXIM.messenger.users[j].active)continue;if(h&&this.BXIM.messenger.businessUsers&&!this.BXIM.messenger.users[j].bot&&this.BXIM.messenger.businessUsers.indexOf(j.toString())==-1)continue;if(!I){var V=this.getUserStatus(j);if(p&&this.userHasPhone(j)){}else if(V=="offline"){continue}}var W=this.BXIM.messenger.userChat[j];if(L[x].id=="blocked"){if(!this.BXIM.messenger.userChatBlockStatus[W]||!this.BXIM.messenger.userChatBlockStatus[W][this.BXIM.userId]||this.BXIM.messenger.userChatBlockStatus[W][this.BXIM.userId]=="N"){continue}}else{if(this.BXIM.messenger.userChatBlockStatus[W]&&this.BXIM.messenger.userChatBlockStatus[W][this.BXIM.userId]=="Y"){continue}}if(L[x].id=="extranet"){if(!this.BXIM.messenger.users[j].extranet)continue}else{if(this.BXIM.messenger.users[j].extranet)continue}if(L[x].id=="ol"){if(!this.BXIM.messenger.users[j].bot)continue;if(!this.BXIM.messenger.bot[j]||this.BXIM.messenger.bot[j].type!="network")continue}else if(L[x].id=="bot"){if(!this.BXIM.messenger.users[j].bot)continue;if(this.BXIM.messenger.bot[j]&&this.BXIM.messenger.bot[j].type=="network")continue;if(this.BXIM.messenger.bot[j]&&this.BXIM.messenger.bot[j].type=="openline")continue;if(this.BXIM.messenger.bot[j]){if(this.BXIM.messenger.popupChatDialogDestType&&this.BXIM.messenger.popupChatDialogDestType!=""&&this.BXIM.messenger.popupChatDialogDestType!="MENTION"){if(this.BXIM.messenger.openChatFlag){var Y=this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)];if(Y&&Y.entity_type!="LINES"&&this.BXIM.messenger.bot[j].type=="openline"){continue}else if(Y&&Y.entity_type=="LINES"&&!this.BXIM.messenger.bot[j].openline){continue}else if(this.BXIM.messenger.bot[j].type=="network"){continue}}else{if(this.BXIM.messenger.bot[j].type=="network"||this.BXIM.messenger.bot[j].type=="openline"){continue}}}else if(this.BXIM.messenger.popupChatDialogDestType=="CALL_INVITE_USER"){continue}}}else{if(this.BXIM.messenger.users[j].bot)continue}if(a&&o){}else if(a){var K=this.BXIM.messenger.users[j];var q=K.name.toLowerCase()+(K.searchMark?" "+K.searchMark:"");var J=K.workPosition?(" "+K.workPosition).toLowerCase():"";var Z=true;if(!G[j]){G[j]=0}for(var Q=0;Q<U.length;Q++){if(q.indexOf(U[Q].toLowerCase())>=0){G[j]+=100+U[Q].length;Z=false}if(J.indexOf(U[Q].toLowerCase())>=0){G[j]+=50+U[Q].length;Z=false}}if(Z){continue}}if(L[x].id=="bot"){H[x].push(this.BXIM.messenger.users[j])}else if(L[x].id=="ol"){H[x].push(this.BXIM.messenger.users[j])}else{H[x].push(this.BXIM.messenger.users[j])}}if(L[x].id=="bot"){H[x].sort(s.delegate(function(e,s){var t=G[e.id]?G[e.id]:0;var r=G[s.id]?G[s.id]:0;if(this.BXIM.messenger.bot[e.id]&&this.BXIM.messenger.bot[e.id]["code"]=="marta"){t=1e7}if(this.BXIM.messenger.bot[s.id]&&this.BXIM.messenger.bot[s.id]["code"]=="marta"){r=1e7}if(t>r){return-1}else if(t<r){return 1}else{return 0}},this))}else if(a){H[x].sort(function(e,s){var t=G[e.id]?G[e.id]:0;var r=G[s.id]?G[s.id]:0;if(t>r){return-1}else if(t<r){return 1}else{return 0}})}else{H[x].sort(function(e,s){var t=G[e.id]?G[e.id]:0;var r=G[s.id]?G[s.id]:0;if(e.id==this.BXIM.userId){t=1e7}if(s.id==this.BXIM.userId){r=1e7}if(t>r){return-1}else if(t<r){return 1}else{return 0}})}}else if(L[x].id=="chat"||L[x].id=="open"||L[x].id=="call"||L[x].id=="lines"){if(!M&&L[x].id!="open")L[x].skip=true;if(!c&&L[x].id=="open")L[x].skip=true;if(L[x].skip)continue;for(var W in this.BXIM.messenger.chat){if(!this.BXIM.messenger.chat.hasOwnProperty(W)){continue}if(this.BXIM.messenger.chat[W].type!=L[x].id){continue}if(this.BXIM.messenger.generalChatId==W&&(!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet)){continue}if(a){var z=true;for(var Q=0;Q<U.length;Q++){if(this.BXIM.messenger.chat[W].name.toLowerCase().indexOf(U[Q].toLowerCase())>=0){z=false;break}}if(z){continue}}H[x].push(this.BXIM.messenger.chat[W])}H[x].sort(s.delegate(function(e,s){var t=G["chat"+e.id]?G["chat"+e.id]:0;var r=G["chat"+s.id]?G["chat"+s.id]:0;if(this.BXIM.messenger.generalChatId==e.id){t=1e7}else if(this.BXIM.messenger.userChatBlockStatus[e.id]&&this.BXIM.messenger.userChatBlockStatus[e.id][this.BXIM.userId]=="Y"){t=-1}if(this.BXIM.messenger.generalChatId==s.id){r=1e7}else if(this.BXIM.messenger.userChatBlockStatus[r.id]&&this.BXIM.messenger.userChatBlockStatus[r.id][this.BXIM.userId]=="Y"){r=-1}if(t>r){return-1}else if(t>r){return-1}else if(t<r){return 1}else{return 0}},this))}else if(L[x].id=="olQueue"){if(!this.BXIM.messenger.openlines)continue;if(!this.BXIM.messenger.openlines.queue)continue;for(var $=0;$<this.BXIM.messenger.openlines.queue.length;$++){if(a){var ee=true;for(var Q=0;Q<U.length;Q++){if(this.BXIM.messenger.openlines.queue[$].NAME.toLowerCase().indexOf(U[Q].toLowerCase())>=0){ee=false;break}}if(ee){continue}}H[x].push(this.BXIM.messenger.openlines.queue[$])}}else if(L[x].id=="structure"){if(L[x].skip){continue}for(var se in this.BXIM.messenger.groups){if(!this.BXIM.messenger.userInGroup[se]||this.BXIM.messenger.userInGroup[se].length<=0)continue;if(i=="popupChatDialogContactListElements"&&this.BXIM.messenger.userInGroup[se].length>200)continue;if(!b&&se.toString().substr(0,2)=="SG")continue;if(a){var ee=true;for(var Q=0;Q<U.length;Q++){if(this.BXIM.messenger.groups[se].name.toLowerCase().indexOf(U[Q].toLowerCase())>=0){ee=false;break}}if(ee){continue}}H[x].push(this.BXIM.messenger.groups[se])}H[x].sort(s.delegate(function(e,s){var t=e.id;var r=s.id;if(this.BXIM.messenger.userInGroup[t]&&this.BXIM.messenger.userInGroup[t].users.indexOf(this.BXIM.userId.toString())>-1){t=-1}if(this.BXIM.messenger.userInGroup[r]&&this.BXIM.messenger.userInGroup[r].users.indexOf(this.BXIM.userId.toString())>-1){r=-1}if(t>r){return 1}else if(t<r){return-1}else{return 0}},this))}if(L[x].countElement>H[x].length){O+=H[x].length;k+=L[x].countElement-H[x].length}else{F.push(x);O+=L[x].countElement}}if(O<w){var te=0;var re=F.length;for(var x=0;x<k;x++){if(F[te]&&L[F[te]]){L[F[te]].countElement=L[F[te]].countElement+1}te=te==re-1?0:te+1}}for(var x=0;x<L.length;x++){if(L[x].skip)continue;if(a&&H[x].length<=0){if(!E||L[x].id!="extranet"){continue}}if(H[x].length<=0&&!(L[x].id=="private"||L[x].id=="open"||L[x].id=="chat"||E&&L[x].id=="extranet"))continue;t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[!g||L[x].id=="lines"||L[x].id=="call"||L[x].id=="blocked"||L[x].id=="bot"||L[x].id=="ol"?null:s.create("span",{attrs:{"data-type":L[x].id},props:{title:L[x].title,className:"bx-messenger-chatlist-group-add"}}),s.create("span",{props:{className:"bx-messenger-chatlist-group-title"},html:L[x].name})]}));if(H[x].length<=0){if(E&&L[x].id=="extranet"){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[s.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:this.BXIM.bitrixIntranet?s.message("IM_SEARCH_B24"):s.message("IM_SEARCH_SITE")})]}))}continue}var ie=[];var ne=1;for(var ae=0;ae<H[x].length;ae++){var oe=ne<=L[x].countElement;ne++;if(L[x].id=="private"||L[x].id=="extranet"||L[x].id=="bot"||L[x].id=="ol"){var K=H[x][ae];ie.push(this.drawContactListElement({id:K.id,data:K,showLastMessage:false,showCounter:g,extraClass:oe?"":"bx-messenger-hide"}))}else if(L[x].id=="chat"||L[x].id=="open"||L[x].id=="call"||L[x].id=="lines"){var le=H[x][ae];ie.push(this.drawContactListElement({id:"chat"+le.id,data:le,showLastMessage:false,showCounter:g,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}else if(L[x].id=="olQueue"||L[x].id=="viQueue"){var me=H[x][ae];me.type=L[x].id;ie.push(this.drawContactListElement({id:"queue"+me.ID,data:me,showLastMessage:false,showCounter:false,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}else if(L[x].id=="structure"){var he=H[x][ae];ie.push(this.drawContactListElement({id:"structure"+he.id,data:he,showLastMessage:false,showCounter:false,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}}if(L[x].countElement<H[x].length){ie.push(s.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},children:[s.create("span",{attrs:{"data-id":L[x].id,"data-text":s.message("IM_CL_MORE").replace("#COUNT#",H[x].length-L[x].countElement),"data-title":L[x].more},props:{title:L[x].more,className:"bx-messenger-chatlist-more"},html:this.BXIM.messenger.contactListShowed[L[x].id]?s.message("IM_CL_HIDE"):s.message("IM_CL_MORE").replace("#COUNT#",H[x].length-L[x].countElement)})]}))}if(ie.length>0){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-category"+(this.BXIM.messenger.contactListShowed[L[x].id]?" bx-messenger-chatlist-show-all":"")},children:ie}));if(E&&L[x].id=="extranet"){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[s.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:s.message("IM_SEARCH_B24")})]}))}}}if(l){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-search"},html:s.message("IM_M_CL_SEARCH")}))}else if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}));X.empty()}return t};s.MessengerCommon.prototype.userHasPhone=function(e){return this.BXIM.messenger.users.hasOwnProperty(e)&&this.BXIM.messenger.users[e].phoneDevice||this.BXIM.messenger.phones.hasOwnProperty(e)&&(this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_MOBILE")||this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_PHONE")||this.BXIM.messenger.phones[e].hasOwnProperty("WORK_PHONE"))};s.MessengerCommon.prototype.prepareCommandList=function(e){e=typeof e=="string"?e:"";var t=s.clone(this.BXIM.messenger.command);var r=[];var i=[];for(var n=0;n<t.length;n++){if(this.BXIM.messenger.openChatFlag){if(s.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),t[n].bot_id)){r.push(t[n])}else{i.push(t[n])}}else{if(this.BXIM.messenger.currentTab==parseInt(t[n].bot_id)){r.push(t[n])}else{i.push(t[n])}}}for(var n=0;n<i.length;n++){r.push(i[n])}var a=[];var o="";for(var n=0;n<r.length;n++){if(e==""||r[n].command.indexOf(e)===1){if(this.BXIM.userExtranet&&!r[n].extranet)continue;if(!r[n].common){if(this.BXIM.messenger.openChatFlag){if(!s.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),r[n].bot_id)){continue}}else if(this.BXIM.messenger.currentTab!=parseInt(r[n].bot_id)){continue}}if(r[n].context!=""){if(r[n].context=="chat"){if(!this.BXIM.messenger.openChatFlag){continue}}else if(r[n].context=="user"){if(this.BXIM.messenger.openChatFlag){continue}}else if(e==""){continue}}if(o!=r[n].category){o=r[n].category;a.push({type:"category",title:o})}if(r[n].command=="/>>"){r[n].command=">>"}r[n].type="item";a.push(r[n])}}return a};s.MessengerCommon.prototype.drawMessage=function(e,t,r,i){if(typeof t!="object"||this.BXIM.messenger.popupMessenger==null)return false;var n=this.BXIM.messenger.popupMessengerBodyWrap;var a="default";var o=false;var l=true;var m=true;if(typeof e=="object"){o=true;a=e.placeholderName||"custom";n=e.placeholder;l=e.showKeyboard==false?false:true;m=e.showReply==false?false:true}else if(e!=this.BXIM.messenger.currentTab||e==0||!this.MobileActionEqual("DIALOG")){return false}i=i==true;r=i?false:r;var h=false;var g=false;var I=t.params&&t.params.IS_EDITED=="Y";var p=t.params&&t.params.IS_DELETED=="Y";var M=p?s.message("IM_M_DELETED"):t.text;var c=t.id.indexOf("temp")==0;var d=c&&t.retry;var u=t.senderId==0;var f=this.BXIM.ppServerStatus;if(c){M=M.replace(/^(https|http):\/\/(.*)(\.(jpg|jpeg|png|gif)\?|\.(jpg|jpeg|png|gif)$)/gi,function(e){return'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+e+'" class="bx-messenger-file-image-text"></span></span><br>'})}if(o){h=t.chatId&&this.BXIM.messenger.chat[t.chatId]?true:false;g=h&&t.chatId==this.BXIM.messenger.generalChatId;if(h&&this.BXIM.messenger.chat[t.chatId].type=="call"){f=false}else if(h&&this.BXIM.messenger.chat[t.chatId].type=="lines"){var B=this.linesGetSource(t.chatId);if(!(B=="livechat")){f=false}}else if(!h&&this.BXIM.messenger.bot[t.recipientId]&&this.BXIM.messenger.bot[t.recipientId].type=="network"){f=false}}else{if(t.senderId==this.BXIM.userId){if(this.BXIM.messenger.popupMessengerLastMessage>0&&this.BXIM.messenger.message[this.BXIM.messenger.popupMessengerLastMessage]&&this.BXIM.messenger.message[this.BXIM.messenger.popupMessengerLastMessage].recipientId==this.BXIM.messenger.currentTab){if(this.BXIM.messenger.popupMessengerLastMessage<t.id){this.BXIM.messenger.popupMessengerLastMessage=t.id}}else{this.BXIM.messenger.popupMessengerLastMessage=t.id}}this.BXIM.messenger.openChatFlag=this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat";h=this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="chat"||this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="open");g=h&&t.chatId==this.BXIM.messenger.generalChatId;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){f=false}else if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="lines"){var B=this.linesGetSource(this.BXIM.messenger.currentTab.toString().substr(4));if(!(B=="livechat")){f=false}}else if(!this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type=="network"){f=false}}if(typeof t.params!="object"){t.params={}}if(t.params.DATE_TEXT){for(var X=0;X<t.params.DATE_TEXT.length;X++){M=M.split(t.params.DATE_TEXT[X]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+t.id+'" data-ts="'+t.params.DATE_TS[X]+'">'+t.params.DATE_TEXT[X]+"</span>")}}var E=f&&typeof t.params.LIKE=="object"&&t.params.LIKE.length>0?t.params.LIKE.length:"";var C=f&&typeof t.params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,t.params.LIKE);var b=this.diskDrawFiles(t.chatId,t.params.FILE_ID);if(b.length>0){b=s.create("div",{props:{className:"bx-messenger-file-box"+(M!=""?" bx-messenger-file-box-with-message":"")},children:b})}else{b=null}var S=m?this.drawMessageReply(t.id):null;var _=null;var T=[];if(t.params.ATTACH){for(var X=0;X<t.params.ATTACH.length;X++){T[X]=t.params.ATTACH[X]}var A=/\[ATTACH=([0-9]{1,})\]/gm;var v=[];while((v=A.exec(M))!==null){for(var X=0;X<T.length;X++){if(t.params.ATTACH[X].ID==v[1]){_=s.create("div",{props:{className:"bx-messenger-attach-box"},children:s.MessengerCommon.drawAttach(t.id,t.chatId,[T[X]])});M=M.replace("[ATTACH="+v[1]+"]",_.innerHTML);delete T[X]}}}}if(t.params.LINK_ACTIVE&&t.params.LINK_ACTIVE.length>0&&t.params.LINK_ACTIVE.indexOf(this.BXIM.userId.toString())<0){M=M.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}var R="";if(t.params.CLASS){R=t.params.CLASS}var L=null;if(t.params.IMOL_SID&&parseInt(t.params.IMOL_SID)>0){L=s.create("div",{props:{className:"bx-messenger-message-extra"},html:s.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",t.params.IMOL_SID)})}if(t.params.IMOL_FORM&&this.BXIM.messenger.chat[t.chatId]&&this.BXIM.messenger.chat[t.chatId].type=="livechat"){var y=t.params.IMOL_FORM.toString().substr(-6)=="-delay";var x=y?t.params.IMOL_FORM.substr(0,t.params.IMOL_FORM.lastIndexOf("-delay")):t.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<t.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=x){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=t.id;this.BXIM.messenger.popupMessengerLiveChatDelayedForm=y?x:null;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(x)},this),y?3e4:5e3)}}_=s.MessengerCommon.drawAttach(t.id,t.chatId,T);if(_.length>0){_=s.create("div",{props:{className:"bx-messenger-attach-box"},children:_})}else{_=null}var N=null;if(l&&t.params.KEYBOARD){N=this.drawKeyboard(t.recipientId,t.id,t.params.KEYBOARD)}var w=false;if(!b&&!_&&M.length<=0){w=true}if(t.system&&t.system=="Y"){u=true;t.senderId=0}var D=false;var O=this.BXIM.messenger.users[t.senderId];if(!u&&(typeof O=="undefined"||O.id<=0)){D=true;w=true}if(t.params&&O&&O.id>0&&(t.params.AVATAR||t.params.NAME||t.params.USER_ID)){O=s.clone(O);if(t.params.AVATAR){O.avatar=t.params.AVATAR}if(t.params.NAME){O.name=t.params.NAME;O.firstName=t.params.NAME.split(" ")[0]}t=s.clone(t);if(parseInt(t.params.USER_ID)){t.senderId="network"+t.params.USER_ID}}var k=this.linesVoteDraw(t.id);if(k){M=k;t.system="Y"}else{R=R.replace("bx-messenger-content-item-vote","");var U=this.linesVoteResultDraw(t.id,M);if(U){M=U}}if(!o){if(!this.BXIM.messenger.history[e])this.BXIM.messenger.history[e]=[];if(parseInt(t.id)>0&&this.BXIM.messenger.history[e].indexOf(t.id.toString())==-1)this.BXIM.messenger.history[e].push(t.id);var P=0;if(!D){var G=false;if(this.BXIM.messenger.unreadMessage[e]&&s.util.in_array(t.id,this.BXIM.messenger.unreadMessage[e]))G=true}}var H=false;var F=null;if(i){F=n.firstChild;if(F){if(s.hasClass(F,"bx-messenger-content-empty")||s.hasClass(F,"bx-messenger-content-load")){s.remove(F)}else if(s.hasClass(F,"bx-messenger-content-group")){F=F.nextSibling}}}else{F=n.lastChild;if(F&&(s.hasClass(F,"bx-messenger-content-empty")||s.hasClass(F,"bx-messenger-content-load"))){s.remove(F)}else if(F&&s.hasClass(F,"bx-messenger-content-item-notify")){if(t.senderId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(F);H=false;F=n.lastChild}else{H=true;F=n.lastChild.previousSibling}}}if(!D){var j=this.formatDate(t.date,this.getDateFormatType("MESSAGE_TITLE"));var V=typeof s.translit!="undefined"?s.translit(j):j;if(typeof this.messageGroup!="object"){this.messageGroup={}}if(typeof this.messageGroup[a]!="object"){this.messageGroup[a]={}}if(!this.messageGroup[a][V]){this.messageGroup[a][V]=true;var W=[];if(this.BXIM.desktop&&this.isPage()){W=[s.create("a",{attrs:{name:"bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-link"}}),s.create("a",{attrs:{id:"bx-im-go-"+V,href:"#bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:j})]}else{W=[s.create("a",{attrs:{name:"bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-link"}}),s.create("div",{attrs:{id:"bx-im-go-"+V},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:j})]}var Y=s.create("div",{props:{className:"bx-messenger-content-group"+(j==s.message("FD_TODAY")?" bx-messenger-content-group-today":"")},children:W});if(i){n.insertBefore(Y,n.firstChild);F=Y.nextSibling}else{if(H&&F.nextElementSibling){n.insertBefore(Y,F.nextElementSibling);F=Y}else{n.appendChild(Y)}}}}var K=null;if(typeof M=="string"){K=s.create("span",{props:{className:"bx-messenger-message"+(p?" bx-messenger-message-deleted":" ")+(p||I?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:this.prepareText(M,false,true,true,!this.BXIM.messenger.openChatFlag||t.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name)})}else{K=s.create("span",{props:{className:"bx-messenger-message"+(p?" bx-messenger-message-deleted":" ")+(p||I?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},children:[M]})}if(!w){if(F)P=F.getAttribute("data-messageId");if(u){var q=s.create("div",{attrs:{"data-type":"system","data-senderId":"0","data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-system "+R},children:[L,s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[typeof O=="undefined"||O.id<=0?[]:s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(O.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:O.avatar,style:this.isBlankAvatar(O.avatar)?"background-color: "+O.color:""}}),this.BXIM.messenger.openChatFlag?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(O.name)},html:O.firstName?O.firstName:O.name}):null]})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_REPLY_TITLE")},props:{className:"bx-messenger-content-item-reply"},attrs:{"data-messageId":t.id,title:s.message("IM_M_REPLY_TITLE")}}),!g?[]:s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),K,b,_]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!f?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(C?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:E>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(E<=0?" bx-messenger-content-like-digit-off":"")},html:E}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),N,S]});if(t.system&&t.system=="Y"&&G)s.addClass(q,"bx-messenger-content-item-new")}else if(t.senderId==this.BXIM.userId){var q=s.create("div",{attrs:{"data-type":"self","data-senderId":t.senderId,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-1 "+R},children:[L,s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(O.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:O.avatar,style:this.isBlankAvatar(O.avatar)?"background-color: "+O.color:""}}),this.BXIM.messenger.openChatFlag?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(O.name)},html:O.firstName?O.firstName:O.name}):null]})]}),d?s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[s.create("span",{attrs:{title:s.message("IM_M_RETRY"),"data-messageid":t.id,"data-chat":parseInt(t.recipientId)>0?"Y":"N"},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]}):s.create("span",{props:{className:"bx-messenger-content-item-status"},children:c?[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_REPLY_TITLE")},props:{className:"bx-messenger-content-item-reply"},attrs:{"data-messageId":t.id,
title:s.message("IM_M_REPLY_TITLE")}}),s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),K,b,_]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:d?s.message("IM_M_NOT_DELIVERED"):" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!f?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(C?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:E>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(E<=0?" bx-messenger-content-like-digit-off":"")},html:E}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),N,S]})}else{var q=s.create("div",{attrs:{"data-type":"other","data-senderId":t.senderId,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-2"+(G?" bx-messenger-content-item-new":"")+" "+R},children:[L,s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{attrs:{title:s.util.htmlspecialcharsback(O.name)},props:{className:"bx-messenger-content-item-avatar bx-messenger-content-item-avatar-button"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(O.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:O.avatar,style:this.isBlankAvatar(O.avatar)?"background-color: "+O.color:""}}),this.BXIM.messenger.openChatFlag||O.bot?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(O.name)},html:O.firstName?O.firstName:O.name}):null]})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_REPLY_TITLE")},props:{className:"bx-messenger-content-item-reply",title:s.message("IM_M_REPLY_TITLE")},attrs:{"data-messageId":t.id}}),s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),K,b,_]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!f?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(C?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:E>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(E<=0?" bx-messenger-content-like-digit-off":"")},html:E}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),N,S]})}}else if(D){q=s.create("div",{attrs:{id:"im-message-"+t.id,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item-text-wrap bx-messenger-item-skipped"}})}if(q&&(!w||D)){var J=null;if(F&&F.getAttribute("data-senderId")!=t.senderId){J=s.create("div",{props:{className:"bx-messenger-item-delimiter"}})}if(i){n.insertBefore(q,F);if(J){n.insertBefore(J,F)}}else if(H&&F&&F.nextElementSibling){n.insertBefore(q,F.nextElementSibling);if(J){n.insertBefore(J,F.nextElementSibling)}}else{if(J){n.appendChild(J)}n.appendChild(q)}}if(!o&&!D&&this.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight,r)){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}if(t.params.SENDING=="Y"||t.params.IS_DELIVERED=="N"){this.drawProgessMessage(t.id)}return P};s.MessengerCommon.prototype.drawMessageReply=function(e){var t=null;if(!(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.CHAT_ID>0)){return t}var r=[];var i=this.BXIM.messenger.message[e].params.CHAT_USER||[];var n=0;for(var a=i.length-1;a>=0;a--){if(!this.BXIM.messenger.users[i[a]])continue;var o=this.isBlankAvatar(this.BXIM.messenger.users[i[a]].avatar)?this.BXIM.messenger.users[i[a]].color:"transparent";r.push(s.create("span",{props:{className:"bx-messenger-panel-chat-user"},children:[s.create("span",{props:{className:"bx-notifier-popup-avatar"},children:[s.create("img",{props:{className:"bx-notifier-popup-avatar-img"+(this.isBlankAvatar(this.BXIM.messenger.users[i[a]].avatar)?" bx-notifier-popup-avatar-img-default":"")},attrs:{src:this.BXIM.messenger.users[i[a]].avatar},style:{backgroundColor:o}})]})]}));n++;if(n==5){break}}var l=this.BXIM.messenger.message[e].params.CHAT_LAST_DATE||0;var m=this.BXIM.messenger.message[e].params.CHAT_MESSAGE||0;t=s.create("div",{props:{className:"bx-messenger-content-reply"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-users"},children:r}),s.create("span",{props:{className:"bx-messenger-content-reply-answer"},attrs:{"data-messageId":e},html:m+" "+this.getMessagePlural("IM_R_COMMENT",m)}),s.create("span",{props:{className:"bx-messenger-content-reply-date"},html:", "+this.formatDate(l)})]});return t};s.MessengerCommon.prototype.openReplyDialog=function(e){if(this.isMobile()){alert(s.message("IM_AV_NEXT_VERSION"));return false}this.BXIM.messenger.openMessengerPanel();this.BXIM.messenger.popupMessengerBodyPanelTitleName.innerHTML=s.message("IM_R_DIALOG_TITLE");var t=this.drawMessageReply(e);if(t){this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML="";this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.appendChild(t)}else{this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML=s.message("IM_R_COMMENT_ZERO")}this.BXIM.messenger.popupMessengerBodyPanelWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyPanelWrap,{children:[this.BXIM.messenger.popupMessengerBodyPanelWrapMessage=s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message"}}),this.BXIM.messenger.popupMessengerBodyPanelWrapMessages=s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-list"}}),s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-textarea"},children:[this.popupMessengerTextareaPlace=s.create("div",{props:{className:"bx-messenger-textarea-place"},children:[s.create("div",{props:{className:"bx-messenger-textarea-send"},children:[s.create("a",{attrs:{href:"#send"},props:{className:"bx-messenger-textarea-send-button"},events:{click:s.delegate(this.sendMessage,this)}})]}),this.popupMessengerBodyPanelSmileButton=s.create("div",{attrs:{title:s.message("IM_SMILE_MENU")},props:{className:"bx-messenger-textarea-smile"},events:{click:s.delegate(function(e){this.openSmileMenu();return s.PreventDefault(e)},this)}}),s.create("div",{props:{className:"bx-messenger-textarea"},children:[this.popupMessengerPanelTextarea=s.create("textarea",{props:{value:"",className:"bx-messenger-textarea-input"}}),this.popupMessengerPanelTextareaPlaceholder=s.create("div",{props:{className:"bx-messenger-textarea-placeholder"},html:s.message("IM_M_TA_TEXT")})]}),s.create("div",{props:{className:"bx-messenger-textarea-clear"}})]})]})]});if(typeof this.messageGroup!="object"){this.messageGroup={}}this.messageGroup["reply"]={};this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessage,placeholderName:"reply",showKeyboard:false,showReply:false},this.BXIM.messenger.message[e]);if(t){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_R_LOAD_COMMENT")+"</span></div>"}else{this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_R_NO_COMMENT")+"</span></div>"}this.messageGroup["replyMessages"]={};if(t){setTimeout(s.delegate(function(){if(!this.BXIM.messenger.message[e]||this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.CHAT_ID<=0){return false}var t="chat"+this.BXIM.messenger.message[e].params.CHAT_ID;this.loadLastMessage(t,s.delegate(function(e,t,r){if(!t){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_F_ERROR")+"</span></div>";return false}this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML="";var i=s.util.shuffle(this.BXIM.messenger.showMessage[e]);for(var n=0;n<i.length;n++){this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessages,placeholderName:"replyMessages",showKeyboard:false,showReply:false},this.BXIM.messenger.message[i[n]])}},this))},this),1e3)}return true};s.MessengerCommon.prototype.checkProgessMessage=function(){for(messageId in this.BXIM.messenger.popupMessengerSendingTimeout){if(!this.BXIM.messenger.message[messageId]||!this.BXIM.messenger.message[messageId].params||!this.BXIM.messenger.message[messageId].params.SENDING_TS){delete this.BXIM.messenger.popupMessengerSendingTimeout[messageId]}else if(parseInt(this.BXIM.messenger.message[messageId].params.SENDING_TS)+parseInt(s.message("USER_TZ_OFFSET"))+60<this.getNowDate()){this.drawProgessMessage(messageId)}}};s.MessengerCommon.prototype.drawProgessMessage=function(e,t){var r=s("im-message-"+e);if(!r)return false;s.addClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");r.parentNode.parentNode.parentNode.previousSibling.innerHTML="";var i=true;if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"&&parseInt(this.BXIM.messenger.message[e].params.SENDING_TS)+parseInt(s.message("USER_TZ_OFFSET"))+60<this.getNowDate()||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];this.BXIM.messenger.message[e].params.IS_DELIVERED="N";this.BXIM.messenger.message[e].params.SENDING="N";this.BXIM.messenger.message[e].params.SENDING_TS=0;i=false;var n=s.findChildByClassName(r.parentNode.parentNode.parentNode,"bx-messenger-content-item-date");if(n)n.innerHTML=s.message("IM_M_NOT_DELIVERED")}if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.SENDING=="Y"){this.BXIM.messenger.popupMessengerSendingTimeout[e]=this.BXIM.messenger.message[e].params.SENDING_TS}if(!i){if(this.BXIM.messenger.message[e]){s.addClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error")}}else if(typeof t=="object"||t===true){if(this.BXIM.messenger.message[e]){this.BXIM.messenger.errorMessage[this.BXIM.messenger.currentTab]=true;s.addClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.chat=t.chat?t.chat:parseInt(this.BXIM.messenger.message[e].recipientId)>0?"Y":"N";s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{attrs:{title:t.title?t.title:"","data-messageid":e,"data-chat":t.chat},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]})}else{s.removeClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error")}}else{s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]})}return true};s.MessengerCommon.prototype.clearProgessMessage=function(e){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];var t=s("im-message-"+e);if(!t)return false;if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){return false}s.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.parentNode.parentNode.parentNode.previousSibling.innerHTML="";return true};s.MessengerCommon.prototype.startWriting=function(e,t,r){if(t==this.BXIM.userId){this.BXIM.messenger.writingList[e]=true;this.drawWriting(e);clearTimeout(this.BXIM.messenger.writingListTimeout[e]);this.BXIM.messenger.writingListTimeout[e]=setTimeout(s.delegate(function(){this.endWriting(e)},this),29500)}else{if(!this.BXIM.messenger.writingList[t])this.BXIM.messenger.writingList[t]={};if(!this.BXIM.messenger.writingListTimeout[t])this.BXIM.messenger.writingListTimeout[t]={};this.BXIM.messenger.writingList[t][e]=true;this.drawWriting(e,t);clearTimeout(this.BXIM.messenger.writingListTimeout[t][e]);this.BXIM.messenger.writingListTimeout[t][e]=setTimeout(s.delegate(function(){this.endWriting(e,t)},this),29500)}};s.MessengerCommon.prototype.drawWriting=function(e,t,r){r=typeof r=="undefined"?true:r;if(e==this.BXIM.userId)return false;if(this.BXIM.messenger.popupMessenger!=null&&this.MobileActionEqual("RECENT","DIALOG")){if(this.BXIM.messenger.writingList[e]||t&&this.countWriting(t)>0){var i=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(t?t:e));if(i){for(var n=0;n<i.length;n++)s.addClass(i[n],"bx-messenger-cl-status-writing")}var i=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(t?t:e));if(i){for(var n=0;n<i.length;n++)s.addClass(i[n],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==e||t&&this.BXIM.messenger.currentTab==t)){if(t){var a=[];for(var n in this.BXIM.messenger.writingList[t]){if(this.BXIM.messenger.writingList[t].hasOwnProperty(n)&&this.BXIM.messenger.users[n]){a.push(this.BXIM.messenger.users[n].name)}}this.drawNotifyMessage(t,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",a.join(", ")))}else{if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-writing"}this.drawNotifyMessage(e,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",this.BXIM.messenger.users[e].name))}}}else if(!this.BXIM.messenger.writingList[e]||t&&this.countWriting(t)==0){var i=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(t?t:e));if(i){for(var n=0;n<i.length;n++)s.removeClass(i[n],"bx-messenger-cl-status-writing")}var i=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(t?t:e));if(i){for(var n=0;n<i.length;n++)s.removeClass(i[n],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==e||this.BXIM.messenger.currentTab==t)){if(!t){if(!this.isMobile())this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+this.getUserStatus(e)}var o=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(o&&s.hasClass(o,"bx-messenger-content-item-notify")&&this.BXIM.messenger.popupMessengerBody){if(!t&&this.BXIM.messenger.readedList[e]){this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}else if(t&&this.BXIM.messenger.readedList[t]){this.drawReadMessageChat(t,false)}else if(s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop-o.offsetHeight},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this),complete:s.delegate(function(){s.remove(o)},this)})).animate()}else if(r){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-o.offsetHeight;s.remove(o)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-o.offsetHeight;s.remove(o)}}}}}};s.MessengerCommon.prototype.endWriting=function(e,s,t){t=typeof t=="undefined"?true:t;if(s){if(this.BXIM.messenger.writingListTimeout[s]&&this.BXIM.messenger.writingListTimeout[s][e])clearTimeout(this.BXIM.messenger.writingListTimeout[s][e]);if(this.BXIM.messenger.writingList[s]&&this.BXIM.messenger.writingList[s][e])delete this.BXIM.messenger.writingList[s][e]}else{clearTimeout(this.BXIM.messenger.writingListTimeout[e]);delete this.BXIM.messenger.writingList[e]}this.drawWriting(e,s,t)};s.MessengerCommon.prototype.sendWriting=function(t){if(!this.BXIM.ppServerStatus||t=="create"||t==this.BXIM.userId)return false;if(!this.BXIM.messenger.writingSendList[t]){clearTimeout(this.BXIM.messenger.writingSendListTimeout[t]);this.BXIM.messenger.writingSendList[t]=true;var r="N";if(t.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[t.toString().substr(4)]){r="Y"}s.ajax({url:this.BXIM.pathToAjax+"?START_WRITING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_START_WRITING:"Y",DIALOG_ID:t,OL_SILENT:r,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR=="AUTHORIZE_ERROR"&&this.isDesktop()&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR])}}},this)});this.BXIM.messenger.writingSendListTimeout[t]=setTimeout(s.delegate(function(){this.endSendWriting(t)},this),3e4)}};s.MessengerCommon.prototype.endSendWriting=function(e){clearTimeout(this.BXIM.messenger.writingSendListTimeout[e]);this.BXIM.messenger.writingSendList[e]=false};s.MessengerCommon.prototype.countWriting=function(e){var s=0;if(this.BXIM.messenger.writingList[e]){if(typeof this.BXIM.messenger.writingList[e]=="object"){for(var t in this.BXIM.messenger.writingList[e]){if(this.BXIM.messenger.writingList[e].hasOwnProperty(t)){s++}}}else{s=1}}return s};s.MessengerCommon.prototype.leaveFromChat=function(e,t){if(!this.BXIM.messenger.chat[e])return false;t=t!=false;if(!t){if(this.BXIM.messenger.chat[e].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.userInChat[e];delete this.BXIM.messenger.unreadMessage[e];delete this.BXIM.messenger.showMessage[e];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e][r])){delete this.BXIM.messenger.userInChat[e][r];break}}this.BXIM.messenger.dialogStatusRedraw();delete this.BXIM.messenger.unreadMessage[e]}this.recentListHide("chat"+e,false);this.userListRedraw()}else{s.ajax({url:this.BXIM.pathToAjax+"?CHAT_LEAVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_LEAVE:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.readMessage("chat"+e.CHAT_ID,true,false);if(this.BXIM.messenger.chat[e.CHAT_ID].type!="open"){delete this.BXIM.messenger.showMessage[e.CHAT_ID];delete this.BXIM.messenger.userInChat[e.CHAT_ID];delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];delete this.BXIM.messenger.chat[e.CHAT_ID];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);this.BXIM.messenger.extraClose()}}}else{for(var t=0;t<this.BXIM.messenger.userInChat[e.CHAT_ID].length;t++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e.CHAT_ID][t])){delete this.BXIM.messenger.userInChat[e.CHAT_ID][t];break}}delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];this.BXIM.messenger.dialogStatusRedraw()}this.recentListHide("chat"+e.CHAT_ID,false);this.userListRedraw();s.localStorage.set("mcl",e.CHAT_ID,5)}},this)})}};s.MessengerCommon.prototype.dialogCloseCurrent=function(){var e=s.findChildByClassName(this.BXIM.messenger.popupContactListWrap,"bx-messenger-cl-item");if(e){this.BXIM.messenger.openMessenger(e.getAttribute("data-userId"))}else{this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}};s.MessengerCommon.prototype.pullEvent=function(){var t=s.delegate(function(t,r){if(t=="generalChatId"){this.BXIM.messenger.generalChatId=r.ID}else if(t=="updateSettings"){for(var i in r){this.BXIM.settings[i]=r[i]}}else if(t=="generalChatAccess"){if(this.BXIM.messenger.canSendMessageGeneralChat&&r.BLOCK){if(this.MobileActionEqual("DIALOG")){this.BXIM.messenger.canSendMessageGeneralChat=false;if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.redrawChatHeader({userRedraw:false})}}}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat ("+r.ALLOW+")");location.reload()}else if(this.isDesktop()){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat ("+r.ALLOW+")");location.reload()}}else if(t=="desktopOffline"){this.BXIM.desktopStatus=false}else if(t=="desktopOnline"){this.BXIM.desktopStatus=true}else if(t=="readMessage"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage(r.userId,false,false,true)}else if(t=="readMessageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage("chat"+r.chatId,false,false,true)}else if(t=="readMessageChatApponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!this.BXIM.messenger.readedList["chat"+r.chatId]){this.BXIM.messenger.readedList["chat"+r.chatId]={}}this.BXIM.messenger.readedList["chat"+r.chatId][r.userId]={messageId:r.lastId,date:parseInt(r.date)+parseInt(s.message("USER_TZ_OFFSET"))};this.drawReadMessageChat("chat"+r.chatId)}else if(t=="readMessageApponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;r.date=parseInt(r.date)+parseInt(s.message("USER_TZ_OFFSET"));this.drawReadMessage(r.userId,r.lastId,r.date)}else if(t=="unreadMessageApponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;var n=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(n&&s.hasClass(n,"bx-messenger-content-item-notify")){if(r.userId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(n)}}}else if(t=="unreadMessageChatApponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!this.BXIM.messenger.readedList["chat"+r.chatId]){this.BXIM.messenger.readedList["chat"+r.chatId]={}}delete this.BXIM.messenger.readedList["chat"+r.chatId][r.userId];this.drawReadMessageChat("chat"+r.chatId)}else if(t=="startWriting"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(this.isBot(r.senderId)&&!r.DEFERRED&&this.BXIM.messenger.showMessage[r.dialogId]&&this.BXIM.messenger.showMessage[r.dialogId].length){var a=this.BXIM.messenger.bot[r.senderId];if(a.type=="human"){var o=s.clone({command:t,params:r});setTimeout(s.delegate(function(){o.params.DEFERRED=true;s.onCustomEvent(e,this.isMobile()?"onPull-im":"onPullEvent-im",[o.command,o.params])},this),1e3);return false}}this.startWriting(r.senderId,r.dialogId,r.userName)}else if(t=="addBot"||t=="updateBot"){if(this.BXIM.userExtranet)return false;if(typeof r.users!="undefined"){for(var i in r.users){this.BXIM.messenger.users[i]=r.users[i]}}if(typeof r.userInGroup!="undefined"){for(var i in r.userInGroup){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=r.userInGroup[i]}else{for(var l=0;l<r.userInGroup[i].users.length;l++)this.BXIM.messenger.userInGroup[i].users.push(r.userInGroup[i].users[l]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}}if(typeof r.woUserInGroup!="undefined"){for(var i in r.woUserInGroup){if(typeof this.BXIM.messenger.woUserInGroup[i]=="undefined"){this.BXIM.messenger.woUserInGroup[i]=r.woUserInGroup[i]}else{for(var l=0;l<r.woUserInGroup[i].users.length;l++)this.BXIM.messenger.woUserInGroup[i].users.push(r.woUserInGroup[i].users[l]);this.BXIM.messenger.woUserInGroup[i].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[i].users)}}}if(typeof r.bot!="undefined"){for(var i in r.bot){this.BXIM.messenger.bot[i]=r.bot[i]}}}else if(t=="updateUser"){this.BXIM.messenger.users[r.USER.id]=r.USER;this.BXIM.messenger.redrawChatHeader()}else if(t=="deleteBot"){if(this.BXIM.messenger.bot[r.botId]){delete this.BXIM.messenger.bot[r.botId]}if(this.BXIM.messenger.users[r.botId]){delete this.BXIM.messenger.users[r.botId]}this.recentListHide(r.botId,false);if(this.BXIM.messenger.currentTab==r.botId){this.BXIM.messenger.openMessenger("general")}}else if(t=="chatMuteNotify"){if(this.BXIM.messenger.chat[r.chatId]&&this.BXIM.messenger.userChatBlockStatus[r.chatId]&&this.BXIM.messenger.userChatBlockStatus[r.chatId][this.BXIM.userId]&&this.BXIM.messenger.userChatBlockStatus[r.chatId][this.BXIM.userId]!=r.mute){this.muteMessageChat("chat"+r.chatId,r.mute,false)}}else if(t=="message"||t=="messageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!r.DEFERRED&&this.BXIM.lastRecordId>=r.MESSAGE.id)return false;if(r.MESSAGE.senderId!=this.BXIM.userId){s.onCustomEvent("onImMessageReceive",[{command:t,params:r}])}var m=r.MESSAGE.senderId;if(r.MESSAGE.recipientId.toString().substr(0,4)=="chat"){m=r.MESSAGE.recipientId}if(this.sendBotCommandBlock[r.MESSAGE.senderId]){for(var h in this.sendBotCommandBlock[r.MESSAGE.senderId]){delete this.sendBotCommandBlock[r.MESSAGE.senderId][h];var g=s("im-message-keyboard-"+h);if(g){var I=s.findChildrenByClassName(g,"bx-messenger-keyboard-button-block",false);for(var i=0;i<I.length;i++){s.removeClass(I[i],"bx-messenger-keyboard-button-progress");s.removeClass(I[i],"bx-messenger-keyboard-button-block")}}}}if(this.isBot(r.MESSAGE.senderId)&&!r.DEFERRED&&this.BXIM.messenger.showMessage[m]&&this.BXIM.messenger.showMessage[m].length){var a=this.BXIM.messenger.bot[r.MESSAGE.senderId];if(a.type=="human"){if(r.CHAT[m]&&r.CHAT[m].entity_type=="LINES"){p=1e3}else{var p=r.MESSAGE.text.split(" ").length*300+1e3;if(p>5e3){p=5e3}}var o=s.clone({command:t,params:r,waitTime:p});setTimeout(s.delegate(function(){o.params.MESSAGE.date=parseInt(o.params.MESSAGE.date)+Math.ceil(o.waitTime/1e3);o.params.DEFERRED=true;s.onCustomEvent(e,this.isMobile()?"onPull-im":"onPullEvent-im",[o.command,o.params])},this),p);return false}}var M={};M.MESSAGE={};M.USERS_MESSAGE={};r.MESSAGE.date=parseInt(r.MESSAGE.date)+parseInt(s.message("USER_TZ_OFFSET"));for(var i in r.CHAT){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)r.CHAT[i].fake=true;else if(!this.BXIM.messenger.chat[i])r.CHAT[i].fake=true;this.BXIM.messenger.chat[i]=r.CHAT[i]}for(var i in r.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=r.USER_IN_CHAT[i]}for(var i in r.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=r.USER_BLOCK_CHAT[i]}var c={};for(var i in r.USERS){if(this.BXIM.messenger.users[i]&&this.BXIM.messenger.users[i].status!=r.USERS[i].status&&parseInt(r.MESSAGE.date)+180>s.MessengerCommon.getNowDate()){c[i]=this.BXIM.messenger.users[i].status;this.BXIM.messenger.users[i].status=r.USERS[i].status}}if(this.MobileActionEqual("RECENT")){for(var i in c){if(!this.BXIM.messenger.users[i])continue;var d=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+i);if(d!=null){for(var l=0;l<d.length;l++){s.removeClass(d[l],"bx-messenger-cl-status-"+c[i]);s.addClass(d[l],"bx-messenger-cl-status-"+s.MessengerCommon.getUserStatus(i));d[l].setAttribute("data-status",s.MessengerCommon.getUserStatus(i))}}var d=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+i);if(d!=null){for(var l=0;l<d.length;l++){s.removeClass(d[l],"bx-messenger-cl-status-"+c[i]);s.addClass(d[l],"bx-messenger-cl-status-"+s.MessengerCommon.getUserStatus(i));d[l].setAttribute("data-status",s.MessengerCommon.getUserStatus(i))}}}}d=null;M.USERS=r.USERS;if(this.MobileActionEqual("DIALOG")){for(var i in r.FILES){if(!this.BXIM.disk.files[r.CHAT_ID])this.BXIM.disk.files[r.CHAT_ID]={};if(this.BXIM.disk.files[r.CHAT_ID][i])continue;r.FILES[i].date=parseInt(r.FILES[i].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.disk.files[r.CHAT_ID][i]=r.FILES[i]}}M.MESSAGE[r.MESSAGE.id]=r.MESSAGE;this.BXIM.lastRecordId=r.MESSAGE.id;if(r.MESSAGE.senderId==this.BXIM.userId){if(this.BXIM.messenger.sendMessageFlag>0&&r.MESSAGE.system!="Y"||this.BXIM.messenger.message[r.MESSAGE.id])return;this.readMessage(r.MESSAGE.recipientId,false,false);M.USERS_MESSAGE[r.MESSAGE.recipientId]=[r.MESSAGE.id];this.updateStateVar(M);s.MessengerCommon.recentListAdd({userId:r.MESSAGE.recipientId,id:r.MESSAGE.id,date:parseInt(r.MESSAGE.date)+parseInt(s.message("SERVER_TZ_OFFSET")),recipientId:r.MESSAGE.recipientId,senderId:r.MESSAGE.system=="Y"?0:r.MESSAGE.senderId,text:r.MESSAGE.text,userIsChat:t=="messageChat",params:r.MESSAGE.params},true)}else{M.UNREAD_MESSAGE={};M.UNREAD_MESSAGE[t=="messageChat"?r.MESSAGE.recipientId:r.MESSAGE.senderId]=[r.MESSAGE.id];M.USERS_MESSAGE[t=="messageChat"?r.MESSAGE.recipientId:r.MESSAGE.senderId]=[r.MESSAGE.id];

if(t=="message")this.endWriting(r.MESSAGE.senderId,0,false);else this.endWriting(r.MESSAGE.senderId,r.MESSAGE.recipientId,false);this.updateStateVar(M);s.MessengerCommon.recentListAdd({userId:t=="messageChat"?r.MESSAGE.recipientId:r.MESSAGE.senderId,id:r.MESSAGE.id,date:parseInt(r.MESSAGE.date)+parseInt(s.message("SERVER_TZ_OFFSET")),recipientId:r.MESSAGE.recipientId,senderId:r.MESSAGE.senderId,text:r.MESSAGE.text,userIsChat:t=="messageChat",params:r.MESSAGE.params},true)}s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80)}else if(t=="messageDeleteComplete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.message[r.id])return false;var m=0;if(r.type=="private"){m=r.fromUserId==this.BXIM.userId&&r.toUserId?r.toUserId:r.fromUserId;this.endWriting(m,0,false)}else{m="chat"+r.chatId;this.endWriting(r.senderId,m,false)}if(this.BXIM.messenger.currentTab==m&&s("im-message-"+r.id)){var u=s("im-message-"+r.id).parentNode.parentNode.parentNode.parentNode.parentNode;if(u.getAttribute("data-messageId")==u.getAttribute("data-blockMessageId")){s.remove(u)}else{u=s("im-message-"+r.id).parentNode;if(u.nextSibling&&s.hasClass(u.nextSibling,"bx-messenger-hr")){s.remove(u.nextSibling)}else if(!u.nextSibling&&s.hasClass(u.previousSibling,"bx-messenger-hr")){s.remove(u.previousSibling)}s.remove(u)}}this.recentListElementUpdate(m,r.id,r.text);if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();delete this.BXIM.messenger.message[r.id];this.BXIM.messenger.showMessage[m].sort(s.delegate(function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=parseInt(this.BXIM.messenger.message[e].date);var r=parseInt(this.BXIM.messenger.message[s].date);if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this))}else if(t=="messageUpdate"||t=="messageDelete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var f in this.sendBotCommandBlock){if(this.sendBotCommandBlock[f][r.id]){delete this.sendBotCommandBlock[f][r.id];var g=s("im-message-keyboard-"+r.id);if(g){var I=s.findChildrenByClassName(g,"bx-messenger-keyboard-button-block",false);for(var i=0;i<I.length;i++){s.removeClass(I[i],"bx-messenger-keyboard-button-progress");s.removeClass(I[i],"bx-messenger-keyboard-button-block")}}}}if(this.BXIM.messenger.message[r.id]){if(!this.BXIM.messenger.message[r.id].params)this.BXIM.messenger.message[r.id].params={};var m=0;if(t=="messageDelete"){r.text=s.message("IM_M_DELETED");if(!this.BXIM.messenger.message[r.id].params){this.BXIM.messenger.message[r.id].params={}}this.BXIM.messenger.message[r.id].params.IS_DELETED="Y"}else if(t=="messageUpdate"){this.BXIM.messenger.message[r.id].params=r.params}this.BXIM.messenger.message[r.id].text=r.text;if(r.type=="private"){m=r.fromUserId==this.BXIM.userId&&r.toUserId?r.toUserId:r.fromUserId;this.endWriting(m,0,false)}else{m="chat"+r.chatId;this.endWriting(r.senderId,m,false)}this.recentListElementUpdate(m,r.id,r.text);if(this.BXIM.messenger.currentTab==m&&s("im-message-"+r.id)){var B=s("im-message-"+r.id);s.addClass(B,t=="messageDelete"?"bx-messenger-message-edited bx-messenger-message-deleted":"");if(r.params&&r.params.IS_EDITED=="Y"){s.addClass(B,"bx-messenger-message-edited")}var X=false;if(t=="messageDelete"){var E=s("im-message-keyboard-"+r.id);s.remove(E)}else if(t=="messageUpdate"){if(r.params){if(r.params.DATE_TEXT){var C=this.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true);for(var i=0;i<r.params.DATE_TEXT.length;i++){C=C.split(r.params.DATE_TEXT[i]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+r.id+'" data-ts="'+r.params.DATE_TS[i]+'">'+r.params.DATE_TEXT[i]+"</span>")}B.innerHTML=C;X=true}if(r.params.ATTACH){var b=s.MessengerCommon.drawAttach(r.id,this.BXIM.messenger.message[r.id].chatId,r.params.ATTACH);if(B.nextElementSibling&&s.hasClass(B.nextElementSibling,"bx-messenger-attach-box")){B.nextElementSibling.innerHTML="";if(b.length>0){s.adjust(B.nextElementSibling,{children:b})}}else if(b.length>0){b=s.create("div",{props:{className:"bx-messenger-attach-box"},children:b});if(B.nextElementSibling){B.parentNode.insertBefore(b,B.nextElementSibling)}else{B.parentNode.appendChild(b)}}}if(r.params.KEYBOARD){var g=s("im-message-keyboard-"+r.id);var S=s.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,r.id,r.params.KEYBOARD);if(g){g.innerHTML=S?S.innerHTML:""}}}else if(typeof r.params!="undefined"&&r.params==""){if(s.hasClass(B.nextElementSibling,"bx-messenger-attach-box")){s.remove(B.nextElementSibling)}}}if(!X){B.innerHTML=s.MessengerCommon.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true)}s.addClass(B,"bx-messenger-message-edited-anim");if(B.nextSibling&&s.hasClass(B.nextSibling,"bx-messenger-file-box")){s.addClass(B.nextSibling,"bx-messenger-file-box-with-message")}setTimeout(s.delegate(function(){s.removeClass(B,"bx-messenger-message-edited-anim")},this),1e3)}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw()}}else if(t=="messageParamsUpdate"){if(this.MobileActionNotEqual("DIALOG"))return false;if(!this.BXIM.messenger.message[r.id])return false;if(this.BXIM.messenger.message[r.id].params&&this.BXIM.messenger.message[r.id].params.IS_DELETED=="Y")return false;var _=typeof r.animation=="undefined"?null:r.animation;for(var f in this.sendBotCommandBlock){if(this.sendBotCommandBlock[f][r.id]){delete this.sendBotCommandBlock[f][r.id];var g=s("im-message-keyboard-"+r.id);if(g){var I=s.findChildrenByClassName(g,"bx-messenger-keyboard-button-block",false);for(var i=0;i<I.length;i++){s.removeClass(I[i],"bx-messenger-keyboard-button-progress");s.removeClass(I[i],"bx-messenger-keyboard-button-block")}}}}this.BXIM.messenger.message[r.id].params=r.params;if(r.type=="private"){m=r.fromUserId==this.BXIM.userId?r.toUserId:r.fromUserId}else{m="chat"+r.chatId}var B=s("im-message-"+r.id);if(this.BXIM.messenger.currentTab==m&&B){var T=B.parentNode.parentNode.parentNode.parentNode.parentNode;if(r.params){if(r.params.DATE_TEXT){var C=this.prepareText(this.BXIM.messenger.message[r.id].text,false,true,true);for(var i=0;i<r.params.DATE_TEXT.length;i++){C=C.split(r.params.DATE_TEXT[i]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+r.id+'" data-ts="'+r.params.DATE_TS[i]+'">'+r.params.DATE_TEXT[i]+"</span>")}B.innerHTML=C}if(r.params.FILE_ID){var A=s.MessengerCommon.diskDrawFiles(this.BXIM.messenger.message[r.id].chatId,r.params.FILE_ID);if(B.nextElementSibling&&s.hasClass(B.nextElementSibling,"bx-messenger-file-box")){B.nextElementSibling.innerHTML="";if(A.length>0){s.adjust(B.nextElementSibling,{children:A})}}else if(A.length>0){A=s.create("div",{props:{className:"bx-messenger-file-box"+(r.text!=""?" bx-messenger-file-box-with-message":"")},children:A});if(B.nextElementSibling){B.parentNode.insertBefore(A,B.nextElementSibling)}else{B.parentNode.appendChild(A)}}if(B.nextSibling&&s.hasClass(B.nextSibling,"bx-messenger-file-box")){s.addClass(B.nextSibling,"bx-messenger-file-box-with-message")}}if(r.params.ATTACH){var b=s.MessengerCommon.drawAttach(r.id,this.BXIM.messenger.message[r.id].chatId,r.params.ATTACH);if(B.nextElementSibling&&s.hasClass(B.nextElementSibling,"bx-messenger-attach-box")){B.nextElementSibling.innerHTML="";if(b.length>0){s.adjust(B.nextElementSibling,{children:b})}}else if(b.length>0){b=s.create("div",{props:{className:"bx-messenger-attach-box"},children:b});if(B.nextElementSibling){B.parentNode.insertBefore(b,B.nextElementSibling)}else{B.parentNode.appendChild(b)}}if(_!="N"){_="Y"}}if(r.params.KEYBOARD){var g=s("im-message-keyboard-"+r.id);var S=s.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,r.id,r.params.KEYBOARD);if(g){g.innerHTML=S?S.innerHTML:""}if(_!="N"){_="Y"}}if(r.params&&r.params.IS_EDITED=="Y"){s.addClass(B,"bx-messenger-message-edited");if(_!="N"){_="Y"}}}else if(typeof r.params!="undefined"&&r.params==""){if(B.nextElementSibling&&s.hasClass(B.nextElementSibling,"bx-messenger-attach-box")){s.remove(B.nextElementSibling);if(_!="N"){_="Y"}}}if(r.params&&r.params.CLASS){var v=s.findParent(B,{className:"bx-messenger-content-item"});s.addClass(v,r.params.CLASS)}if(r.params&&r.params.IS_DELIVERED){if(r.params.IS_DELIVERED=="N"){this.drawProgessMessage(r.id)}else{this.clearProgessMessage(r.id)}}if(r.params&&r.params.SENDING){if(r.params.SENDING=="Y"){this.drawProgessMessage(r.id)}else{this.clearProgessMessage(r.id)}}if(r.params.IMOL_SID&&parseInt(r.params.IMOL_SID)>0){var R=s.findChildByClassName(T,"bx-messenger-message-extra");if(!R){T.insertBefore(s.create("div",{props:{className:"bx-messenger-message-extra"},html:s.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",r.params.IMOL_SID)}),T.firstChild);if(this.isElementVisibleOnScreen(T,BXIM.messenger.popupMessengerBody)){this.linesBodyScroll()}}}if(r.params.IMOL_FORM&&this.BXIM.messenger.chat[r.chatId]&&this.BXIM.messenger.chat[r.chatId].type=="livechat"){var L=r.params.IMOL_FORM.toString().substr(-6)=="-delay";var y=L?r.params.IMOL_FORM.substr(0,r.params.IMOL_FORM.lastIndexOf("-delay")):r.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<r.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=y){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=r.id;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(y)},this),L?3e4:5e3)}}if(r.params.IMOL_VOTE&&B){var x=this.linesVoteDraw(r.id);if(x){s.cleanNode(B);B.appendChild(x)}if(_!="N"){_="Y"}}else if(typeof r.params.IMOL_VOTE_SID!="undefined"&&B){var N=s.findChildByClassName(B,"bx-messenger-content-item-vote-message-text");if(N){var x=this.linesVoteResultDraw(r.id,N.innerHTML);if(x){s.cleanNode(B);B.appendChild(x)}}}if(_=="Y"){s.addClass(B,"bx-messenger-message-edited-anim");setTimeout(s.delegate(function(){s.removeClass(B,"bx-messenger-message-edited-anim")},this),1e3)}}}else if(t=="messageLike"){if(this.MobileActionNotEqual("DIALOG"))return false;var w=s.util.in_array(this.BXIM.userId,r.users);var D=r.users.length>0?r.users.length:"";if(!this.BXIM.messenger.message[r.id]){return false}if(typeof this.BXIM.messenger.message[r.id].params!="object"){this.BXIM.messenger.message[r.id].params={}}this.BXIM.messenger.message[r.id].params.LIKE=r.users;if(s("im-message-"+r.id)){var O=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.id+""}},false);if(O){var k=s.findChildByClassName(O,"bx-messenger-content-item-like");if(k){var U=s.findChildByClassName(k,"bx-messenger-content-like-digit",false);var P=s.findChildByClassName(k,"bx-messenger-content-like-button",false);if(w){s.addClass(k,"bx-messenger-content-item-liked")}else{s.removeClass(k,"bx-messenger-content-item-liked")}if(D>0){U.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(U,"bx-messenger-content-like-digit-off")}else{U.setAttribute("title","");s.addClass(U,"bx-messenger-content-like-digit-off")}if(U.innerHTML<D){s.addClass(O.firstChild,"bx-messenger-content-item-plus-like");setTimeout(function(){s.removeClass(O.firstChild,"bx-messenger-content-item-plus-like")},500)}U.innerHTML=D}}}}else if(t=="fileUpload"){if(this.MobileActionNotEqual("DIALOG"))return false;if(this.BXIM.disk.filesProgress[r.fileTmpId])return false;if(this.BXIM.disk.files[r.fileChatId]&&this.BXIM.disk.files[r.fileChatId][r.fileId]){r.fileParams["preview"]=this.BXIM.disk.files[r.fileChatId][r.fileId]["preview"]}if(!this.BXIM.disk.files[r.fileChatId])this.BXIM.disk.files[r.fileChatId]={};this.BXIM.disk.files[r.fileChatId][r.fileId]=r.fileParams;this.diskRedrawFile(r.fileChatId,r.fileId);if(this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else if(this.BXIM.messenger.popupMessengerBody){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}else if(t=="fileUnRegister"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var G in r.files){if(this.BXIM.disk.filesRegister[r.chatId]){delete this.BXIM.disk.filesRegister[r.chatId][r.files[G]]}if(this.BXIM.disk.files[r.chatId]&&this.BXIM.disk.files[r.chatId][r.files[G]]){this.BXIM.disk.files[r.chatId][r.files[G]].status="error";s.MessengerCommon.diskRedrawFile(r.chatId,r.files[G])}delete this.BXIM.disk.filesProgress[G]}this.drawTab(this.getRecipientByChatId(r.chatId))}else if(t=="fileDelete"){if(this.MobileActionNotEqual("DIALOG"))return false;delete this.BXIM.disk.files[r.chatId][r.fileId];this.drawTab(this.getRecipientByChatId(r.chatId))}else if(t=="chatRename"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId].name=r.chatTitle;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatAvatar"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.BXIM.messenger.updateChatAvatar(r.chatId,r.chatAvatar)}else if(t=="chatChangeColor"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId].color=r.chatColor;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatHide"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;var H=this.BXIM.messenger.currentTab=="chat"+r.chatId;this.recentListHide("chat"+r.chatId,false);if(!this.isMobile()&&H){s.MessengerCommon.dialogCloseCurrent()}}else if(t=="chatUserAdd"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var i in r.users)this.BXIM.messenger.users[i]=r.users[i];if(!this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId]={id:r.chatId,name:r.chatId,owner:r.chatOwner,extranet:r.chatExtranet,fake:true}}else{this.BXIM.messenger.chat[r.chatId].extranet=r.chatExtranet;if(this.BXIM.messenger.userInChat[r.chatId]){for(i=0;i<r.newUsers.length;i++)this.BXIM.messenger.userInChat[r.chatId].push(r.newUsers[i])}else this.BXIM.messenger.userInChat[r.chatId]=r.newUsers;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatUserLeave"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(r.userId==this.BXIM.userId){this.readMessage("chat"+r.chatId,true,false,true);this.leaveFromChat(r.chatId,false);if(r.message.length>0)this.BXIM.openConfirm({title:s.util.htmlspecialchars(r.chatTitle),message:r.message})}else if(this.MobileActionEqual("DIALOG")){if(!this.BXIM.messenger.chat[r.chatId]||!this.BXIM.messenger.userInChat[r.chatId])return false;var F=[];for(var i=0;i<this.BXIM.messenger.userInChat[r.chatId].length;i++)if(this.BXIM.messenger.userInChat[r.chatId][i]!=r.userId)F.push(this.BXIM.messenger.userInChat[r.chatId][i]);this.BXIM.messenger.userInChat[r.chatId]=F;this.BXIM.messenger.redrawChatHeader()}}else if(t=="massDeleteMessage"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.notify.skipMassDelete){return true}for(var i in r.MESSAGE){if(r.MESSAGE[i]>0){delete this.BXIM.notify.notify[i];delete this.BXIM.notify.flashNotify[i];delete this.BXIM.notify.unreadNotify[i]}}this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(t=="notify"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.lastRecordId>=r.id)return false;r.date=parseInt(r.date)+parseInt(s.message("USER_TZ_OFFSET"));var M={};M.UNREAD_NOTIFY={};M.UNREAD_NOTIFY[r.id]=[r.id];this.BXIM.messenger.notify.notify[r.id]=r;this.BXIM.messenger.notify.flashNotify[r.id]=r.silent!="Y";if(r.settingName=="im|like"&&r.original_tag.substr(0,10)=="RATING|IM|"){var j=r.original_tag.split("|");if(this.BXIM.messenger.message[j[4]]&&this.BXIM.messenger.message[j[4]].recipientId==this.BXIM.messenger.currentTab&&this.BXIM.windowFocus){delete M.UNREAD_NOTIFY[r.id];this.BXIM.notify.flashNotify[r.id]=false;this.BXIM.notify.viewNotify(r.id)}}if(r.silent=="N")this.BXIM.notify.changeUnreadNotify(M.UNREAD_NOTIFY);s.localStorage.set("mfn",this.BXIM.notify.flashNotify,80);this.BXIM.lastRecordId=r.id}else if(t=="readNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;this.BXIM.notify.initNotifyCount=0;r.lastId=parseInt(r.lastId);for(var i in this.BXIM.notify.unreadNotify){var V=this.BXIM.notify.notify[this.BXIM.notify.unreadNotify[i]];if(V&&V.type!=1&&V.id<=r.lastId){delete this.BXIM.notify.unreadNotify[i]}}this.BXIM.notify.updateNotifyCount(false)}else if(t=="confirmNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;var W=parseInt(r.id);if(this.BXIM.notify.notify[W]){if(this.isMobile()){delete this.BXIM.notify.notify[W]}else{this.BXIM.notify.notify[W].confirmMessages=r.messages}}delete this.BXIM.notify.unreadNotify[W];delete this.BXIM.notify.flashNotify[W];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(t=="readNotifyOne"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.notify.unreadNotify[r.id]){this.BXIM.notify.viewNotify(r.id,true,false)}}else if(t=="unreadNotifyOne"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(!this.BXIM.notify.unreadNotify[r.id]){this.BXIM.notify.viewNotify(r.id,false,false)}}else if(t=="deleteCommand"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var i=0;i<this.BXIM.messenger.command.length;i++){if(!this.BXIM.messenger.command[i]||this.BXIM.messenger.command[i].id!=r.commandId){continue}delete this.BXIM.messenger.command[i];if(this.commandPopup!=null){this.commandPopup.destroy()}break}}else if(t=="deleteTextareaIcon"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var i=0;i<this.BXIM.messenger.textareaIcon.length;i++){if(!this.BXIM.messenger.textareaIcon[i]||this.BXIM.messenger.textareaIcon[i].id!=r.iconId){continue}delete this.BXIM.messenger.textareaIcon[i];if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}var O=s.findChildByClassName(this.BXIM.messenger.popupMessengerTextareaIconBox,"bx-messenger-textarea-icon-marketplace-"+r.iconId,true);if(O){s.remove(O)}break}}else if(t=="updateTextareaIcon"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var i=0;i<this.BXIM.messenger.textareaIcon.length;i++){if(!this.BXIM.messenger.textareaIcon[i]||this.BXIM.messenger.textareaIcon[i].id!=r.iconId){continue}if(r.context){this.BXIM.messenger.textareaIcon[i].context=r.context}if(r.js){this.BXIM.messenger.textareaIcon[i].js=r.js}if(r.iframe){this.BXIM.messenger.textareaIcon[i].iframe=r.iframe}if(r.iframeWidth){this.BXIM.messenger.textareaIcon[i].iframeWidth=r.iframeWidth}if(r.iframeHeight){this.BXIM.messenger.textareaIcon[i].iframeHeight=r.iframeHeight}if(r.userId!=this.BXIM.userId&&this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}break}}},this);var r=s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command}if(e=="user_online"){if(this.BXIM.messenger.users[t.USER_ID]){var r=false;if(typeof this.BXIM.messenger.users[t.USER_ID].idle=="undefined"){this.BXIM.messenger.users[t.USER_ID].idle=0}if(this.BXIM.messenger.users[t.USER_ID].idle!=0){this.BXIM.messenger.users[t.USER_ID].idle=0;r=true}if(typeof t.STATUS!="undefined"){if(this.BXIM.messenger.users[t.USER_ID].status!=t.STATUS){if(!this.isMobile()&&this.BXIM.messenger.users[t.USER_ID].status=="offline"&&t.STATUS!="offline"){if(this.BXIM.messenger.getTrackStatus(t.USER_ID)){var i=this.getUserParam(t.USER_ID);this.BXIM.messenger.showNotifyBlock({senderId:t.USER_ID,recipientId:this.BXIM.userId,text:s.message("IM_M_ST_ONLINE_"+(i.gender=="F"?"F":"M")+(this.BXIM.bitrixIntranet?"_B24":""))})}}this.BXIM.messenger.users[t.USER_ID].status=t.STATUS;r=true}}if(typeof t.MOBILE_LAST_DATE!="undefined"){if(this.BXIM.messenger.users[t.USER_ID].mobileLastDate!=t.MOBILE_LAST_DATE){this.BXIM.messenger.users[t.USER_ID].mobileLastDate=t.MOBILE_LAST_DATE;r=true}}if(r){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.recentListIndex.indexOf(t.USER_ID.toString())>=0){this.userListRedraw()}}}}else if(e=="user_offline"){if(this.BXIM.messenger.users[t.USER_ID]&&this.BXIM.messenger.users[t.USER_ID].status!="offline"){this.BXIM.messenger.users[t.USER_ID].status="offline";this.BXIM.messenger.users[t.USER_ID].idle=0;this.BXIM.messenger.users[t.USER_ID].mobileLastDate=0;this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.recentListIndex.indexOf(t.USER_ID.toString())>=0){this.userListRedraw()}}}else if(e=="user_status"){if(this.BXIM.messenger.users[t.USER_ID]){var r=false;if(typeof t.IDLE!="undefined"){if(typeof this.BXIM.messenger.users[t.USER_ID].idle=="undefined"){this.BXIM.messenger.users[t.USER_ID].idle=0}if(this.BXIM.messenger.users[t.USER_ID].idle!=t.IDLE){this.BXIM.messenger.users[t.USER_ID].idle=t.IDLE;r=true}}if(typeof t.MOBILE_LAST_DATE!="undefined"){if(typeof this.BXIM.messenger.users[t.USER_ID].mobileLastDate=="undefined"){this.BXIM.messenger.users[t.USER_ID].mobileLastDate=0}if(this.BXIM.messenger.users[t.USER_ID].mobileLastDate!=t.MOBILE_LAST_DATE){this.BXIM.messenger.users[t.USER_ID].mobileLastDate=t.MOBILE_LAST_DATE;r=true}}if(typeof t.STATUS!="undefined"){if(this.BXIM.messenger.users[t.USER_ID].status!=t.STATUS){this.BXIM.messenger.users[t.USER_ID].status=t.STATUS;r=true}}if(typeof t.COLOR!="undefined"){if(this.BXIM.messenger.users[t.USER_ID]&&this.BXIM.messenger.users[t.USER_ID].color!=t.COLOR&&t.COLOR!=""){this.BXIM.messenger.users[t.USER_ID].color=t.COLOR;r=true}}if(r){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.recentListIndex.indexOf(t.USER_ID.toString())>=0){this.userListRedraw()}}}}else if(e=="online_list"){var r=false;var n=false;for(var a in this.BXIM.messenger.users){if(typeof t.USERS[a]=="undefined"){if(this.BXIM.messenger.users[a].status!="offline"){this.BXIM.messenger.users[a].status="offline";this.BXIM.messenger.users[a].idle=0;this.BXIM.messenger.users[a].mobileLastDate=0;n=true;if(this.BXIM.messenger.recentListIndex.indexOf(a.toString())>=0){r=true}}}else{if(typeof t.USERS[a].idle!="undefined"){if(typeof this.BXIM.messenger.users[a].idle=="undefined"){this.BXIM.messenger.users[a].idle=0}if(this.BXIM.messenger.users[a].idle!=t.USERS[a].idle){this.BXIM.messenger.users[a].idle=t.USERS[a].idle;n=true;if(this.BXIM.messenger.recentListIndex.indexOf(a.toString())>=0){r=true}}}if(typeof t.USERS[a].mobileLastDate!="undefined"){if(typeof this.BXIM.messenger.users[a].mobileLastDate=="undefined"){this.BXIM.messenger.users[a].mobileLastDate=0}if(this.BXIM.messenger.users[a].mobileLastDate!=t.USERS[a].mobileLastDate){this.BXIM.messenger.users[a].mobileLastDate=t.USERS[a].mobileLastDate;n=true;if(this.BXIM.messenger.recentListIndex.indexOf(a.toString())>=0){r=true}}}if(typeof t.USERS[a].status!="undefined"){if(this.BXIM.messenger.users[a].status!=t.USERS[a].status){this.BXIM.messenger.users[a].status=t.USERS[a].status;n=true;if(this.BXIM.messenger.recentListIndex.indexOf(a.toString())>=0){r=true}}}}}if(r){s.MessengerCommon.userListRedraw()}if(n){this.BXIM.messenger.dialogStatusRedraw()}}},this);var i=s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command}if(e=="linesAnswer"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[t.chatId])return false;this.BXIM.messenger.chat[t.chatId].owner=this.BXIM.userId;this.BXIM.messenger.redrawChatHeader();if(this.BXIM.messenger.popupMessengerTextarea){this.BXIM.messenger.popupMessengerTextarea.focus()}}else if(e=="updateChat"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[t.chatId]){this.BXIM.messenger.chat[t.chatId][t.fieldName]=t.fieldValue;if(this.BXIM.messenger.currentTab.toString().substr(4)==t.chatId){this.BXIM.messenger.redrawChatHeader();if(this.isMobile()){this.BXIM.messenger.dialogStatusRedraw()}}if(this.BXIM.messenger.chat[t.chatId].type=="livechat"&&t.fieldName=="entity_data_1"){var r=this.livechatGetSession(t.chatId);r.readedTime=parseInt(r.readedTime)+parseInt(s.message("USER_TZ_OFFSET"));this.drawReadMessage("chat"+t.chatId,r.readedId,r.readedTime);if(r.showForm=="N"){if(!this.BXIM.messenger.popupMessengerLiveChatLastSend||this.BXIM.messenger.popupMessengerLiveChatLastSend+1e3<+new Date){this.BXIM.messenger.linesLivechatFormHide()}}}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)){this.recentListRedraw()}}}else if(e=="queueItemUpdate"){if(typeof this.BXIM.messenger.openlines=="undefined"){this.BXIM.messenger.openlines.queue=[t]}else{var i=true;for(var n=0,a=this.BXIM.messenger.openlines.queue.length;n<a;n++){if(this.BXIM.messenger.openlines.queue[n].ID==t.ID){this.BXIM.messenger.openlines.queue[n].NAME=t.NAME;i=false;break}}if(i){this.BXIM.messenger.openlines.queue.push(t)}}}else if(e=="queueItemDelete"){if(typeof this.BXIM.messenger.openlines=="undefined"||this.BXIM.messenger.openlines.queue.length<=0)return true;var o=[];for(var n=0,a=this.BXIM.messenger.openlines.queue.length;n<a;n++){if(this.BXIM.messenger.openlines.queue[n].ID!=t.ID){o.push(this.BXIM.messenger.openlines.queue[n])}}this.BXIM.messenger.openlines.queue=o}},this);if(this.isMobile()){console.warn("MOBILE!");BXMobileApp.addCustomEvent("onPull-im",s.delegate(function(e){console.log(e);var s=e.data;if(typeof s=="undefined"){t(e["command"],e["params"])}else{for(var r=0;r<s.length;r++){t(s[r]["command"],s[r]["params"])}}},this));BXMobileApp.addCustomEvent("onPullOnline",r);BXMobileApp.addCustomEvent("onPull-imopenlines",i)}else{s.addCustomEvent("onPullOnlineEvent",r);s.addCustomEvent("onPullEvent-im",t);s.addCustomEvent("onPullEvent-imopenlines",i)}};s.MessengerCommon.prototype.updateStateVar=function(e,t,r){r=r!==false;if(typeof e.CHAT!="undefined"){for(var i in e.CHAT){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)e.CHAT[i].fake=true;else if(!this.BXIM.messenger.chat[i])e.CHAT[i].fake=true;this.BXIM.messenger.chat[i]=e.CHAT[i]}}if(typeof e.USER_IN_CHAT!="undefined"){for(var i in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=e.USER_IN_CHAT[i]}}if(typeof e.USER_BLOCK_CHAT!="undefined"){for(var i in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=e.USER_BLOCK_CHAT[i]}}if(typeof e.USERS!="undefined"){for(var i in e.USERS){this.BXIM.messenger.users[i]=e.USERS[i]}}if(typeof e.USER_IN_GROUP!="undefined"){for(var i in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=e.USER_IN_GROUP[i]}else{for(var n=0;n<e.USER_IN_GROUP[i].users.length;n++)this.BXIM.messenger.userInGroup[i].users.push(e.USER_IN_GROUP[i].users[n]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}}if(typeof e.WO_USER_IN_GROUP!="undefined"){for(var i in e.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[i]=="undefined"){this.BXIM.messenger.woUserInGroup[i]=e.WO_USER_IN_GROUP[i]}else{for(var n=0;n<e.WO_USER_IN_GROUP[i].users.length;n++)this.BXIM.messenger.woUserInGroup[i].users.push(e.WO_USER_IN_GROUP[i].users[n]);this.BXIM.messenger.woUserInGroup[i].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[i].users)}}}if(typeof e.MESSAGE!="undefined"){for(var i in e.MESSAGE){this.BXIM.messenger.message[i]=e.MESSAGE[i];this.BXIM.lastRecordId=parseInt(i)>this.BXIM.lastRecordId?parseInt(i):this.BXIM.lastRecordId}}this.changeUnreadMessage(e.UNREAD_MESSAGE,t);if(typeof e.USERS_MESSAGE!="undefined"){for(var i in e.USERS_MESSAGE){e.USERS_MESSAGE[i].sort(s.delegate(function(e,s){e=parseInt(e);s=parseInt(s);if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=parseInt(this.BXIM.messenger.message[e].date);var r=parseInt(this.BXIM.messenger.message[s].date);if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));if(!this.BXIM.messenger.showMessage[i])this.BXIM.messenger.showMessage[i]=e.USERS_MESSAGE[i];for(var n=0;n<e.USERS_MESSAGE[i].length;n++){if(!s.util.in_array(e.USERS_MESSAGE[i][n],this.BXIM.messenger.showMessage[i])){this.BXIM.messenger.showMessage[i].push(e.USERS_MESSAGE[i][n]);if(this.BXIM.messenger.history[i])this.BXIM.messenger.history[i]=s.util.array_merge(this.BXIM.messenger.history[i],e.USERS_MESSAGE[i]);else this.BXIM.messenger.history[i]=e.USERS_MESSAGE[i];if(r&&this.BXIM.messenger.currentTab==i&&this.MobileActionEqual("DIALOG"))this.drawMessage(i,this.BXIM.messenger.message[e.USERS_MESSAGE[i][n]])}}}}};s.MessengerCommon.prototype.changeUnreadMessage=function(e,t){t=t!=false;var r=false;var i=false;var n=true;var a=this.isMobile()?"online":this.BXIM.settings.status;for(var o in e){if(o.toString().substr(0,4)=="chat"){if(!s.MessengerCommon.userInChat(o.toString().substr(4))){continue}}var l=false;if(this.BXIM.xmppStatus&&o.toString().substr(0,4)!="chat"){if(!(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o&&this.BXIM.isFocus())){i=true;if(this.BXIM.messenger.unreadMessage[o])this.BXIM.messenger.unreadMessage[o]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[o],e[o]));else this.BXIM.messenger.unreadMessage[o]=e[o]}l=true}if(!l){if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o&&this.BXIM.isFocus()){if(typeof this.BXIM.messenger.flashMessage[o]=="undefined")this.BXIM.messenger.flashMessage[o]={};for(var m=0;m<e[o].length;m++){if(this.BXIM.isFocus())this.BXIM.messenger.flashMessage[o][e[o][m]]=false;if(this.BXIM.messenger.message[e[o][m]]&&this.BXIM.messenger.message[e[o][m]].senderId==this.BXIM.messenger.currentTab)r=true}this.readMessage(o,true,true,true)}else if(this.isMobile()&&this.BXIM.messenger.currentTab==o){var h=this.BXIM.messenger.currentTab;this.BXIM.isFocusMobile(s.delegate(function(e){if(e){s.MessengerCommon.readMessage(h,true,true,true)}},this));if(this.BXIM.messenger.unreadMessage[h])this.BXIM.messenger.unreadMessage[h]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[h],e[h]));else this.BXIM.messenger.unreadMessage[h]=e[h]}else{i=true;if(typeof this.BXIM.messenger.flashMessage[o]=="undefined"){this.BXIM.messenger.flashMessage[o]={};var g=o.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[o.toString().substr(4)]&&this.BXIM.messenger.chat[o.toString().substr(4)].type=="lines";for(var m=0;m<e[o].length;m++){if(g&&this.BXIM.messenger.unreadMessage[o]&&this.BXIM.messenger.unreadMessage[o].length>0){var I=this.BXIM.messenger.message[e[o][m]].senderId;if(I==0||this.BXIM.messenger.users[I].extranet){this.BXIM.messenger.flashMessage[o][e[o][m]]=false;continue}}var p=this.BXIM.messenger.message[e[o][m]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(a!="dnd"||p){this.BXIM.messenger.flashMessage[o][e[o][m]]=t}}}else{var g=o.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[o.toString().substr(4)]&&this.BXIM.messenger.chat[o.toString().substr(4)].type=="lines";for(var m=0;m<e[o].length;m++){var p=this.BXIM.messenger.message[e[o][m]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));

if(a!="dnd"||p){if(!t&&!this.BXIM.isFocus()){this.BXIM.messenger.flashMessage[o][e[o][m]]=false}else{if(g&&this.BXIM.messenger.unreadMessage[o]&&this.BXIM.messenger.unreadMessage[o].length>0){var I=this.BXIM.messenger.message[e[o][m]].senderId;if(I==0||this.BXIM.messenger.users[I].extranet){this.BXIM.messenger.flashMessage[o][e[o][m]]=false;continue}}if(typeof this.BXIM.messenger.flashMessage[o][e[o][m]]=="undefined"){this.BXIM.messenger.flashMessage[o][e[o][m]]=true}}}}}if(this.BXIM.messenger.unreadMessage[o])this.BXIM.messenger.unreadMessage[o]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[o],e[o]));else this.BXIM.messenger.unreadMessage[o]=e[o]}}var M=false;for(var m=0;m<e[o].length;m++){if(!M||M.SEND_DATE<=parseInt(this.BXIM.messenger.message[e[o][m]].date)+parseInt(s.message("SERVER_TZ_OFFSET"))){M={ID:this.BXIM.messenger.message[e[o][m]].id,SEND_DATE:parseInt(this.BXIM.messenger.message[e[o][m]].date)+parseInt(s.message("SERVER_TZ_OFFSET")),RECIPIENT_ID:this.BXIM.messenger.message[e[o][m]].recipientId,SENDER_ID:this.BXIM.messenger.message[e[o][m]].senderId,USER_ID:this.BXIM.messenger.message[e[o][m]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[e[o][m]].text,PARAMS:this.BXIM.messenger.message[e[o][m]].params}}}if(M){this.recentListAdd({userId:M.RECIPIENT_ID.toString().substr(0,4)=="chat"?M.RECIPIENT_ID:M.USER_ID,id:M.ID,date:M.SEND_DATE,recipientId:M.RECIPIENT_ID,senderId:M.SENDER_ID,text:M.SEND_MESSAGE,params:M.PARAMS,userIsChat:M.RECIPIENT_ID.toString().substr(0,4)=="chat",skipRedraw:true},true);i=true}if(this.MobileActionEqual("DIALOG")&&this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==o){n=true}}if(n){this.BXIM.messenger.dialogStatusRedraw(this.isMobile()?{type:1,slidingPanelRedrawDisable:true,userRedraw:false}:{userRedraw:false})}if(this.MobileActionEqual("RECENT")&&this.BXIM.messenger.popupMessenger!=null&&!this.BXIM.messenger.recentList&&i)s.MessengerCommon.userListRedraw();if(this.isMobile()&&this.MobileActionEqual("RECENT")&&app.enableInVersion(13)){clearTimeout(this.newMessageTimeout);this.newMessageTimeout=setTimeout(s.proxy(function(){this.BXIM.messenger.newMessage()},this),1e3)}else if(!this.isMobile()){this.BXIM.messenger.newMessage(t);this.BXIM.messenger.updateMessageCount(t);if(t&&r&&a!="dnd"){this.BXIM.playSound("newMessage2")}}};s.MessengerCommon.prototype.redrawDateMarks=function(){if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;if(typeof this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName=="undefined")return false;var e={};var t=this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName("bx-messenger-content-group");var r=this.BXIM.messenger.popupMessengerBody.getBoundingClientRect().top;for(var i=0;i<t.length;i++){e=s.MessengerCommon.isElementCoordsBelow(t[i],this.BXIM.messenger.popupMessengerBody,33,true);if(t[i].className!="bx-messenger-content-group bx-messenger-content-group-today"){t[i].className="bx-messenger-content-group "+(e.top?"":"bx-messenger-content-group-float");t[i].firstChild.nextSibling.style.marginLeft=e.top?"":Math.round(t[i].offsetWidth/2-t[i].firstChild.nextSibling.offsetWidth/2)+"px";t[i].firstChild.nextSibling.style.marginTop=e.top?"":-e.coords.top+14+"px"}if(!e.top&&t[i-1]){t[i-1].className="bx-messenger-content-group";t[i-1].firstChild.nextSibling.style.marginLeft="";t[i-1].firstChild.nextSibling.style.marginTop=""}}};s.MessengerCommon.prototype.unreadMessage=function(e){if(!this.BXIM.messenger.message[e]){return false}var t=this.BXIM.messenger.message[e];var r="";if(t.recipientId.toString().substr(0,4)=="chat"){r=t.recipientId}else{r=t.senderId}showMessage=this.BXIM.messenger.showMessage[r];showMessage.sort(function(e,s){if(e<s){return-1}else if(e>s){return 1}else{return 0}});var i=0;this.BXIM.messenger.unreadMessage[r]=[];for(var n=0;n<showMessage.length;n++){if(showMessage[n]>=e){if(!this.BXIM.messenger.unreadMessage[r])this.BXIM.messenger.unreadMessage[r]=[];this.BXIM.messenger.unreadMessage[r].push(showMessage[n])}else{i=showMessage[n]}}this.skipReadMessage=true;this.drawTab();this.userListRedraw();setTimeout(s.delegate(function(){this.skipReadMessage=false},this),1e3);var a=s.ajax({url:this.BXIM.pathToAjax+"?UNREAD_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:{IM_UNREAD_MESSAGE:"Y",USER_ID:r,LAST_ID:i,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})};s.MessengerCommon.prototype.readMessage=function(t,r,i,n){if(!t||this.skipReadMessage)return false;n=n==true;if(!n&&(!this.BXIM.messenger.unreadMessage[t]||this.BXIM.messenger.unreadMessage[t].length<=0))return false;if(!n&&t.toString().substring(0,4)=="chat"){var a=t.toString().substring(4);if(this.BXIM.messenger.chat[a].type=="lines"&&this.BXIM.messenger.chat[a].owner==0){return false}}r=r!=false;i=i!==false;var o={};for(var l in this.BXIM.messenger.unreadMessage){if(t==l)continue;o[l]=true}if(this.BXIM.messenger.recentListExternal){var m=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-status-new-message");if(m!=null){for(var l=0;l<m.length;l++){var h=m[l].getAttribute("data-userId");if(!o[h]){m[l].firstChild.innerHTML="";s.removeClass(m[l],"bx-messenger-cl-status-new-message")}}}}if(this.BXIM.messenger.popupMessenger!=null){var m=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-status-new-message");if(m!=null){for(var l=0;l<m.length;l++){var h=m[l].getAttribute("data-userId");if(!o[h]){m[l].firstChild.innerHTML="";s.removeClass(m[l],"bx-messenger-cl-status-new-message")}}}m=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-new",false);if(m!=null)for(var l=0;l<m.length;l++)if(m[l].getAttribute("data-notifyType")!=1)s.removeClass(m[l],"bx-messenger-content-item-new")}var g=0;if(Math&&this.BXIM.messenger.unreadMessage[t])g=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[t]);if(this.BXIM.messenger.unreadMessage[t]){var I=s.clone(this.BXIM.messenger.unreadMessage[t]);delete this.BXIM.messenger.unreadMessage[t]}if(this.BXIM.messenger.flashMessage[t])delete this.BXIM.messenger.flashMessage[t];s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80);if(!this.isMobile()){this.BXIM.messenger.updateMessageCount(r);this.BXIM.updateCounter()}if(i){var p={IM_READ_MESSAGE:"Y",USER_ID:t,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()};if(parseInt(g)>0)p["LAST_ID"]=g;var M=s.ajax({url:this.BXIM.pathToAjax+"?READ_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:p,onsuccess:s.delegate(function(r){if(r){if(r.BITRIX_SESSID)s.message({bitrix_sessid:r.BITRIX_SESSID});if(r.ERROR==""){s.onCustomEvent(e,"onImMessageRead",[t])}else{this.BXIM.messenger.unreadMessage[t]=I;if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()){setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}}else{this.BXIM.messenger.unreadMessage[t]=I}},this),onfailure:s.delegate(function(){this.BXIM.messenger.unreadMessage[t]=I;this.BXIM.messenger.sendAjaxTry=0;try{if(typeof M=="object"&&M.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(r){}},this)})}if(r){s.localStorage.set("mrm",t,5);s.localStorage.set("mnnb",true,1)}};s.MessengerCommon.prototype.drawReadMessageChat=function(e,t){if(!this.BXIM.messenger.readedList[e]){return false}var r=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);var i=0;var n={};var a=0;var o=0;for(var l in this.BXIM.messenger.readedList[e]){if(l==this.BXIM.userId)continue;if(this.BXIM.messenger.message[r]&&this.BXIM.messenger.message[r].senderId==l)continue;if(this.BXIM.messenger.readedList[e][l].messageId>=r){if(!n[l]){n[l]={}}if(!o||o>this.BXIM.messenger.readedList[e][l].date){a=l;o=this.BXIM.messenger.readedList[e][l].date}n[l]=this.BXIM.messenger.readedList[e][l];i++}}if(i>0){this.BXIM.messenger.readedList[e]=n}else{this.BXIM.messenger.readedList[e]=false;var m=this.BXIM.messenger.popupMessengerBodyWrap?null:this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(m&&s.hasClass(m,"bx-messenger-content-item-notify")){if(!this.countWriting(e)){s.remove(m)}}return false}if(!this.countWriting(e)){var h=this.getUserParam(a);var g='<span title="'+this.formatDate(o)+'">'+h.name+"</span>";if(i>1){if(this.isMobile()){g=s.message("IM_M_READED_CHAT_MORE").replace("#USER#",g).replace("#LINK_START#","<b>").replace("#LINK_END#","</b>").replace("#COUNT#",i-1)}else{g=s.message("IM_M_READED_CHAT_MORE").replace("#USER#",g).replace("#LINK_START#",'<span class="bx-messenger-ajax" data-entity="readedList">').replace("#LINK_END#","</span>").replace("#COUNT#",i-1)}}t=t!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED_CHAT").replace("#USERS#",g),t)}};s.MessengerCommon.prototype.drawReadMessage=function(e,t,r,i){var n=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);if(n!=t||this.BXIM.messenger.message[n].senderId==e){this.BXIM.messenger.readedList[e]=false;return false}this.BXIM.messenger.readedList[e]={messageId:t,date:r};if(!this.countWriting(e)){i=i!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED").replace("#DATE#",this.formatDate(r)),i)}};s.MessengerCommon.prototype.drawNotifyMessage=function(e,t,r,i){if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab||typeof r=="undefined"||typeof t=="undefined"||e==0)return false;if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;var n=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(!n||s.hasClass(n,"bx-messenger-content-empty"))return false;var a=s.create("div",{attrs:{"data-type":"notify"},props:{className:"bx-messenger-content-item bx-messenger-content-item-notify"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},html:'<span class="bx-messenger-content-item-notify-icon-'+t+'"></span>'+this.prepareText(r,false,true,true)})]})]})]});var o=true;if(s.hasClass(n,"bx-messenger-content-item-notify")){o=false;s.remove(n)}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(a);i=i!=false;if(o&&this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.animationSupport&&i){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:1200,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}};s.MessengerCommon.prototype.loadHistory=function(e,t,r){t=typeof t=="undefined"?true:t;r=typeof r=="undefined"?false:r;if(!this.BXIM.messenger.historyEndOfList[e])this.BXIM.messenger.historyEndOfList[e]={};if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};if(this.BXIM.messenger.historyLoadFlag[e]&&this.BXIM.messenger.historyLoadFlag[e][t]){if(this.isMobile())app.pullDownLoadingStop();return}if(this.isMobile()){t=false}else{if(t){if(this.BXIM.messenger.historySearch!=""||this.BXIM.messenger.historyDateSearch!="")return;if(!(this.BXIM.messenger.popupHistoryItems.scrollTop>this.BXIM.messenger.popupHistoryItems.scrollHeight-this.BXIM.messenger.popupHistoryItems.offsetHeight-100))return}else{if(this.BXIM.messenger.popupMessengerBody.scrollTop>=5)return}}if(!this.BXIM.messenger.historyEndOfList[e]||!this.BXIM.messenger.historyEndOfList[e][t]){var i=[];if(t){i=s.findChildrenByClassName(this.BXIM.messenger.popupHistoryBodyWrap,"bx-messenger-history-item-text")}else{i=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-text-wrap")}if(!this.isMobile()&&i.length<20&&!r){return false}if(i.length>0)this.BXIM.messenger.historyOpenPage[e]=Math.floor(i.length/20)+1;else this.BXIM.messenger.historyOpenPage[e]=1;var n=null;if(!this.isMobile()&&!r){n=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});if(t){this.BXIM.messenger.popupHistoryBodyWrap.appendChild(n)}else{this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(n,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}else if(r){n=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});var a=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(a){a.innerHTML="";a.appendChild(n)}else{a=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history-empty");this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(n,a);s.remove(a)}}if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};this.BXIM.messenger.historyLoadFlag[e][t]=true;s.ajax({url:this.BXIM.pathToAjax+"?HISTORY_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_HISTORY_LOAD_MORE:"Y",USER_ID:e,PAGE_ID:this.BXIM.messenger.historyOpenPage[e],IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(n)s.remove(n);if(this.isMobile())app.pullDownLoadingStop();this.BXIM.messenger.historyLoadFlag[e][t]=false;if(r.MESSAGE&&r.MESSAGE.length==0){this.BXIM.messenger.historyEndOfList[e][t]=true;var i=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(i){i.appendChild(s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_NO_MESSAGE")}))}return}for(var a in r.FILES){if(!this.BXIM.disk.files[r.CHAT_ID])this.BXIM.disk.files[r.CHAT_ID]={};if(this.BXIM.disk.files[r.CHAT_ID][a])continue;r.FILES[a].date=parseInt(r.FILES[a].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.disk.files[r.CHAT_ID][a]=r.FILES[a]}var o=0;for(var a in r.MESSAGE){r.MESSAGE[a].date=parseInt(r.MESSAGE[a].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.message[a]=r.MESSAGE[a];o++}if(o<20){this.BXIM.messenger.historyEndOfList[e][t]=true}for(var a in r.USERS_MESSAGE){if(t){if(this.BXIM.messenger.history[a])this.BXIM.messenger.history[a]=s.util.array_merge(this.BXIM.messenger.history[a],r.USERS_MESSAGE[a]);else this.BXIM.messenger.history[a]=r.USERS_MESSAGE[a]}else{if(this.BXIM.messenger.showMessage[a])this.BXIM.messenger.showMessage[a]=s.util.array_unique(s.util.array_merge(r.USERS_MESSAGE[a],this.BXIM.messenger.showMessage[a]));else this.BXIM.messenger.showMessage[a]=r.USERS_MESSAGE[a]}}if(t){for(var a=0;a<r.USERS_MESSAGE[e].length;a++){var l=this.BXIM.messenger.message[r.USERS_MESSAGE[e][a]];if(l){if(s("im-message-history-"+l.id))continue;var m=s.MessengerCommon.formatDate(l.date,s.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));var h=typeof s.translit!="undefined"?s.translit(m):m;if(!s("bx-im-history-"+h)){var g=s.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[s.create("div",{attrs:{id:"bx-im-history-"+h},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:m})]});this.BXIM.messenger.popupHistoryBodyWrap.appendChild(g)}var l=this.BXIM.messenger.drawMessageHistory(l);if(l)this.BXIM.messenger.popupHistoryBodyWrap.appendChild(l)}}}else{var I=this.BXIM.messenger.popupMessengerBodyWrap.firstChild?this.BXIM.messenger.popupMessengerBodyWrap.firstChild.nextSibling:null;if(I){I=s("im-message-"+I.getAttribute("data-blockmessageid"))}if(r.USERS_MESSAGE[e]){for(var a=0;a<r.USERS_MESSAGE[e].length;a++){var l=this.BXIM.messenger.message[r.USERS_MESSAGE[e][a]];if(l){if(s("im-message-"+l.id))continue;s.MessengerCommon.drawMessage(e,l,false,true)}}}if(I){this.BXIM.messenger.popupMessengerBody.scrollTop=I.offsetTop-this.BXIM.messenger.popupMessengerBody.offsetTop-I.offsetHeight-100}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}},this),onfailure:s.delegate(function(){if(n)s.remove(n);if(this.isMobile())app.pullDownLoadingStop()},this)})}};s.MessengerCommon.prototype.loadMessageByDate=function(t,r,i){s.ajax({url:this.BXIM.pathToAjax+"?LOAD_MESSAGE_BY_DATE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LOAD_MESSAGE_BY_DATE:"Y",CHAT_ID:t,LAST_LOAD:r,FIRST_MESSAGE_ID:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(n){if(n&&n.BITRIX_SESSID){s.message({bitrix_sessid:n.BITRIX_SESSID})}if(n.ERROR==""){var a=n.DIALOG_ID;this.BXIM.messenger.sendAjaxTry=0;for(var o in n.USERS){this.BXIM.messenger.users[o]=n.USERS[o]}for(var o in n.PHONES){this.BXIM.messenger.phones[o]={};for(var l in n.PHONES[o]){this.BXIM.messenger.phones[o][l]=s.util.htmlspecialcharsback(n.PHONES[o][l])}}for(var o in n.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[o]=="undefined"||typeof this.BXIM.messenger.userInGroup[o].users=="undefined"||!this.BXIM.messenger.userInGroup[o].users.length){this.BXIM.messenger.userInGroup[o]=n.USER_IN_GROUP[o]}else{for(var l=0;l<n.USER_IN_GROUP[o].users.length;l++)this.BXIM.messenger.userInGroup[o].users.push(n.USER_IN_GROUP[o].users[l]);this.BXIM.messenger.userInGroup[o].users=s.util.array_unique(this.BXIM.messenger.userInGroup[o].users)}}for(var o in n.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[o]=="undefined"){this.BXIM.messenger.woUserInGroup[o]=n.WO_USER_IN_GROUP[o]}else{for(var l=0;l<n.WO_USER_IN_GROUP[o].users.length;l++)this.BXIM.messenger.woUserInGroup[o].users.push(n.WO_USER_IN_GROUP[o].users[l]);this.BXIM.messenger.woUserInGroup[o].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[o].users)}}for(var o in n.FILES){if(!this.BXIM.messenger.disk.files[n.CHAT_ID])this.BXIM.messenger.disk.files[n.CHAT_ID]={};n.FILES[o].date=parseInt(n.FILES[o].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.disk.files[n.CHAT_ID][o]=n.FILES[o]}this.BXIM.messenger.sendAjaxTry=0;var m=0;for(var o in n.MESSAGE){m++;n.MESSAGE[o].date=parseInt(n.MESSAGE[o].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.message[o]=n.MESSAGE[o];this.BXIM.lastRecordId=parseInt(o)>this.BXIM.lastRecordId?parseInt(o):this.BXIM.lastRecordId}for(var o in n.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[o])this.BXIM.messenger.showMessage[o]=s.util.array_unique(s.util.array_merge(n.USERS_MESSAGE[o],this.BXIM.messenger.showMessage[o]));else this.BXIM.messenger.showMessage[o]=n.USERS_MESSAGE[o]}for(var o in n.DELETE_MESSAGE){delete this.BXIM.messenger.message[o];if(this.BXIM.messenger.currentTab==n.DIALOG_ID&&s("im-message-"+o)){var h=s("im-message-"+o).parentNode.parentNode.parentNode.parentNode.parentNode;if(h.getAttribute("data-messageId")==h.getAttribute("data-blockMessageId")){s.remove(h)}else{h=s("im-message-"+o).parentNode;if(h.nextSibling&&s.hasClass(h.nextSibling,"bx-messenger-hr")){s.remove(h.nextSibling)}else if(!h.nextSibling&&s.hasClass(h.previousSibling,"bx-messenger-hr")){s.remove(h.previousSibling)}s.remove(h)}}}for(var o in n.CHAT){this.BXIM.messenger.chat[o]=n.CHAT[o]}for(var o in n.USER_IN_CHAT){this.BXIM.messenger.userInChat[o]=n.USER_IN_CHAT[o]}for(var o in n.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[o]=n.USER_BLOCK_CHAT[o]}this.changeUnreadMessage(n.UNREAD_MESSAGE)}else{if(n.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;setTimeout(s.delegate(function(){this.loadMessageByDate(t,r,i)},this),1e3);s.onCustomEvent(e,"onImError",[n.ERROR,n.BITRIX_SESSID])}else if(n.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(s.MessengerCommon.isDesktop()){setTimeout(s.delegate(function(){this.loadMessageByDate(t,r,i)},this),1e4)}s.onCustomEvent(e,"onImError",[n.ERROR])}}},this),onfailure:s.delegate(function(){this.sendAjaxTry=0},this)})};s.MessengerCommon.prototype.loadUserData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?USER_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_USER_DATA_LOAD:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.userChat[e]=t.CHAT_ID;s.MessengerCommon.getUserParam(e,true);this.BXIM.messenger.users[e].name=s.message("IM_M_USER_NO_ACCESS");for(var r in t.USERS){this.BXIM.messenger.users[r]=t.USERS[r]}for(var r in t.PHONES){this.BXIM.messenger.phones[r]={};for(var i in t.PHONES[r]){this.BXIM.messenger.phones[r][i]=s.util.htmlspecialcharsback(t.PHONES[r][i])}}for(var r in t.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[r]=="undefined"||typeof this.BXIM.messenger.userInGroup[r].users=="undefined"||!this.BXIM.messenger.userInGroup[r].users.length){this.BXIM.messenger.userInGroup[r]=t.USER_IN_GROUP[r]}else{for(var i=0;i<t.USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.userInGroup[r].users.push(t.USER_IN_GROUP[r].users[i]);this.BXIM.messenger.userInGroup[r].users=s.util.array_unique(this.BXIM.messenger.userInGroup[r].users)}}for(var r in t.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[r]=="undefined"){this.BXIM.messenger.woUserInGroup[r]=t.WO_USER_IN_GROUP[r]}else{for(var i=0;i<t.WO_USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.woUserInGroup[r].users.push(t.WO_USER_IN_GROUP[r].users[i]);this.BXIM.messenger.woUserInGroup[r].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[r].users)}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}}else{this.BXIM.messenger.redrawTab[e]=true;if(t.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}},this)})};s.MessengerCommon.prototype.loadChatData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CHAT_DATA_LOAD:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(this.BXIM.messenger.chat[e.CHAT_ID].fake){this.BXIM.messenger.chat[e.CHAT_ID].name=s.message("IM_M_USER_NO_ACCESS")}for(var t in e.CHAT){this.BXIM.messenger.chat[t]=e.CHAT[t]}for(var t in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[t]=e.USER_IN_CHAT[t]}for(var t in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[t]=e.USER_BLOCK_CHAT[t]}for(var t in e.USERS){this.BXIM.messenger.users[t]=e.USERS[t]}for(var t in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[t]=="undefined"||typeof this.BXIM.messenger.userInGroup[t].users=="undefined"||!this.BXIM.messenger.userInGroup[t].users.length){this.BXIM.messenger.userInGroup[t]=e.USER_IN_GROUP[t]}else{for(var r=0;r<e.USER_IN_GROUP[t].users.length;r++)this.BXIM.messenger.userInGroup[t].users.push(e.USER_IN_GROUP[t].users[r]);this.BXIM.messenger.userInGroup[t].users=s.util.array_unique(this.BXIM.messenger.userInGroup[t].users)}}for(var t in e.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[t]=="undefined"){this.BXIM.messenger.woUserInGroup[t]=e.WO_USER_IN_GROUP[t]}else{for(var r=0;r<e.WO_USER_IN_GROUP[t].users.length;r++)this.BXIM.messenger.woUserInGroup[t].users.push(e.WO_USER_IN_GROUP[t].users[r]);this.BXIM.messenger.woUserInGroup[t].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[t].users)}}if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="call"){this.BXIM.messenger.openCallFlag=true}else if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="lines"){this.BXIM.messenger.openLinesFlag=true}this.drawTab(this.BXIM.messenger.currentTab)}}},this)})};s.MessengerCommon.prototype.loadLastMessage=function(t,r){if(this.BXIM.messenger.loadLastMessageTimeout[t])return false;r=typeof r=="function"?r:function(e,s,t){};userIsChat=t.toString().substr(0,4)=="chat"||t.toString().substr(0,2)=="sg";this.BXIM.messenger.historyWindowBlock=true;delete this.BXIM.messenger.redrawTab[t];this.BXIM.messenger.loadLastMessageTimeout[t]=true;if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==t){s.addClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}var i=s.delegate(function(){r(t,false,{});if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==t){s.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}if(this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;clearTimeout(this.BXIM.messenger.loadLastMessageTimeout);this.BXIM.messenger.loadLastMessageTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.loadLastMessageTimeout[t]=false;s.MessengerCommon.loadLastMessage(t)},this),2e3);return true}this.BXIM.messenger.loadLastMessageTimeout[t]=false;this.BXIM.messenger.historyWindowBlock=false;this.BXIM.messenger.redrawTab[t]=true;this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";var e=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:e});if(this.isMobile()&&this.MobileActionEqual("DIALOG")){BXMobileApp.UI.Page.TopBar.title.setText(s.message("IM_F_ERROR"));BXMobileApp.UI.Page.TopBar.title.setDetailText("")}},this);var n=s.delegate(function(n){if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==n.USER_ID){s.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}if(!this.BXIM.checkRevision(this.isMobile()?n.MOBILE_REVISION:n.REVISION))return false;this.BXIM.messenger.loadLastMessageTimeout[t]=false;if(!n){i();return false}if(n&&n.BITRIX_SESSID){s.message({bitrix_sessid:n.BITRIX_SESSID})}if(n.ERROR==""){if(userIsChat){if(n.USER_ID.toString().substr(0,2)=="sg"){if(this.BXIM.messenger.currentTab==n.USER_ID){this.BXIM.messenger.currentTab="chat"+n.CHAT_ID}delete this.BXIM.messenger.chat[n.USER_ID];n.USER_ID="chat"+n.CHAT_ID;s.MessengerCommon.getUserParam(n.USER_ID)}}else{this.BXIM.messenger.userChat[t]=n.CHAT_ID;s.MessengerCommon.getUserParam(t,true);this.BXIM.messenger.users[t].name=s.message("IM_M_USER_NO_ACCESS")}for(var a in n.USERS){this.BXIM.messenger.users[a]=n.USERS[a]}for(var a in n.PHONES){this.BXIM.messenger.phones[a]={};for(var o in n.PHONES[a]){this.BXIM.messenger.phones[a][o]=s.util.htmlspecialcharsback(n.PHONES[a][o])}}for(var a in n.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[a]=="undefined"||typeof this.BXIM.messenger.userInGroup[a].users=="undefined"||!this.BXIM.messenger.userInGroup[a].users.length){this.BXIM.messenger.userInGroup[a]=n.USER_IN_GROUP[a]}else{for(var o=0;o<n.USER_IN_GROUP[a].users.length;o++)this.BXIM.messenger.userInGroup[a].users.push(n.USER_IN_GROUP[a].users[o]);this.BXIM.messenger.userInGroup[a].users=s.util.array_unique(this.BXIM.messenger.userInGroup[a].users)}}for(var a in n.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[a]=="undefined"){this.BXIM.messenger.woUserInGroup[a]=n.WO_USER_IN_GROUP[a]}else{for(var o=0;o<n.WO_USER_IN_GROUP[a].users.length;o++)this.BXIM.messenger.woUserInGroup[a].users.push(n.WO_USER_IN_GROUP[a].users[o]);this.BXIM.messenger.woUserInGroup[a].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[a].users)}}if(!userIsChat&&n.USER_LOAD=="Y")s.MessengerCommon.userListRedraw();for(var a in n.FILES){if(!this.BXIM.messenger.disk.files[n.CHAT_ID])this.BXIM.messenger.disk.files[n.CHAT_ID]={};n.FILES[a].date=parseInt(n.FILES[a].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.disk.files[n.CHAT_ID][a]=n.FILES[a]}this.BXIM.messenger.sendAjaxTry=0;var l=0;for(var a in n.MESSAGE){l++;n.MESSAGE[a].date=parseInt(n.MESSAGE[a].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.message[a]=n.MESSAGE[a];this.BXIM.lastRecordId=parseInt(a)>this.BXIM.lastRecordId?parseInt(a):this.BXIM.lastRecordId}if(l<=0){delete this.BXIM.messenger.redrawTab[n.USER_ID]}for(var a in n.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[a])this.BXIM.messenger.showMessage[a]=s.util.array_unique(s.util.array_merge(n.USERS_MESSAGE[a],this.BXIM.messenger.showMessage[a]));else this.BXIM.messenger.showMessage[a]=n.USERS_MESSAGE[a]}if(userIsChat&&this.BXIM.messenger.chat[n.USER_ID.toString().substr(4)].fake){this.BXIM.messenger.chat[n.USER_ID.toString().substr(4)].name=s.message("IM_M_USER_NO_ACCESS")}for(var a in n.CHAT){this.BXIM.messenger.chat[a]=n.CHAT[a]}for(var a in n.USER_IN_CHAT){this.BXIM.messenger.userInChat[a]=n.USER_IN_CHAT[a]}for(var a in n.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[a]=n.USER_BLOCK_CHAT[a]}if(n.OPENLINES.canVoteAsHead){if(!this.BXIM.messenger.openlines.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead={}}for(var a in n.OPENLINES.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead[a]=n.OPENLINES.canVoteAsHead[a]}}if(this.BXIM.messenger.currentTab==n.USER_ID){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){this.BXIM.messenger.openCallFlag=true}}if(n.NETWORK_ID!=""){this.BXIM.messenger.currentTab=n.USER_ID;delete this.BXIM.messenger.users[n.NETWORK_ID];if(!this.BXIM.messenger.bot[n.USER_ID]){this.BXIM.messenger.bot[n.USER_ID]=this.BXIM.messenger.bot[n.NETWORK_ID]}delete this.BXIM.messenger.bot[n.NETWORK_ID];if(this.MobileActionEqual("RECENT")){var m=0;for(var a=0;a<this.BXIM.messenger.recent.length;a++){if(this.BXIM.messenger.recent[a].userId==n.NETWORK_ID){m++;this.BXIM.messenger.recent[a].userId=n.USER_ID;this.BXIM.messenger.recent[a].recipientId=n.USER_ID;this.BXIM.messenger.recent[a].senderId=n.USER_ID}else if(this.BXIM.messenger.recent[a].userId==n.USER_ID){m++}}if(m>1){for(var a=0;a<this.BXIM.messenger.recent.length;a++){if(this.BXIM.messenger.recent[a].userId==n.USER_ID){this.recentListHide(n.USER_ID,false);break}}}s.MessengerCommon.userListRedraw()}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){app.onCustomEvent("onImDialogNetworkOpen",{NETWORK_ID:n.NETWORK_ID,USER_ID:n.USER_ID,USER:this.BXIM.messenger.users[n.USER_ID]})}}for(var a in n.READED_LIST){n.READED_LIST[a].date=parseInt(n.READED_LIST[a].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.readedList[a]=n.READED_LIST[a]}if(userIsChat&&this.BXIM.messenger.chat[n.CHAT_ID]&&this.BXIM.messenger.chat[n.CHAT_ID].type=="livechat"){var h=this.livechatGetSession(n.CHAT_ID);if(h.readed=="Y"){h.readedTime=parseInt(h.readedTime)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.readedList["chat"+n.CHAT_ID]={
messageId:h.readedId,date:h.readedTime}}}this.drawTab(n.USER_ID,this.BXIM.messenger.currentTab==n.USER_ID,l);if(this.BXIM.messenger.currentTab==n.USER_ID&&this.BXIM.messenger.readedList[n.USER_ID]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(n.USER_ID,false)}else{this.drawReadMessage(n.USER_ID,this.BXIM.messenger.readedList[n.USER_ID].messageId,this.BXIM.messenger.readedList[n.USER_ID].date,false)}}this.BXIM.messenger.historyWindowBlock=false;if(this.BXIM.isFocus()){this.readMessage(n.USER_ID,true,false)}r(t,true,n)}else{this.BXIM.messenger.redrawTab[t]=true;if(n.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}else if(n.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.loadLastMessage(t)},this),2e3);s.onCustomEvent(e,"onImError",[n.ERROR,n.BITRIX_SESSID])}else if(n.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()){setTimeout(s.delegate(function(){this.loadLastMessage(t)},this),1e4)}s.onCustomEvent(e,"onImError",[n.ERROR])}r(t,false,n)}},this);var a=this.isMobile()||this.BXIM.isFocus();if(userIsChat&&this.BXIM.messenger.chat[t.toString().substr(4)]&&this.BXIM.messenger.chat[t.toString().substr(4)].owner==0&&this.BXIM.messenger.chat[t.toString().substr(4)].type=="lines"){a=false}var o=s.ajax({url:this.BXIM.pathToAjax+"?LOAD_LAST_MESSAGE&D="+t+"&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LOAD_LAST_MESSAGE:"Y",CHAT:userIsChat?"Y":"N",USER_ID:t,USER_LOAD:"Y",TAB:this.BXIM.messenger.currentTab,READ:a?"Y":"N",MOBILE:this.isMobile()?"Y":"N",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",SEARCH_MARK:!userIsChat&&this.BXIM.messenger.users[t]&&this.BXIM.messenger.users[t].searchMark?this.BXIM.messenger.users[t].searchMark:"",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:n,onprogress:function(e){if(e.position==0&&e.totalSize==0){i()}},onfailure:i})};s.MessengerCommon.prototype.openDialog=function(e,t,r){var i=s.MessengerCommon.getUserParam(e);if(i.id<=0)return false;this.BXIM.messenger.currentTab=e;if(e.toString().substr(0,4)=="chat"){this.BXIM.messenger.openChatFlag=true;if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="call")this.BXIM.messenger.openCallFlag=true;else if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="lines")this.BXIM.messenger.openLinesFlag=true}s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanel.className=this.BXIM.messenger.openChatFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";if(this.BXIM.messenger.openChatFlag){this.BXIM.messenger.popupMessengerPanelChat.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";this.BXIM.messenger.popupMessengerPanelCall.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel":"bx-messenger-panel bx-messenger-hide"}else{this.BXIM.messenger.popupMessengerPanelChat.className="bx-messenger-panel bx-messenger-hide";this.BXIM.messenger.popupMessengerPanelCall.className="bx-messenger-panel bx-messenger-hide"}}t=t==true;r=r!=false;var n=[];if(typeof this.BXIM.messenger.showMessage[e]!="undefined"&&this.BXIM.messenger.showMessage[e].length>0){if(!i.fake&&this.BXIM.messenger.showMessage[e].length>=15){this.BXIM.messenger.redrawTab[e]=false}else{this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}}else if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");n=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(typeof this.BXIM.messenger.showMessage[e]=="undefined"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");n=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(this.BXIM.messenger.redrawTab[e]&&this.BXIM.messenger.showMessage[e].length==0){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");n=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.showMessage[e]=[]}else{var a="";if(this.isBot(e)&&this.BXIM.messenger.users[e]){a=s.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[e].name)}else{a=s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE")}s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");n=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:a})]})]}if(n.length>0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:n})}if(t)this.BXIM.messenger.extraClose();if(this.isMobile()){BXMobileApp.UI.Page.TextPanel.setText(this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:"")}else{this.BXIM.messenger.popupMessengerTextarea.value=this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:""}if(this.BXIM.messenger.redrawTab[e]){if(this.BXIM.settings.loadLastMessage){this.loadLastMessage(e)}else{if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.loadChatData(e.toString().substr(4));else s.MessengerCommon.loadUserData(e);delete this.BXIM.messenger.redrawTab[e];this.drawTab(e,true)}}else{this.drawTab(e,true)}if(!this.BXIM.messenger.redrawTab[e]){if(this.isMobile()){this.BXIM.isFocusMobile(s.delegate(function(t){if(t){s.MessengerCommon.readMessage(e)}},this))}else if(this.BXIM.isFocus()){this.readMessage(e)}}if(!this.isMobile())this.BXIM.messenger.resizeMainWindow();if(s.MessengerCommon.countWriting(e)){if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.drawWriting(0,e);else s.MessengerCommon.drawWriting(e)}else if(this.BXIM.messenger.readedList[e]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(e,false)}else{this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}}if(!this.isMobile()&&r)this.BXIM.webrtc.callOverlayToggleSize(true);s.onCustomEvent("onImDialogOpen",[{id:e}]);if(this.isMobile()){BXMobileApp.onCustomEvent("onImDialogOpen",{id:e},true)}};s.MessengerCommon.prototype.drawTab=function(e,t,r,i){r=r||0;i=i!==false;if(!e){e=this.BXIM.messenger.currentTab}if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab)return false;if(typeof this.messageGroup!="object"){this.messageGroup={}}this.messageGroup["default"]={};var n=true;if(this.BXIM.messenger.openChatFlag){var a=e.toString().substr(4);if(this.BXIM.messenger.chat[a]){if(this.BXIM.messenger.chat[a].type=="open"){if(!s.MessengerCommon.userInChat(a)){if(this.isMobile()){BXMobileApp.onCustomEvent("onPullExtendWatch",{id:"IM_PUBLIC_"+a,force:this.BXIM.messenger.redrawTab[e]?false:true},true)}else{s.PULL.extendWatch("IM_PUBLIC_"+a,this.BXIM.messenger.redrawTab[e]?false:true)}}}else if(this.BXIM.messenger.chat[a].type=="lines"){n=false}}}if(this.isPage()&&i){if(n){if(s.MessengerWindow.currentTab!="im"){s.MessengerWindow.changeTab("im")}}else if(this.BXIM.settings.linesTabEnable){if(s.MessengerWindow.currentTab!="im-ol"){s.MessengerWindow.changeTab("im-ol")}}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");if(!this.BXIM.messenger.showMessage[e]||this.BXIM.messenger.showMessage[e].length<=0){var o="";var l=null;if(this.isBot(e)&&this.BXIM.messenger.users[e]){o=s.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[e].name)}else{o=s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE");l=s.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[s.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:s.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:s.delegate(function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)},this)}})}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:o}),l]}))}if(this.BXIM.messenger.showMessage[e])this.BXIM.messenger.showMessage[e].sort(s.delegate(function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=parseInt(this.BXIM.messenger.message[e].date);var r=parseInt(this.BXIM.messenger.message[s].date);if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));else this.BXIM.messenger.showMessage[e]=[];for(var m=0;m<this.BXIM.messenger.showMessage[e].length;m++)s.MessengerCommon.drawMessage(e,this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][m]],false);if(r>0&&r<20){if(!this.BXIM.messenger.openChatFlag||this.BXIM.messenger.chat[e.toString().substr(4)]){var h=false;if(this.BXIM.messenger.openChatFlag&&parseInt(this.BXIM.messenger.chat[e.toString().substr(4)].date_create)>0){if(parseInt(this.BXIM.messenger.chat[e.toString().substr(4)].date_create)+25e5>(new Date).getTime()/1e3){h=true}}if(!h){var l=s.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[s.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:s.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:s.delegate(function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)},this)}});this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(l,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}}t=t!=false;if(t){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();if(this.BXIM.messenger.unreadMessage[e]&&this.BXIM.messenger.unreadMessage[e].length>0){var g=s("im-message-"+this.BXIM.messenger.unreadMessage[e][0]);if(g)this.BXIM.messenger.popupMessengerBody.scrollTop=g.offsetTop-60-this.BXIM.messenger.popupMessengerBodyWrap.offsetTop;else this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}s.onCustomEvent("onImDrawTab",[{id:e,hasMessage:this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0}]);delete this.BXIM.messenger.redrawTab[e]};s.MessengerCommon.prototype.sendMessageAjax=function(t,r,i,n){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;s.MessengerCommon.drawProgessMessage("temp"+t);if(this.BXIM.messenger.sendMessageFlag<0)this.BXIM.messenger.sendMessageFlag=0;clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout["temp"+t]);if(this.BXIM.messenger.sendMessageTmp[t])return false;this.BXIM.messenger.sendMessageTmp[t]=true;n=n==true;this.BXIM.messenger.sendMessageFlag++;var a="N";if(n&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[r.toString().substr(4)]){a="Y"}this.recentListAdd({id:"temp"+t,date:s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),skipDateCheck:true,recipientId:r,senderId:this.BXIM.userId,text:i,userId:r,userIsChat:n,params:{CLASS:a=="Y"?"bx-messenger-content-item-system":""}},true);s.onCustomEvent("onImBeforeMessageSend",[{recipientId:r,messageText:i}]);var o=s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_SEND_MESSAGE:"Y",CHAT:n?"Y":"N",ID:"temp"+t,RECIPIENT_ID:r,MESSAGE:i,OL_SILENT:a,TAB:this.BXIM.messenger.currentTab,USER_TZ_OFFSET:s.message("USER_TZ_OFFSET"),IM_AJAX_CALL:"Y",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(a){this.BXIM.messenger.sendMessageFlag--;if(a&&a.BITRIX_SESSID){s.message({bitrix_sessid:a.BITRIX_SESSID})}if(a.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.message[a.TMP_ID].text=a.SEND_MESSAGE;this.BXIM.messenger.message[a.TMP_ID].id=a.ID;this.BXIM.messenger.message[a.TMP_ID].date=parseInt(a.SEND_DATE);if(a.SEND_MESSAGE_PARAMS){this.BXIM.messenger.message[a.TMP_ID].params=a.SEND_MESSAGE_PARAMS}for(var o in a.SEND_MESSAGE_FILES){if(!this.BXIM.messenger.disk.files[a.CHAT_ID])this.BXIM.messenger.disk.files[a.CHAT_ID]={};if(this.BXIM.messenger.disk.files[a.CHAT_ID][o])continue;a.SEND_MESSAGE_FILES[o].date=parseInt(a.SEND_MESSAGE_FILES[o].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.disk.files[a.CHAT_ID][o]=a.SEND_MESSAGE_FILES[o]}this.BXIM.messenger.message[a.ID]=this.BXIM.messenger.message[a.TMP_ID];if(this.BXIM.messenger.popupMessengerLastMessage==a.TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=a.ID;delete this.BXIM.messenger.message[a.TMP_ID];var l=this.BXIM.messenger.message[a.ID];var m=s.util.array_search(""+a.TMP_ID+"",this.BXIM.messenger.showMessage[a.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[a.RECIPIENT_ID][m])this.BXIM.messenger.showMessage[a.RECIPIENT_ID][m]=""+a.ID+"";for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(this.BXIM.messenger.recent[o].id==a.TMP_ID){this.BXIM.messenger.recent[o].id=""+a.ID+"";break}}if(a.RECIPIENT_ID==this.BXIM.messenger.currentTab){var h=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+a.TMP_ID+""}},true);if(h){h.setAttribute("data-messageid",""+a.ID+"");if(h.getAttribute("data-blockmessageid")==""+a.TMP_ID+""){h.setAttribute("data-blockmessageid",""+a.ID+"")}else{var g=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+a.TMP_ID+""}},true);if(g){g.setAttribute("data-blockmessageid",""+a.ID+"")}}var I=s.findChild(h,{attribute:{"data-messageid":""+a.TMP_ID+""}},true);if(I){I.setAttribute("data-messageid",""+a.ID+"")}}var p=s("im-message-"+a.TMP_ID);if(p){p.id="im-message-"+a.ID;p.innerHTML=s.MessengerCommon.prepareText(a.SEND_MESSAGE,false,true,true)}var M=s.findChildByClassName(h,"bx-messenger-content-item-date");if(M)M.innerHTML=" &nbsp; "+s.MessengerCommon.formatDate(l.date,s.MessengerCommon.getDateFormatType("MESSAGE"));s.MessengerCommon.clearProgessMessage(a.ID)}if(this.BXIM.messenger.history[a.RECIPIENT_ID])this.BXIM.messenger.history[a.RECIPIENT_ID].push(l.id);else this.BXIM.messenger.history[a.RECIPIENT_ID]=[l.id];this.BXIM.messenger.updateStateVeryFastCount=2;this.BXIM.messenger.updateStateFastCount=5;this.BXIM.messenger.setUpdateStateStep();if(a.SEND_MESSAGE_PARAMS){if(a.RECIPIENT_ID.toString().substr(0,4)=="chat"){s.onCustomEvent(e,"onPullEvent-im",["messageParamsUpdate",{id:a.ID,type:"chat",chatId:a.CHAT_ID,senderId:a.SENDER_ID,params:a.SEND_MESSAGE_PARAMS,animation:"N"}])}else{s.onCustomEvent(e,"onPullEvent-im",["messageParamsUpdate",{id:a.ID,type:"private",chatId:a.CHAT_ID,fromUserId:a.SENDER_ID,toUserId:a.RECIPIENT_ID,senderId:a.SENDER_ID,params:a.SEND_MESSAGE_PARAMS,animation:"N"}])}}if(s.PULL){s.PULL.setUpdateStateStepCount(2,5)}s.MessengerCommon.updateStateVar(a,true,true);s.localStorage.set("msm",{id:a.ID,recipientId:a.RECIPIENT_ID,date:a.SEND_DATE,text:a.SEND_MESSAGE,senderId:this.BXIM.userId,MESSAGE:a.MESSAGE,USERS_MESSAGE:a.USERS_MESSAGE,USERS:a.USERS,USER_IN_GROUP:a.USER_IN_GROUP,WO_USER_IN_GROUP:a.WO_USER_IN_GROUP},5);if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal))this.recentListRedraw()}else{if(a.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,n)},this),2e3);s.onCustomEvent(e,"onImError",[a.ERROR,a.BITRIX_SESSID])}else if(a.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()){setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,n)},this),1e4)}s.onCustomEvent(e,"onImError",[a.ERROR])}else{this.BXIM.messenger.sendMessageTmp[t]=false;var h=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var M=s.findChildByClassName(h,"bx-messenger-content-item-date");if(M){if(a.ERROR=="SESSION_ERROR"||a.ERROR=="AUTHORIZE_ERROR"||a.ERROR=="UNKNOWN_ERROR"||a.ERROR=="IM_MODULE_NOT_INSTALLED")M.innerHTML=s.message("IM_M_NOT_DELIVERED");else M.innerHTML=a.ERROR}s.onCustomEvent(e,"onImError",["SEND_ERROR",a.ERROR,a.TMP_ID,a.SEND_DATE,a.SEND_MESSAGE,a.RECIPIENT_ID]);s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:n?"Y":"N"});if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;this.BXIM.messenger.sendMessageTmp[t]=false;var r=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var i=s.findChildByClassName(r,"bx-messenger-content-item-date");if(i)i.innerHTML=s.message("IM_M_NOT_DELIVERED");s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:n?"Y":"N"});this.BXIM.messenger.sendAjaxTry=0;try{if(typeof o=="object"&&o.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(a){}if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true},this)})};s.MessengerCommon.prototype.sendMessageRetry=function(){var e=this.BXIM.messenger.currentTab;var t=[];for(var r=0;r<this.BXIM.messenger.showMessage[e].length;r++){var i=this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][r]];if(!i||i.id.indexOf("temp")!=0)continue;i.text=s.MessengerCommon.prepareTextBack(i.text);t.push(i)}if(t.length<=0)return false;t.sort(function(e,s){e=e.id.substr(4);s=s.id.substr(4);if(e<s){return-1}else if(e>s){return 1}else{return 0}});for(var r=0;r<t.length;r++){this.sendMessageRetryTimeout(t[r],100*r)}};s.MessengerCommon.prototype.sendMessageRetryTimeout=function(e,t){clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout[e.id]);this.BXIM.messenger.sendMessageTmpTimeout[e.id]=setTimeout(s.delegate(function(){s.MessengerCommon.sendMessageAjax(e.id.substr(4),e.recipientId,e.text,e.recipientId.toString().substr(0,4)=="chat")},this),t)};s.MessengerCommon.prototype.getLastMessageInDialog=function(e){var s=false;if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0){var t=this.BXIM.messenger.showMessage[e][this.BXIM.messenger.showMessage[e].length-1];s=this.BXIM.messenger.message[t]}return s};s.MessengerCommon.prototype.joinToChat=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].type!="open")return false;if(s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_CHAT_JOIN:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.popupMessengerTextarea.disabled=false;this.BXIM.messenger.popupMessengerTextarea.focus()},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.messageUrlAttachDelete=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.ATTACH||!this.BXIM.messenger.message[e].params.URL_ID||this.BXIM.messenger.message[e].params.URL_ID.indexOf(t)==-1){return false}for(var r=0;r<this.BXIM.messenger.message[e].params.ATTACH.length;r++){if(!this.BXIM.messenger.message[e].params.ATTACH[r])continue;if(this.BXIM.messenger.message[e].params.ATTACH[r].ID==t){delete this.BXIM.messenger.message[e].params.ATTACH[r];break}}for(var r=0;r<this.BXIM.messenger.message[e].params.URL_ID.length;r++){if(!this.BXIM.messenger.message[e].params.URL_ID[r])continue;if(this.BXIM.messenger.message[e].params.URL_ID[r]==t){delete this.BXIM.messenger.message[e].params.URL_ID[r];break}}var i=s("im-message-"+e);var n=s.MessengerCommon.drawAttach(e,this.BXIM.messenger.message[e].chatId,this.BXIM.messenger.message[e].params.ATTACH);i.nextElementSibling.innerHTML="";if(n.length>0){s.adjust(i.nextElementSibling,{children:n})}s.ajax({url:this.BXIM.pathToAjax+"?URL_ATTACH_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_URL_ATTACH_DELETE:"Y",ID:e,ATTACH_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});return true};s.MessengerCommon.prototype.messageLike=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||this.BXIM.messenger.popupMessengerLikeBlock[e])return false;t=typeof t=="undefined"?false:t;if(!this.BXIM.messenger.message[e].params){this.BXIM.messenger.message[e].params={}}if(!this.BXIM.messenger.message[e].params.LIKE){this.BXIM.messenger.message[e].params.LIKE=[]}var r=s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE);if(!t){var i=r?"minus":"plus";if(i=="plus"){this.BXIM.messenger.message[e].params.LIKE.push(this.BXIM.userId);r=true}else{var n=[];for(var a=0;a<this.BXIM.messenger.message[e].params.LIKE.length;a++){if(this.BXIM.messenger.message[e].params.LIKE[a]!=this.BXIM.userId){n.push(this.BXIM.messenger.message[e].params.LIKE[a])}}this.BXIM.messenger.message[e].params.LIKE=n;r=false}}var o=this.BXIM.messenger.message[e].params.LIKE.length>0?this.BXIM.messenger.message[e].params.LIKE.length:"";if(s("im-message-"+e)){var l=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+e+""}},false);var m=s.findChildByClassName(l,"bx-messenger-content-item-like");var h=s.findChildByClassName(l,"bx-messenger-content-like-digit",false);var g=s.findChildByClassName(l,"bx-messenger-content-like-button",false);if(r){s.addClass(m,"bx-messenger-content-item-liked")}else{s.removeClass(m,"bx-messenger-content-item-liked")}if(o>0){h.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(h,"bx-messenger-content-like-digit-off")}else{h.setAttribute("title","");s.addClass(h,"bx-messenger-content-like-digit-off")}h.innerHTML=o}if(!t){clearTimeout(this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]);this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]=setTimeout(s.delegate(function(){this.BXIM.messenger.popupMessengerLikeBlock[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_LIKE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LIKE_MESSAGE:"Y",ID:e,ACTION:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.message[e].params.LIKE=t.LIKE}this.BXIM.messenger.popupMessengerLikeBlock[e]=false;s.MessengerCommon.messageLike(e,true)},this),onfailure:s.delegate(function(s){this.BXIM.messenger.popupMessengerLikeBlock[e]=false},this)})},this),1e3)}return true};s.MessengerCommon.prototype.messageIsLike=function(e){return this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&typeof this.BXIM.messenger.message[e].params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE)};s.MessengerCommon.prototype.checkEditMessage=function(e,t){t=t||"list";if(this.BXIM.messenger.openLinesFlag){var r=this.linesGetSource(this.BXIM.messenger.currentTab.toString().substr(4))}var i=false;if(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"){return i}if(this.BXIM.ppServerStatus&&parseInt(e)!=0&&e.toString().substr(0,4)!="temp"&&this.BXIM.messenger.message[e]&&parseInt(this.BXIM.messenger.message[e].date)+259200>(new Date).getTime()/1e3&&(!this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.IS_DELETED!="Y")&&s("im-message-"+e)&&s.util.in_array(e,this.BXIM.messenger.showMessage[this.BXIM.messenger.currentTab])){if(this.BXIM.messenger.openLinesFlag){if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){if(t=="edit"){i=this.BXIM.messenger.openlines.canUpdateOwnMessage.indexOf(r)>-1}else if(t=="delete"){i=this.BXIM.messenger.openlines.canDeleteOwnMessage.indexOf(r)>-1}}else if(this.BXIM.messenger.openlines.canDeleteMessage.indexOf(r)>-1&&t=="delete"){i=true}if(i&&r!="network"){if(!this.BXIM.messenger.message[e].params||typeof this.BXIM.messenger.message[e].params.CONNECTOR_MID=="undefined"||this.BXIM.messenger.message[e].params.CONNECTOR_MID.length<=0){i=false}}}else if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){i=true}}return i};s.MessengerCommon.prototype.editMessageAjax=function(e,t){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;this.BXIM.messenger.editMessageCancel();if(!s.MessengerCommon.checkEditMessage(e,"edit"))return false;if(t==s.MessengerCommon.prepareTextBack(this.BXIM.messenger.message[e].text,true))return false;t=t.replace("    ","	");t=s.util.trim(t);if(t.length<=0){s.MessengerCommon.deleteMessageAjax(e);return false}t=s.MessengerCommon.prepareMention(this.BXIM.messenger.currentTab,t);s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_EDIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_EDIT_MESSAGE:"Y",ID:e,MESSAGE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)})};s.MessengerCommon.prototype.deleteMessageAjax=function(e){this.BXIM.messenger.editMessageCancel();if(this.BXIM.isAdmin&&this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.message[e].chatId&&this.BXIM.messenger.generalChatId==this.BXIM.messenger.message[e].chatId){}else if(!s.MessengerCommon.checkEditMessage(e,"delete")){return false}s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_DELETE_MESSAGE:"Y",ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR)return false;if(this.BXIM.messenger.message[e]){this.BXIM.messenger.message[e].isNowDeleted=true}s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)});return true};s.MessengerCommon.prototype.shareMessageAjax=function(e,t,r){s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SHARE&TYPE="+t+"&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SHARE_MESSAGE:"Y",ID:e,TYPE:t,DATE:r?r:0,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR)return false;s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)});return true};s.MessengerCommon.prototype.drawKeyboard=function(e,t,r){if(!r||r=="N")return null;var i=null;var n=[];var a=null;var o=null;for(var l=0;l<r.length;l++){if(r[l].TYPE=="NEWLINE"){a=s.create("div",{props:{className:"bx-messenger-keyboard-new-line"}})}else{if(r[l].CONTEXT&&(this.isMobile()&&r[l].CONTEXT=="DESKTOP"||!this.isMobile()&&r[l].CONTEXT=="MOBILE")){continue}var m="";if(r[l].WIDTH){m=m+"width: "+r[l].WIDTH+"px;"}else if(r[l].DISPLAY=="BLOCK"){m=m+"width: 225px;"}if(r[l].BG_COLOR){m=m+"background-color: "+r[l].BG_COLOR+";"}if(r[l].TEXT_COLOR){m=m+"color: "+r[l].TEXT_COLOR+";"}if(r[l].DISABLED&&r[l].DISABLED=="Y"){o='<span class="bx-messenger-keyboard-button-text" data-disabled="Y" style="'+m+'">'+r[l].TEXT+"</span>"}else{if(r[l].LINK){o='<a href="'+r[l].LINK+'" target="_blank" class="bx-messenger-keyboard-button-text" style="'+m+'">'+r[l].TEXT+"</a>"}else if(r[l].FUNCTION){var h=r[l].FUNCTION.toString().replace("#MESSAGE_ID#",t).replace("#DIALOG_ID#",e).replace("#USER_ID#",this.BXIM.userId);o='<a href="javascript:void(1);" onclick="'+h+'; BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+m+'">'+r[l].TEXT+"</a>"}else if(r[l].APP_ID){r[l].APP_PARAMS=r[l].APP_PARAMS?r[l].APP_PARAMS:"";o='<a href="javascript:void(1);" onclick="BXIM.messenger.textareaIconDialogClick('+parseInt(r[l].APP_ID)+", "+t+", '"+s.util.htmlspecialchars(r[l].APP_PARAMS)+'\'); BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+m+'">'+r[l].TEXT+"</a>"}else{o='<span class="bx-messenger-keyboard-button-text" data-dialogId="'+e+'" data-messageId="'+t+'" data-blockAfterClick="'+r[l].BLOCK+'" data-command="'+s.util.htmlspecialchars(r[l].COMMAND)+'" data-commandParams="'+s.util.htmlspecialchars(r[l].COMMAND_PARAMS)+'" data-botId="'+r[l].BOT_ID+'" style="'+m+'">'+r[l].TEXT+"</span>"}}a=s.create("span",{props:{className:"bx-messenger-keyboard-button bx-messenger-keyboard-button-"+r[l].DISPLAY.toLowerCase()},children:[o]})}n.push(a)}if(n.length>0){i=s.create("div",{attrs:{id:"im-message-keyboard-"+t},props:{className:"bx-messenger-keyboard"},children:n})}return i};s.MessengerCommon.prototype.clickButtonKeyboard=function(){if(s.proxy_context.tagName=="A")return true;if(this.sendBotCommand)return true;var e=s.proxy_context.getAttribute("data-dialogId");var t=s.proxy_context.getAttribute("data-messageId");var r=s.proxy_context.getAttribute("data-botId");var i=s.proxy_context.getAttribute("data-command");var n=s.proxy_context.getAttribute("data-commandParams");var a=s.proxy_context.getAttribute("data-disabled");var o=s.proxy_context.getAttribute("data-blockAfterClick");if(a=="Y"||s.hasClass(s.proxy_context,"bx-messenger-keyboard-button-block"))return true;this.sendBotCommand=true;if(!this.sendBotCommandBlock[r]){this.sendBotCommandBlock[r]={}}this.sendBotCommandBlock[r][t]=true;if(o=="Y"){var l=s("im-message-keyboard-"+t);if(l){var m=s.findChildrenByClassName(l,"bx-messenger-keyboard-button-text",false);for(var h=0;h<m.length;h++){
s.addClass(m[h],"bx-messenger-keyboard-button-block")}}}s.addClass(s.proxy_context,"bx-messenger-keyboard-button-progress bx-messenger-keyboard-button-block");s.ajax({url:this.BXIM.pathToCallAjax+"?BOT_COMMAND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_BOT_COMMAND:"Y",BOT_ID:r,COMMAND:i,COMMAND_PARAMS:n,DIALOG_ID:e,MESSAGE_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){this.sendBotCommand=false},this),onfailure:s.delegate(function(){this.sendBotCommand=false},this)});return true};s.MessengerCommon.prototype.drawAttach=function(e,t,r,i){if(!r||r.length==0)return[];var n=[];if(typeof r!="object"){n.push(r)}else{n=r}i=i||{};var a=this.getUserIdByChatId(t);var o=[];for(var l=0;l<n.length;l++){var m=n[l];if(!m)continue;var h="";if(typeof m.COLOR!="undefined"){h=m.COLOR}else if(a&&this.BXIM.messenger.users[a]){h=this.BXIM.messenger.users[a].color}else if(this.BXIM.messenger.chat[t]){h=this.BXIM.messenger.chat[t].color}else if(this.BXIM.messenger.users[this.BXIM.userId]){h=this.BXIM.messenger.users[this.BXIM.userId].color}if(typeof m["BLOCKS"]!="object"){continue}var g=typeof m["ID"]!="undefined"?m["ID"]:0;var I=[];var p=false;if(g&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.URL_ID&&this.BXIM.messenger.message[e].senderId==this.BXIM.userId&&this.BXIM.messenger.message[e].params.URL_ID.indexOf(g)>-1){p=true}if(p){I.push(s.create("span",{props:{className:"bx-messenger-attach-delete"},attrs:{"data-attachId":g,"data-messageId":e,"data-action":"url"}}))}for(var M=0;M<m["BLOCKS"].length;M++){var c=m["BLOCKS"][M];var d=null;if(c.USER&&c.USER.length>0){var u=[];for(var f=0;f<c.USER.length;f++){var B=null;if(c.USER[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"network","data-networkId":c.USER[f].NETWORK_ID},html:c.USER[f].NAME})}else if(c.USER[f].BOT_ID){if(this.BXIM.messenger.users[c.USER[f].BOT_ID]){c.USER[f].NAME=this.BXIM.messenger.users[c.USER[f].BOT_ID].name;c.USER[f].AVATAR=this.BXIM.messenger.users[c.USER[f].BOT_ID].avatar}else if(!this.BXIM.messenger.bot[c.USER[f].BOT_ID]){c.USER[f].AVATAR=""}B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"user","data-userId":c.USER[f].BOT_ID},html:c.USER[f].NAME})}else if(c.USER[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax "+(c.USER[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":c.USER[f].USER_ID},html:c.USER[f].NAME});if(this.BXIM.messenger.users[c.USER[f].USER_ID]){c.USER[f].AVATAR=this.BXIM.messenger.users[c.USER[f].USER_ID].avatar}}else if(c.USER[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":c.USER[f].CHAT_ID},html:c.USER[f].NAME})}else if(c.USER[f].LINK){B=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.USER[f].LINK),target:"_blank"},props:{className:"bx-messenger-attach-user-name"},html:c.USER[f].NAME})}else{B=s.create("span",{props:{className:"bx-messenger-attach-user-name"},html:c.USER[f].NAME})}var X="user";if(c.USER[f].AVATAR_TYPE=="CHAT"){X="chat"}else if(c.USER[f].AVATAR_TYPE=="BOT"){X="bot"}var E=s.create("span",{props:{className:"bx-messenger-attach-user"},children:[s.create("span",{props:{className:"bx-messenger-attach-user-avatar"},children:[c.USER[f].AVATAR?s.create("img",{attrs:{src:s.util.htmlspecialcharsback(c.USER[f].AVATAR)},props:{className:"bx-messenger-attach-user-avatar-img"}}):s.create("span",{attrs:{style:"background-color: "+h},props:{className:"bx-messenger-attach-user-avatar-img bx-messenger-attach-"+X+"-avatar-default "}})]}),B]});u.push(E)}d=s.create("span",{props:{className:"bx-messenger-attach-users"},children:u})}else if(c.LINK&&c.LINK.length>0){var C=[];for(var f=0;f<c.LINK.length;f++){var B=s.create("span",{props:{className:"bx-messenger-attach-link-name"},html:c.LINK[f].NAME?c.LINK[f].NAME:c.LINK[f].LINK});if(c.LINK[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":c.LINK[f].NETWORK_ID},children:[B]})}else if(c.LINK[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "+(c.LINK[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":c.LINK[f].USER_ID},children:[B]})}else if(c.LINK[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":c.LINK[f].CHAT_ID},children:[B]})}else{B=s.create("span",{props:{className:"bx-messenger-attach-link-name"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.LINK[f].LINK),target:"_blank"},html:c.LINK[f].NAME?c.LINK[f].NAME:c.LINK[f].LINK})]})}var b=null;if(c.LINK[f].DESC){b=s.create("span",{props:{className:"bx-messenger-attach-link-desc"},html:c.LINK[f].DESC})}var S=null;if(c.LINK[f].HTML){S=s.create("div",{props:{className:"bx-messenger-attach-link-html"},html:c.LINK[f].HTML})}else if(c.LINK[f].PREVIEW){S=s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(c.LINK[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this)"},props:{className:"bx-messenger-attach-image bx-messenger-file-image-link"}})]});S=s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.LINK[f].LINK),target:"_blank"},children:[S]})}var _=s.create("span",{props:{className:"bx-messenger-attach-link"+(c.LINK[f].PREVIEW?" bx-messenger-attach-link-with-preview":"")},children:[B,b,S]});C.push(_)}d=s.create("span",{props:{className:"bx-messenger-attach-links"},children:C})}else if(c.MESSAGE&&c.MESSAGE.length>0){d=s.create("span",{props:{className:"bx-messenger-attach-message"},html:this.decodeBbCode(c.MESSAGE)})}else if(c.HTML&&c.HTML.length>0){d=s.create("span",{props:{className:"bx-messenger-attach-message"},html:c.HTML})}else if(c.GRID&&c.GRID.length>0){var T=[];for(var f=0;f<c.GRID.length;f++){var A=this.decodeBbCode(c.GRID[f].VALUE);if(c.GRID[f].USER_ID){A='<span class="bx-messenger-ajax '+(c.GRID[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+c.GRID[f].USER_ID+'">'+A+"</span>"}else if(c.GRID[f].CHAT_ID){A='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+c.GRID[f].CHAT_ID+'">'+A+"</span>"}else if(c.GRID[f].LINK){A='<a href="'+c.GRID[f].LINK+'" target="_blank">'+A+"</a>"}var v=c.GRID[f].WIDTH?"width: "+c.GRID[f].WIDTH+"px":"";var R=c.GRID[f].HEIGHT?"max-height: "+c.GRID[f].HEIGHT+"px;":"";var L=0;var y=null;var x=null;if(R){x=s.create("div",{props:{className:"bx-messenger-attach bx-messenger-attach-block-name"},attrs:{style:"position: absolute; left: -1000px;"+(c.GRID[f].DISPLAY=="ROW"?v:"")},html:A});document.body.appendChild(x);if(c.GRID[f].HEIGHT>=x.offsetHeight){R=""}else{L=x.offsetHeight}s.remove(x)}if(R){y=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+c.GRID[f].DISPLAY.toLowerCase()+" bx-messenger-attach-block-spoiler"},attrs:{style:c.GRID[f].DISPLAY=="LINE"?v:""},children:[s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:c.GRID[f].DISPLAY=="ROW"?v:""},children:[s.create("span",{props:{className:"bx-messenger-attach-block-spoiler-name"},html:c.GRID[f].NAME}),s.create("span",{props:{className:"bx-messenger-attach-block-spoiler-icon"}})]}),s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:R+(c.GRID[f].COLOR?"color: "+c.GRID[f].COLOR:""),"data-min-height":c.GRID[f].HEIGHT,"data-max-height":L},children:[s.create("span",{html:A})]})]})}else{y=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+c.GRID[f].DISPLAY.toLowerCase()},attrs:{style:c.GRID[f].DISPLAY=="LINE"?v:""},children:[s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:c.GRID[f].DISPLAY=="ROW"?v:""},html:c.GRID[f].NAME}),s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:c.GRID[f].COLOR?"color: "+c.GRID[f].COLOR:""},html:A})]})}T.push(y)}d=s.create("span",{props:{className:"bx-messenger-attach-blocks"},children:T})}else if(c.DELIMITER){var N="";if(c.DELIMITER.SIZE){N+="width: "+c.DELIMITER.SIZE+"px;"}if(c.DELIMITER.COLOR){N+="background-color: "+c.DELIMITER.COLOR}if(N){N={style:N}}d=s.create("span",{props:{className:"bx-messenger-attach-delimiter"},attrs:N})}else if(c.IMAGE&&c.IMAGE.length>0){var w=[];for(var f=0;f<c.IMAGE.length;f++){if(!c.IMAGE[f].NAME){c.IMAGE[f].NAME=""}if(!c.IMAGE[f].PREVIEW){c.IMAGE[f].PREVIEW=c.IMAGE[f].LINK}var D=s.create("a",{props:{className:"bx-messenger-file-image-src"},attrs:{href:s.util.htmlspecialcharsback(c.IMAGE[f].LINK),target:"_blank",title:c.IMAGE[f].NAME},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(c.IMAGE[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this)"},props:{className:"bx-messenger-attach-image bx-messenger-file-image-link"}})]});w.push(D)}d=s.create("span",{props:{className:"bx-messenger-attach-images"},children:w})}else if(c.FILE&&c.FILE.length>0){var O=[];for(var f=0;f<c.FILE.length;f++){var k=c.FILE[f].NAME?c.FILE[f].NAME:c.FILE[f].LINK;if(this.isMobile()){if(k.length>20){k=k.substr(0,7)+"..."+k.substr(k.length-10,k.length)}}else{if(k.length>43){k=k.substr(0,20)+"..."+k.substr(k.length-20,k.length)}}k=s.create("span",{attrs:{title:c.FILE[f].NAME},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:k})]});var U=s.create("div",{props:{className:"bx-messenger-file"},children:[s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[s.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:s.util.htmlspecialcharsback(c.FILE[f].LINK),target:"_blank"},children:[k]}),c.FILE[f].SIZE?s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(c.FILE[f].SIZE)}):null]}),s.create("div",{props:{className:"bx-messenger-file-download"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(c.FILE[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")})]})]});O.push(U)}d=s.create("span",{props:{className:"bx-messenger-attach-files"},children:O})}I.push(d)}if(I.length>0){o.push(s.create("div",{props:{className:"bx-messenger-attach"},attrs:{style:h=="transparent"?"border: 0; padding-left: 0;":"border-color: "+h},children:I}))}}return o};s.MessengerCommon.prototype.diskDrawFiles=function(e,t,r){if(!this.BXIM.disk.enable||!e||!t)return[];var i=[];if(typeof t!="object"){i.push(t)}else{i=t}r=r||{};var n=this.isMobile()?"mobile":this.isDesktop()||this.BXIM.context=="LINES"?"desktop":"default";var a=true;var o=[];for(var l=0;l<i.length;l++){var m=this.BXIM.disk.files[e]&&this.BXIM.disk.files[e][i[l]];if(!m){var m={id:i[l],chatId:e};var h=r.boxId?r.boxId:"im-file";o.push(s.create("div",{attrs:{id:h+"-"+m.id,"data-chatId":m.chatId,"data-fileId":m.id,"data-boxId":h},props:{className:"bx-messenger-file"},children:[s.create("span",{props:{className:"bx-messenger-file-deleted"},html:s.message("IM_F_DELETED")})]}));continue}if(r.status){if(typeof r.status!="object"){r.status=[r.status]}if(!s.util.in_array(m.status,r.status)){continue}}var g=null;if(m.type=="image"&&(m.preview||m.urlPreview[n])){var I=null;if(this.isMobile()&&m.preview&&typeof m.preview!="string"){if(m.urlPreview[n]){var I=s.create("div",{attrs:{src:m.urlPreview[n]},props:{className:"bx-messenger-file-image-text bx-messenger-hide"}})}}var p=null;if(m.preview&&typeof m.preview!="string"){p=m.preview;if(m.urlPreview[n]){m.preview=""}}else{p=s.create("img",{attrs:{src:m.urlPreview[n]?m.urlPreview[n]:m.preview,height:!m.image||m.image.height>500?"500":m.image.height},props:{className:"bx-messenger-file-image-text"},events:{load:function(){this.parentNode.style.background="#fff";this.removeAttribute("height")}}})}if(a&&m.urlShow[n]){if(this.isMobile()&&m.urlPreview[n]){g=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{events:{click:s.delegate(function(){this.BXIM.messenger.openPhotoGallery(m.urlPreview[n])},this)},props:{className:"bx-messenger-file-image-src"},children:[I,p]})]}),s.create("br")]})}else{g=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("a",{attrs:{href:m.urlShow[n],target:"_blank"},props:{className:"bx-messenger-file-image-src"},children:[p]})]}),s.create("br")]})}}else{g=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[p]})]}),s.create("br")]})}}var M=m.name;if(this.isMobile()){if(M.length>20){M=M.substr(0,7)+"..."+M.substr(M.length-10,M.length)}}else{if(M.length>43){M=M.substr(0,20)+"..."+M.substr(M.length-20,M.length)}}var c=s.create("span",{attrs:{title:m.name},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:M})]});if(a&&(m.urlShow[n]||m.urlDownload[n])){if(this.isMobile())c=s.create("span",{props:{className:"bx-messenger-file-title-href"},events:{click:function(){s.localStorage.set("impmh",true,1);app.openDocument({url:m.urlDownload["mobile"],filename:M})}},children:[c]});else c=s.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:m.urlShow?m.urlShow[n]:m.urlDownload[n],target:"_blank"},children:[c]})}c=s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[c,s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(m.size)})]});var d=null;if(m.status=="done"){if(!this.isMobile()){d=s.create("div",{props:{className:"bx-messenger-file-download"},children:[!m.urlDownload||!a?null:s.create("a",{attrs:{href:m.urlDownload[n],target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")}),!m.urlDownload||!this.BXIM.disk.enable||this.BXIM.context=="LINES"?null:s.create("span",{props:{className:"bx-messenger-file-download-link bx-messenger-file-download-disk"},html:s.message("IM_F_DOWNLOAD_DISK"),events:{click:s.delegate(function(){var e=s.proxy_context.parentNode.parentNode.getAttribute("data-chatId");var t=s.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var r=s.proxy_context.parentNode.parentNode.getAttribute("data-boxId");this.BXIM.disk.saveToDisk(e,t,{boxId:r})},this)}})]})}else{d=s.create("div",{props:{className:"bx-messenger-file-download"},children:[]})}}else if(m.status=="upload"){var u={};var f="";var B=null;var X="";var E="";if(m.authorId==this.BXIM.userId&&m.progress>=0){E=s.message("IM_F_UPLOAD_2").replace("#PERCENT#",m.progress);u={width:m.progress+"%"};B=s.create("span",{attrs:{title:s.message("IM_F_CANCEL")},props:{className:"bx-messenger-file-delete"}})}else{E=s.message("IM_F_UPLOAD");X=" bx-messenger-file-progress-infinite"}d=s.create("div",{props:{className:"bx-messenger-progress-box"},children:[s.create("span",{attrs:{title:E},props:{className:"bx-messenger-file-progress"},children:[s.create("span",{props:{className:"bx-messenger-file-progress-line"+X},style:u})]}),B]})}else if(m.status=="error"){d=s.create("span",{props:{className:"bx-messenger-file-status-error"},html:m.errorText?m.errorText:s.message("IM_F_ERROR")})}if(!d)return false;if(i.length==1&&r.showInner=="Y"){o=[g,c,d]}else{var h=r.boxId?r.boxId:"im-file";o.push(s.create("div",{attrs:{id:h+"-"+m.id,"data-chatId":m.chatId,"data-fileId":m.id,"data-boxId":h},props:{className:"bx-messenger-file"},children:[g,c,d]}))}}return o};s.MessengerCommon.prototype.diskRedrawFile=function(e,t,r){r=r||{};var i=r.boxId?r.boxId:"im-file";var n=s(i+"-"+t);if(n){var a=this.diskDrawFiles(e,t,{showInner:"Y",boxId:i});if(a){n.innerHTML="";s.adjust(n,{children:a})}}};s.MessengerCommon.prototype.diskChatDialogFileInited=function(e,t,r){r.messageText=r.messageText||"";var i=r.form.CHAT_ID.value;if(!this.BXIM.disk.files[i])this.BXIM.disk.files[i]={};this.BXIM.disk.files[i][e]={id:e,tempId:e,chatId:i,date:s.MessengerCommon.getNowDate(),type:t.isImage?"image":"file",preview:t.isImage?t.canvas:"",name:t.name,size:t.file.size,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.BXIM.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};if(!this.BXIM.disk.filesRegister[i])this.BXIM.disk.filesRegister[i]={};this.BXIM.disk.filesRegister[i][e]={id:e,type:this.BXIM.disk.files[i][e].type,mimeType:t.file.type,name:this.BXIM.disk.files[i][e].name,size:this.BXIM.disk.files[i][e].size};this.diskChatDialogFileRegister(i,r.messageText)};s.MessengerCommon.prototype.diskChatDialogFileRegister=function(t,r){r=r||"";clearTimeout(this.BXIM.disk.timeout[t]);this.BXIM.disk.timeout[t]=setTimeout(s.delegate(function(){var i=0;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].type!="private"){i="chat"+t}else{for(var n in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[n]==t){i=n;break}}}if(!i)return false;var a="N";if(i.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[t]){a="Y"}var o=[];for(var l in this.BXIM.disk.filesRegister[t]){o.push(l)}var m="tempFile"+this.BXIM.disk.fileTmpId;this.BXIM.messenger.message[m]={id:m,chatId:t,senderId:this.BXIM.userId,recipientId:i,date:s.MessengerCommon.getNowDate(),text:s.MessengerCommon.prepareText(r,true),params:{FILE_ID:o,CLASS:a=="Y"?"bx-messenger-content-item-system":""}};if(!this.BXIM.messenger.showMessage[i])this.BXIM.messenger.showMessage[i]=[];this.BXIM.messenger.showMessage[i].push(m);s.MessengerCommon.drawMessage(i,this.BXIM.messenger.message[m]);s.MessengerCommon.drawProgessMessage(m);this.recentListAdd({id:m,date:s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),skipDateCheck:true,recipientId:i,senderId:this.BXIM.userId,text:r?r:"["+s.message("IM_F_FILE")+"]",userId:i,userIsChat:i.toString().substr(0,4)=="chat",params:{}},true);this.BXIM.messenger.sendMessageFlag++;this.BXIM.messenger.popupMessengerFileFormInput.setAttribute("disabled",true);this.BXIM.disk.OldBeforeUnload=e.onbeforeunload;e.onbeforeunload=function(){if(typeof s.PULL!="undefined"&&typeof s.PULL.tryConnectDelay=="function"){s.PULL.tryConnectDelay()}return s.message("IM_F_EFP")};s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_REGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_REGISTER:"Y",CHAT_ID:t,RECIPIENT_ID:i,TEXT:r,MESSAGE_TMP_ID:m,FILES:JSON.stringify(this.BXIM.disk.filesRegister[t]),OL_SILENT:a,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(r.ERROR!=""){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[m];s.MessengerCommon.drawTab(i);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;this.BXIM.disk.filesRegister[t]={};if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear();return false}this.BXIM.messenger.sendMessageFlag--;var n=[];var a={};for(var o in r.FILE_ID){var l=r.FILE_ID[o];delete this.BXIM.disk.filesRegister[r.CHAT_ID][l.TMP_ID];if(parseInt(l.FILE_ID)>0){a[l.TMP_ID]=l.FILE_ID;this.BXIM.disk.filesProgress[l.TMP_ID]=l.FILE_ID;this.BXIM.disk.filesMessage[l.TMP_ID]=r.MESSAGE_ID;this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]={};for(var h in this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID])this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID][h]=this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID][h];this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]["id"]=l.FILE_ID;delete this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID];this.BXIM.disk.files[r.CHAT_ID][l.FILE_ID]["name"]=l.FILE_NAME;if(s("im-file-"+l.TMP_ID)){s("im-file-"+l.TMP_ID).setAttribute("data-fileId",l.FILE_ID);s("im-file-"+l.TMP_ID).id="im-file-"+l.FILE_ID;s.MessengerCommon.diskRedrawFile(r.CHAT_ID,l.FILE_ID)}n.push(l.FILE_ID)}else{this.BXIM.disk.files[r.CHAT_ID][l.TMP_ID]["status"]="error";s.MessengerCommon.diskRedrawFile(r.CHAT_ID,l.TMP_ID)}}this.BXIM.messenger.message[r.MESSAGE_ID]=s.clone(this.BXIM.messenger.message[r.MESSAGE_TMP_ID]);this.BXIM.messenger.message[r.MESSAGE_ID]["id"]=r.MESSAGE_ID;this.BXIM.messenger.message[r.MESSAGE_ID]["params"]["FILE_ID"]=n;if(r.MESSAGE_TEXT){this.BXIM.messenger.message[r.MESSAGE_ID]["text"]=r.MESSAGE_TEXT}if(this.BXIM.messenger.popupMessengerLastMessage==r.MESSAGE_TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=r.MESSAGE_ID;delete this.BXIM.messenger.message[r.MESSAGE_TMP_ID];var g=s.util.array_search(""+r.MESSAGE_TMP_ID+"",this.BXIM.messenger.showMessage[r.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[r.RECIPIENT_ID][g])this.BXIM.messenger.showMessage[r.RECIPIENT_ID][g]=""+r.MESSAGE_ID+"";if(s("im-message-"+r.MESSAGE_TMP_ID)){if(r.MESSAGE_TEXT){s("im-message-"+r.MESSAGE_TMP_ID).innerHTML=r.MESSAGE_TEXT}s("im-message-"+r.MESSAGE_TMP_ID).id="im-message-"+r.MESSAGE_ID;var I=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+r.MESSAGE_TMP_ID}},true);if(I){I.setAttribute("data-messageid",""+r.MESSAGE_ID+"");if(I.getAttribute("data-blockmessageid")==""+r.MESSAGE_TMP_ID)I.setAttribute("data-blockmessageid",""+r.MESSAGE_ID+"")}else{var p=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.MESSAGE_TMP_ID}},true);if(p){p.setAttribute("data-blockmessageid",""+r.MESSAGE_ID+"")}}var M=s.findChildByClassName(I,"bx-messenger-content-item-date");if(M)M.innerHTML=" &nbsp; "+s.MessengerCommon.formatDate(this.BXIM.messenger.message[r.MESSAGE_ID].date,s.MessengerCommon.getDateFormatType("MESSAGE"))}s.MessengerCommon.clearProgessMessage(r.MESSAGE_ID);if(this.BXIM.messenger.history[r.RECIPIENT_ID])this.BXIM.messenger.history[r.RECIPIENT_ID].push(r.MESSAGE_ID);else this.BXIM.messenger.history[r.RECIPIENT_ID]=[r.MESSAGE_ID];var c="N";if(r.RECIPIENT_ID.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[r.CHAT_ID]){c="Y"}this.BXIM.messenger.popupMessengerFileFormRegChatId.value=r.CHAT_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageId.value=r.MESSAGE_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageHidden.value=c;this.BXIM.messenger.popupMessengerFileFormRegParams.value=JSON.stringify(a);this.BXIM.disk.formAgents["imDialog"].submit();this.BXIM.messenger.popupMessengerFileFormInput.removeAttribute("disabled")},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[m];this.BXIM.disk.filesRegister[t]={};s.MessengerCommon.drawTab(i);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear()},this)});this.BXIM.disk.fileTmpId++},this),500)};s.MessengerCommon.prototype.diskChatDialogFileStart=function(e,t,r,i){var n=this.BXIM.disk.filesProgress[e.id];var a=r.streams.packages.getItem(i).data;if(!this.BXIM.disk.files[a.REG_CHAT_ID][n])return false;this.BXIM.disk.files[a.REG_CHAT_ID][n].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(a.REG_CHAT_ID,n)};s.MessengerCommon.prototype.diskChatDialogFileProgress=function(e,t,r,i){var n=this.BXIM.disk.filesProgress[e.id];var a=r.streams.packages.getItem(i).data;if(!this.BXIM.disk.files[a.REG_CHAT_ID][n])return false;this.BXIM.disk.files[a.REG_CHAT_ID][n].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(a.REG_CHAT_ID,n)};s.MessengerCommon.prototype.diskChatDialogFileDone=function(t,r,i,n){if(!this.BXIM.disk.files[r.file.fileChatId][r.file.fileId])return false;if(this.BXIM.disk.files[r.file.fileChatId]&&this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]){r.file.fileParams["preview"]=this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]["preview"]}if(!this.BXIM.disk.files[r.file.fileChatId])this.BXIM.disk.files[r.file.fileChatId]={};this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]=r.file.fileParams;s.MessengerCommon.diskRedrawFile(r.file.fileChatId,r.file.fileId);delete this.BXIM.disk.filesMessage[r.file.fileTmpId];e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};s.MessengerCommon.prototype.diskChatDialogFileError=function(t,r,i,n){var a=this.BXIM.disk.filesProgress[t.id];var o=i.streams.packages.getItem(n).data;if(!this.BXIM.disk.files[o.REG_CHAT_ID][a])return false;t.deleteFile();this.BXIM.disk.files[o.REG_CHAT_ID][a].status="error";this.BXIM.disk.files[o.REG_CHAT_ID][a].errorText=r.error;s.MessengerCommon.diskRedrawFile(o.REG_CHAT_ID,a);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};s.MessengerCommon.prototype.diskChatDialogUploadError=function(t,r,i){var n=t.post.REG_PARAMS?JSON.parse(t.post.REG_PARAMS):{};var a={};for(var o in n){if(this.BXIM.disk.filesMessage[o]){delete this.BXIM.disk.filesMessage[o]}if(this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID]){delete this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID][o];delete this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID][n[o]]}if(this.BXIM.disk.files[t.post.REG_CHAT_ID]){if(this.BXIM.disk.files[t.post.REG_CHAT_ID][n[o]]){this.BXIM.disk.files[t.post.REG_CHAT_ID][n[o]].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,n[o])}if(this.BXIM.disk.files[t.post.REG_CHAT_ID][o]){this.BXIM.disk.files[t.post.REG_CHAT_ID][o].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,o)}}delete this.BXIM.disk.filesProgress[o]}s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_UNREGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_UNREGISTER:"Y",CHAT_ID:t.post.REG_CHAT_ID,FILES:t.post.REG_PARAMS,MESSAGES:JSON.stringify(a),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;s.MessengerCommon.drawTab(this.getRecipientByChatId(t.post.REG_CHAT_ID))};s.MessengerCommon.prototype.pullPhoneEvent=function(){var e=s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command;console.info("pull info: ",e,t)}if(e=="invite"){if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive){return false}if(s.localStorage.get("viInitedCall")||s.localStorage.get("viExternalCard")){return false}if(this.isMobile()||this.isDesktop()||!this.BXIM.desktopStatus){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;if(this.BXIM.webrtc.phonePortalCall&&t.portalCallData){for(var r in t.portalCallData.users)this.BXIM.messenger.users[r]=t.portalCallData.users[r];for(var r in t.portalCallData.hrphoto)this.BXIM.messenger.hrphoto[r]=t.portalCallData.hrphoto[r];t.callerId=this.BXIM.messenger.users[t.portalCallUserId].name;t.phoneNumber="";if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:t.portalCallData.users[t.portalCallUserId].name,PHOTO:t.portalCallData.users[t.portalCallUserId].avatar}}}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallTime=0;this.BXIM.repeatSound("ringtone",5e3);if(this.isPage()){s.MessengerWindow.changeTab("im")}s.MessengerCommon.phoneCommand("wait",{CALL_ID:t.callId,DEBUG_INFO:this.getDebugInfo()});this.BXIM.webrtc.phoneIncomingWait({chatId:t.chatId,callId:t.callId,callerId:t.callerId,companyPhoneNumber:t.phoneNumber,isCallback:t.isCallback,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,config:t.config})}}else if(e=="answer_self"){if(this.BXIM.webrtc.callSelfDisabled||this.BXIM.webrtc.phoneCallId!=t.callId)return false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.isMobile()){this.BXIM.webrtc.callOverlayClose()}else{this.BXIM.webrtc.phoneCallView.autoClose()}this.BXIM.webrtc.callInit=true;this.BXIM.webrtc.phoneCallId=t.callId}else if(e=="timeout"){if(this.BXIM.webrtc.phoneCallId!=t.callId)return false;clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");var i=this.BXIM.webrtc.phoneCallExternal;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;var n=this.BXIM.webrtc.phoneNumber;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle,{failedCode:t.failedCode})}if(i&&t.failedCode==486){if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.CALLBACK)}else{this.BXIM.webrtc.phoneCallView.setProgress("offline");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.sipPhoneError)}}else if(i&&t.failedCode==480){if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{this.BXIM.webrtc.phoneCallView.setProgress("error");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.sipPhoneError)}}else{if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_DECLINE"));this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{if(this.BXIM.webrtc.phoneCallView){if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setStatusText("");this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.autoClose()}}}}}else if(e=="outgoing"){if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(!this.isMobile()&&this.BXIM.desktopStatus&&!this.isDesktop())return false;this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;if(this.BXIM.webrtc.callInit&&(this.BXIM.webrtc.phoneNumber==t.phoneNumber||t.phoneNumber.indexOf(this.BXIM.webrtc.phoneNumber)>=0)){this.BXIM.webrtc.phoneNumber=t.phoneNumber;if(t.external&&this.BXIM.webrtc.phoneCallId==t.callIdTmp||!this.BXIM.webrtc.phoneCallId){this.BXIM.webrtc.phoneCallExternal=t.external?true:false;if(this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallView.setProgress("connect");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_WAIT_ANSWER"))}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm()}else if(this.BXIM.webrtc.phoneCallView){if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl});this.BXIM.webrtc.phoneCallView.setConfig(t.config);this.BXIM.webrtc.phoneCallView.setCallId(t.callId);this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}if(this.BXIM.webrtc.phonePortalCall&&this.BXIM.messenger.users[t.portalCallUserId]){if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:t.portalCallData.users[t.portalCallUserId].name,PHOTO:t.portalCallData.users[t.portalCallUserId].avatar
}}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setPortalCall(true);this.BXIM.webrtc.phoneCallView.setPortalCallData(t.portalCallData);this.BXIM.webrtc.phoneCallView.setPortalCallUserId(t.portalCallUserId)}}}else if(!this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneDisplayExternal({callId:t.callId,config:t.config?t.config:{},phoneNumber:t.phoneNumber,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId})}}else if(e=="start"){if(this.BXIM.webrtc.phoneCallId!=t.callId)return false;this.BXIM.webrtc.callOverlayTimer("start");this.BXIM.stopRepeatSound("ringtone");if(this.BXIM.webrtc.phoneCallId==t.callId&&this.BXIM.webrtc.phoneCallDevice=="PHONE"&&(this.BXIM.webrtc.phoneCallDevice==t.callDevice||this.BXIM.webrtc.phonePortalCall)){this.BXIM.webrtc.phoneOnCallConnected()}else if(this.BXIM.webrtc.phoneCallId==t.callId&&t.callDevice=="PHONE"&&this.BXIM.webrtc.phoneIncoming){this.BXIM.webrtc.phoneCallDevice="PHONE";this.BXIM.webrtc.phoneOnCallConnected()}if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}if(this.BXIM.webrtc.phoneNumber!=""){this.BXIM.webrtc.phoneNumberLast=this.BXIM.webrtc.phoneNumber;this.BXIM.setLocalConfig("phone_last",this.BXIM.webrtc.phoneNumber)}}else if(e=="hold"||e=="unhold"){if(this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.phoneHolded=e=="hold"}}else if(e=="update_crm"){if(this.BXIM.webrtc.phoneCallId==t.callId&&t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm();if(this.BXIM.webrtc.callNotify)this.BXIM.webrtc.callNotify.adjustPosition()}else if(this.BXIM.webrtc.phoneCallView){if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}else if(e=="inviteTransfer"){if(this.isMobile())return false;if(this.isMobile()&&t["PULL_TIME_AGO"]&&t["PULL_TIME_AGO"]>30)return false;if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive)return false;if(this.isDesktop()||!this.BXIM.desktopStatus){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}this.BXIM.repeatSound("ringtone",5e3);s.MessengerCommon.phoneCommand("waitTransfer",{CALL_ID:t.callId});this.BXIM.webrtc.phoneTransferEnabled=true;this.BXIM.webrtc.phoneIncomingWait({chatId:t.chatId,callId:t.callId,callerId:t.callerId,companyPhoneNumber:t.phoneNumber,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,config:t.config})}}else if(e=="cancelTransfer"||e=="timeoutTransfer"){if(this.BXIM.webrtc.phoneCallId==t.callId&&!this.BXIM.webrtc.callSelfDisabled){this.BXIM.webrtc.callInit=false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.isMobile())this.BXIM.webrtc.callOverlayClose();else this.BXIM.webrtc.phoneCallView.autoClose()}}else if(e=="declineTransfer"){if(this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.errorInviteTransfer()}}else if(e=="completeTransfer"){if(this.BXIM.webrtc.phoneCallId==t.callId){if(t.transferUserId!=this.BXIM.userId||this.isMobile()){this.BXIM.webrtc.successInviteTransfer()}else{this.BXIM.webrtc.phoneTransferEnabled=false;s.localStorage.set("vite",false,1);if(t.callDevice=="PHONE"){this.BXIM.stopRepeatSound("ringtone");if(this.isMobile()){this.BXIM.messenger.openMessenger(this.BXIM.messenger.currentTab)}this.BXIM.webrtc.phoneCallDevice="PHONE";this.BXIM.webrtc.phoneOnCallConnected()}if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}}}}else if(e=="phoneDeviceActive"){this.BXIM.webrtc.phoneDeviceActive=t.active=="Y"}else if(e=="replaceCallerId"){var a=s.message("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",t.callerId);this.BXIM.webrtc.setCallOverlayTitle(a);if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}}else if(e=="showExternalCall"){if(this.isMobile())return false;if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive)return false;if(s.localStorage.get("viInitedCall")||s.localStorage.get("viExternalCard")){return false}if(this.isDesktop()||!this.BXIM.desktopStatus){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.showExternalCall({callId:t.callId,fromUserId:t.fromUserId,toUserId:t.toUserId,phoneNumber:t.phoneNumber,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,config:t.config,portalCall:t.portalCall,portalCallData:t.portalCallData,portalCallUserId:t.portalCallUserId})}}else if(e=="hideExternalCall"){if(this.isMobile())return false;if(!s.localStorage.get("viExternalCard"))return false;if(this.BXIM.webrtc.callActive&&this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.hideExternalCall()}}},this);if(this.isMobile()){BXMobileApp.addCustomEvent("onPull-voximplant",e)}else{s.addCustomEvent("onPullEvent-voximplant",e)}};s.MessengerCommon.prototype.phoneCommand=function(e,t,r,i){if(!this.BXIM.webrtc.phoneSupport())return false;r=r!=false;t=typeof t=="object"?t:{};s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_SHARED&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,async:r,data:{IM_PHONE:"Y",COMMAND:e,PARAMS:JSON.stringify(t),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:function(e){if(s.type.isFunction(i)){i(e)}}});return true};s.MessengerCommon.prototype.phoneCorrect=function(e){e=s.util.trim(e.toString());if(e.substr(0,2)=="+8"&&e.length>10){e="008"+e.substr(2)}e=e.replace(/[^0-9\*]/g,"");if(e.substr(0,2)=="80"||e.substr(0,2)=="81"||e.substr(0,2)=="82"){}else if(e.substr(0,2)=="00"&&e.length>=9){e=e.substr(2)}else if(e.substr(0,3)=="011"&&e.length>=10){e=e.substr(3)}else if(e.substr(0,1)=="8"&&e.length>=11){e="7"+e.substr(1)}else if(e.substr(0,1)=="0"&&e.length>=8){e=e.substr(1)}return e};s.MessengerCommon.prototype.phoneOnIncomingCall=function(e){if(this.BXIM.webrtc.phoneCurrentCall)return false;var t={};if(this.isMobile()){t=s.MobileVoximplantCall.events}else{t=VoxImplant.CallEvents}this.BXIM.webrtc.phoneCurrentCall=e.call;this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.answer()};s.MessengerCommon.prototype.phoneCallStart=function(){this.BXIM.webrtc.phoneParams["CALLER_ID"]="";this.BXIM.webrtc.phoneParams["USER_ID"]=this.BXIM.userId;this.BXIM.webrtc.phoneLog("Call params: ",this.BXIM.webrtc.phoneNumber,this.BXIM.webrtc.phoneParams);if(!this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneOnSDKReady();return false}if(!this.isMobile()&&false){this.BXIM.webrtc.phoneCurrentCall=true;this.BXIM.webrtc.callActive=true;this.BXIM.webrtc.phoneOnCallConnected();this.BXIM.webrtc.phoneCrm.FOUND="N";this.BXIM.webrtc.phoneCrm.CONTACT_URL="#";this.BXIM.webrtc.phoneCrm.LEAD_URL="#";this.BXIM.webrtc.callOverlayDrawCrm()}else{var e={};if(this.isMobile()){e=s.MobileVoximplantCall.events}else{e=VoxImplant.CallEvents;this.BXIM.webrtc.phoneAPI.setOperatorACDStatus("ONLINE")}this.BXIM.webrtc.phoneCurrentCall=this.BXIM.webrtc.phoneAPI.call(this.BXIM.webrtc.phoneNumber,false,JSON.stringify(this.BXIM.webrtc.phoneParams));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStart,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStart,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStop,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStop,this.BXIM.webrtc));if(this.isMobile()){this.BXIM.webrtc.phoneCurrentCall.start()}}s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_INIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"init",NUMBER:this.BXIM.webrtc.phoneNumber,NUMBER_USER:s.util.htmlspecialcharsback(this.BXIM.webrtc.phoneNumberUser),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(!(e.HR_PHOTO.length==0)){for(var s in e.HR_PHOTO)this.BXIM.messenger.hrphoto[s]=e.HR_PHOTO[s];this.BXIM.webrtc.callOverlayUserId=e.DIALOG_ID}else{this.BXIM.webrtc.callOverlayChatId=e.DIALOG_ID.substr(4)}}},this)})};s.MessengerCommon.prototype.phoneCallFinish=function(){clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");clearInterval(this.BXIM.webrtc.phoneCallTimeInterval);this.BXIM.webrtc.callOverlayTimer("pause");if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){s.MessengerCommon.phoneCommand("deviceHungup",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneTransferEnabled&&this.BXIM.webrtc.phoneTransferUser==0){s.MessengerCommon.phoneCommand("declineTransfer",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneIncoming){s.MessengerCommon.phoneCommand("skip",{CALL_ID:this.BXIM.webrtc.phoneCallId})}if(!this.isMobile()){this.BXIM.desktop.closeTopmostWindow()}if(this.BXIM.webrtc.phoneCurrentCall){try{this.BXIM.webrtc.phoneCurrentCall.hangup()}catch(e){}this.BXIM.webrtc.phoneCurrentCall=null;this.BXIM.webrtc.phoneLog("Call hangup call")}else if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}if(this.isMobile()){}else{if(this.BXIM.webrtc.popupKeyPad)this.BXIM.webrtc.popupKeyPad.close();if(this.BXIM.webrtc.popupTransferDialog)this.BXIM.webrtc.popupTransferDialog.close();s.localStorage.set("vite",false,1)}this.BXIM.webrtc.phoneRinging=0;this.BXIM.webrtc.phoneIncoming=false;this.BXIM.webrtc.phoneCallId="";this.BXIM.webrtc.phoneCallExternal=false;this.BXIM.webrtc.phoneCallDevice="WEBRTC";this.BXIM.webrtc.phoneNumber="";this.BXIM.webrtc.phoneNumberUser="";this.BXIM.webrtc.phoneParams={};this.BXIM.webrtc.callOverlayOptions={};this.BXIM.webrtc.phoneMicMuted=false;this.BXIM.webrtc.phoneHolded=false;this.BXIM.webrtc.phoneMicAccess=false;this.BXIM.webrtc.phoneTransferUser=0;this.BXIM.webrtc.phoneTransferEnabled=false};s.MessengerCommon.prototype.phoneAuthorize=function(){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_AUTHORIZE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_PHONE:"Y",COMMAND:"authorize",UPDATE_INFO:this.BXIM.webrtc.phoneCheckBalance?"Y":"N",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.webrtc.phoneCheckBalance=false;if(t.HR_PHOTO){for(var r in t.HR_PHOTO)this.BXIM.messenger.hrphoto[r]=t.HR_PHOTO[r]}if(this.isMobile()){this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER;this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);s.MobileVoximplant.loginWithOneTimeKey(t.LOGIN+"@"+t.SERVER,t.HASH)}else{this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER}this.BXIM.webrtc.phoneCallerID=t.CALLERID;this.BXIM.webrtc.phoneApiInit()}else if(t.ERROR=="AUTHORIZE_ERROR"&&(this.isDesktop()||this.isMobile())&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.phoneAuthorize()},this),5e3);s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.phoneAuthorize()},this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.phoneLog("onetimekey",t.ERROR,t.CODE);if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR]);this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"))}else{this.BXIM.webrtc.callAbort(t.ERROR+(this.BXIM.webrtc.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+t.CODE+")":""))}if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}},this),onfailure:s.delegate(function(){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))},this)})};s.MessengerCommon.prototype.phoneOnAuthResult=function(e){if(e.result){if(this.BXIM.webrtc.phoneCallDevice=="PHONE")return false;this.BXIM.webrtc.phoneLog("Authorize result","success");if(this.BXIM.webrtc.phoneIncoming){s.MessengerCommon.phoneCommand(this.BXIM.webrtc.phoneTransferEnabled?"readyTransfer":"ready",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInitUserId==this.BXIM.userId){s.MessengerCommon.phoneCallStart()}}else if(!this.isMobile()&&e.code==302){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_ONETIMEKEY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"onetimekey",KEY:e.key,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);this.BXIM.webrtc.phoneAPI.loginWithOneTimeKey(this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer,e.HASH)}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("onetimekey",e.ERROR,e.CODE);if(e.CODE)this.BXIM.webrtc.callAbort(s.message("IM_PHONE_ERROR_CONNECT"));else this.BXIM.webrtc.callAbort(e.ERROR+(this.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+e.CODE+")":""));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}},this),onfailure:s.delegate(function(){this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"));this.BXIM.webrtc.phoneCallFinish()},this)})}else{if(e.code==401||e.code==400||e.code==403||e.code==404||e.code==302){this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"));this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true;s.MessengerCommon.phoneCommand("authorize_error")}else{this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))}this.BXIM.webrtc.callOverlayProgress("offline");if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("Authorize result","failed",e.code);this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin=""}};s.MessengerCommon.prototype.phoneOnCallFailed=function(e){this.BXIM.webrtc.phoneLog("Call failed",e.code,e.reason);var t=s.message("IM_PHONE_END");if(e.code==603){t=s.message("IM_PHONE_DECLINE")}else if(e.code==380){t=s.message("IM_PHONE_ERR_SIP_LICENSE")}else if(e.code==436){t=s.message("IM_PHONE_ERR_NEED_RENT")}else if(e.code==438){t=s.message("IM_PHONE_ERR_BLOCK_RENT")}else if(e.code==400){t=s.message("IM_PHONE_ERR_LICENSE")}else if(e.code==401){t=s.message("IM_PHONE_401")}else if(e.code==480||e.code==503){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){t=s.message("IM_PHONE_NO_EMERGENCY")}else{t=s.message("IM_PHONE_UNAVAILABLE")}}else if(e.code==484||e.code==404){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){t=s.message("IM_PHONE_NO_EMERGENCY")}else{t=s.message("IM_PHONE_INCOMPLETED")}}else if(e.code==402){t=s.message("IM_PHONE_NO_MONEY")+(this.BXIM.isAdmin?" "+s.message("IM_PHONE_PAY_URL_NEW"):"")}else if(e.code==486&&this.BXIM.webrtc.phoneRinging>1){t=s.message("IM_M_CALL_ST_DECLINE")}else if(e.code==486){t=s.message("IM_PHONE_ERROR_BUSY")}else if(e.code==403){t=s.message("IM_PHONE_403");this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true}this.BXIM.webrtc.phoneCallFinish();if(e.code==408||e.code==403){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}}this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(t);if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}};s.MessengerCommon.prototype.phoneOnCallDisconnected=function(e){this.BXIM.webrtc.phoneLog("Call disconnected",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.id():"-",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.state():"-");if(this.BXIM.webrtc.phoneCurrentCall){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_END"));if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{this.BXIM.playSound("stop");this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle);if(this.BXIM.webrtc.isCallListMode())this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.outgoing);else this.BXIM.webrtc.phoneCallView.autoClose()}}if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()},this),500)}};s.MessengerCommon.prototype.phoneOnProgressToneStart=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone start",this.BXIM.webrtc.phoneCurrentCall.id());this.BXIM.webrtc.phoneRinging++;this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_WAIT_ANSWER"))};s.MessengerCommon.prototype.phoneOnProgressToneStop=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone stop",this.BXIM.webrtc.phoneCurrentCall.id())};s.MessengerCommon.prototype.phoneOnConnectionEstablished=function(e){this.BXIM.webrtc.phoneLog("Connection established",this.BXIM.webrtc.phoneAPI.connected())};s.MessengerCommon.prototype.phoneOnConnectionFailed=function(e){this.BXIM.webrtc.phoneLog("Connection failed");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))};s.MessengerCommon.prototype.phoneOnConnectionClosed=function(e){this.BXIM.webrtc.phoneLog("Connection closed");this.BXIM.webrtc.phoneSDKinit=false};s.MessengerCommon.prototype.phoneOnMicResult=function(e){this.BXIM.webrtc.phoneMicAccess=e.result;this.BXIM.webrtc.phoneLog("Mic Access Allowed",e.result);if(!this.isMobile()){clearTimeout(this.BXIM.webrtc.callDialogAllowTimeout);if(this.BXIM.webrtc.callDialogAllow)this.BXIM.webrtc.callDialogAllow.close()}if(e.result){this.BXIM.webrtc.callOverlayProgress("connect");this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_CONNECT"))}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ST_NO_ACCESS"));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}};s.MessengerCommon.prototype.phoneOnNetStatsReceived=function(e){if(!this.BXIM.webrtc.phoneCurrentCall||this.BXIM.webrtc.phoneCurrentCall.state()!="CONNECTED")return false;var s=100-parseInt(e.stats.packetLoss);var t=this.BXIM.webrtc.callPhoneOverlayMeter(s);this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"meter",PACKETLOSS:e.stats.packetLoss,PERCENT:s,GRADE:t}))};s.MessengerCommon.prototype.phoneHold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;this.BXIM.webrtc.phoneHolded=true;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};s.MessengerCommon.prototype.phoneUnhold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;this.BXIM.webrtc.phoneHolded=false;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};s.MessengerCommon.prototype.phoneToggleHold=function(e){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;if(typeof e!="undefined"){this.BXIM.webrtc.phoneHolded=!e}if(this.BXIM.webrtc.phoneHolded){if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}else{if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}this.BXIM.webrtc.phoneHolded=!this.BXIM.webrtc.phoneHolded};s.MessengerCommon.prototype.phoneSendDTMF=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Send DTMF code",this.BXIM.webrtc.phoneCurrentCall.id(),e);this.BXIM.webrtc.phoneCurrentCall.sendTone(e)};s.MessengerCommon.prototype.phoneStartCallViaRestApp=function(e,t){s.MessengerCommon.phoneCommand("startCallViaRest",{NUMBER:e,PARAMS:t})};s.MessengerCommon.prototype.getHrPhoto=function(e,s){var t="";if(e=="phone"){t="/bitrix/js/im/images/hidef-phone-v3.png"}else if(this.BXIM.messenger.hrphoto[e]){t=this.BXIM.messenger.hrphoto[e];if(this.BXIM.messenger.hrphoto[e]!="/bitrix/js/im/images/hidef-avatar-v3.png"){s=""}}else if(!this.BXIM.messenger.users[e]||this.BXIM.messenger.users[e].avatar==this.BXIM.pathToBlankImage){t="/bitrix/js/im/images/hidef-avatar-v3.png"}else{t=this.BXIM.messenger.users[e].avatar;s=""}return{src:t,color:s}};s.MessengerCommon.prototype.linesBodyScroll=function(){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();s.defer(function(){(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:600,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(s.MessengerCommon.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()},this)()}else{s.defer(function(){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(s.MessengerCommon.isMobile()?0:1)},this)()}};s.MessengerCommon.prototype.linesGetSessionHistory=function(t){s.ajax({url:this.BXIM.pathToAjax+"?SESSION_GET_HISTORY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"sessionGetHistory",SESSION_ID:t,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){for(var r in t.FILES){if(!this.BXIM.messenger.disk.files[t.CHAT_ID])this.BXIM.messenger.disk.files[t.CHAT_ID]={};if(this.BXIM.messenger.disk.files[t.CHAT_ID][r])continue;t.FILES[r].date=parseInt(t.FILES[r].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.disk.files[t.CHAT_ID][r]=t.FILES[r]}this.BXIM.messenger.sendAjaxTry=0;for(var r in t.MESSAGE){t.MESSAGE[r].date=parseInt(t.MESSAGE[r].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.message[r]=t.MESSAGE[r]}for(var r in t.USERS){this.BXIM.messenger.users[r]=t.USERS[r]}for(var r in t.CHAT){if(!this.BXIM.messenger.chat[r]){t.CHAT[r].fake=true;this.BXIM.messenger.chat[r]=t.CHAT[r]}}this.BXIM.messenger.linesShowHistory(t.CHAT_ID,{HISTORY:t.USERS_MESSAGE,FILES:t.FILES,CAN_JOIN:t.CAN_JOIN,CAN_VOTE_HEAD:t.CAN_VOTE_HEAD,SESSION_VOTE_HEAD:t.SESSION_VOTE_HEAD,SESSION_ID:t.SESSION_ID})}else{if(t.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(t.ERROR)}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(function(){s.MessengerCommon.prototype.linesGetSessionHistory(sessionID)},1e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0},this)})};s.MessengerCommon.prototype.linesStartSession=function(e){s.ajax({url:this.BXIM.pathToAjax+"?SESSION_START&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"sessionStart",USER_CODE:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.BXIM.messenger.openMessenger("chat"+e.CHAT_ID)}else{if(e.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(e.ERROR)}}},this)})};s.MessengerCommon.prototype.linesVoteDraw=function(e){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.IMOL_VOTE){return null}var t=this.BXIM.messenger.message[e];var r=false;if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){var i=this.linesGetSource(this.BXIM.messenger.message[e].chatId);if(!i){return null}if(!this.BXIM.messenger.users[this.BXIM.userId].connector&&!(i=="livechat"||i=="network")){return null}r=!this.BXIM.messenger.users[this.BXIM.userId].connector}else if(!this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]||this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"){return null}var n="";var a=false;if(t.params.IMOL_VOTE=="like"){a=true;n=t.params.IMOL_VOTE_LIKE}else if(t.params.IMOL_VOTE=="dislike"){a=true;n=t.params.IMOL_VOTE_DISLIKE}else{n=t.params.IMOL_VOTE_TEXT}return s.create("div",{attrs:{"data-messageId":e},props:{className:"bx-messenger-content-item-vote-block"+(a?" bx-messenger-content-item-vote-block-done":"")},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-block-text"},html:s.util.htmlspecialchars(n)}),s.create("div",{props:{className:"bx-messenger-content-item-vote-block-buttons"},children:[s.create("span",{attrs:{title:s.message("IM_OL_VOTE_LIKE")},props:{className:"bx-messenger-content-item-vote-block-like"+(r?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:r?function(){}:s.delegate(function(){this.linesVoteSend(this.BXIM.messenger.currentTab,s.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"like")},this)}}),s.create("span",{attrs:{title:s.message("IM_OL_VOTE_DISLIKE")},props:{className:"bx-messenger-content-item-vote-block-dislike"+(r?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:r?function(){}:s.delegate(function(){this.linesVoteSend(this.BXIM.messenger.currentTab,s.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"dislike")},this)}})]}),s.create("div",{props:{className:"bx-messenger-content-item-vote-block-final"},children:[s.create("span",{props:{className:t.params.IMOL_VOTE=="dislike"?"bx-messenger-content-item-vote-block-smile-dislike":"bx-messenger-content-item-vote-block-smile-like"}})]})]})};s.MessengerCommon.prototype.linesVoteResultDraw=function(e,t){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.IMOL_VOTE_SID){return t}var r=this.BXIM.messenger.message[e];var i="";if(typeof r.params.IMOL_VOTE_USER=="undefined"||r.params.IMOL_VOTE_USER==0){i=s.message("IM_OL_VOTE_WO")}else if(r.params.IMOL_VOTE_USER==5){i='<span class="bx-smile bx-im-smile-like" title="'+s.message("IM_MESSAGE_LIKE")+'"></span>'}else{i='<span class="bx-smile bx-im-smile-dislike" title="'+s.message("IM_MESSAGE_DISLIKE")+'"></span>'}var n=this.linesGetSession(r.chatId);var a=this.linesVoteHeadNodes(r.params.IMOL_VOTE_SID,r.params.IMOL_VOTE_HEAD,n.canVoteHead);return s.create("div",{attrs:{"data-messageId":e},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-message-text"},html:t}),s.create("div",{props:{className:"bx-messenger-content-item-vote-result"},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_VOTE_USER")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},html:i})]}),s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_VOTE_HEAD")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},children:[a]})]})]})]})};s.MessengerCommon.prototype.linesVoteSend=function(e,t,r){if(!this.BXIM.messenger.message[t]||!this.BXIM.messenger.message[t].params||!this.BXIM.messenger.message[t].params.IMOL_VOTE){return false}if(e.toString().substr(0,4)=="chat"){if(!this.BXIM.messenger.users[this.BXIM.userId].connector){return false}}else if(!this.BXIM.messenger.bot[e]||this.BXIM.messenger.bot[e].type!="network"){return null}this.BXIM.messenger.message[t].params.IMOL_VOTE=r;var i=s("im-message-"+t);if(i){i.innerHTML="";i.appendChild(this.linesVoteDraw(t))}s.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_LINES_VOTE_SEND:"Y",DIALOG_ID:e,MESSAGE_ID:t,RATING:r,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){if(this.BXIM.messenger.popupMessengerLiveChatDelayedForm){clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(this.BXIM.messenger.popupMessengerLiveChatDelayedForm);this.BXIM.messenger.popupMessengerLiveChatDelayedForm=null},this),1e3)}},this)})};s.MessengerCommon.prototype.linesStartSessionByMessage=function(e){if(!this.BXIM.messenger.message[e]||this.BXIM.userId!=this.BXIM.messenger.chat[this.BXIM.messenger.message[e].chatId].owner){return false}var t=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(t))return false;this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_START_SESSION_BY_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSessionByMessage",
CHAT_ID:t,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this)})};s.MessengerCommon.prototype.linesVoteHeadNodes=function(e,t,r,i){t=t||0;r=r||false;var n=s.delegate(function(){var e=s.proxy_context.getAttribute("data-rating");var t=s.proxy_context.getAttribute("data-sessionId");s.proxy_context.parentNode.previousSibling.style.width=e*20+"%";if(i)i.setAttribute("data-rating",e);this.linesVoteHeadSend(t,e);if(this.BXIM.messenger.popupTooltip)this.BXIM.messenger.popupTooltip.close()},this);return s.create("div",{props:{className:"bx-lines-rating-box"},children:[s.create("div",{props:{className:"bx-lines-rating-box-current"},attrs:{style:"width:"+t*20+"%"}}),r?s.create("div",{props:{className:"bx-lines-rating-box-live"},children:[s.create("span",{attrs:{"data-rating":1,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:n}}),s.create("span",{attrs:{"data-rating":2,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:n}}),s.create("span",{attrs:{"data-rating":3,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:n}}),s.create("span",{attrs:{"data-rating":4,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:n}}),s.create("span",{attrs:{"data-rating":5,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:n}})]}):null]})};s.MessengerCommon.prototype.linesVoteHeadSend=function(e,t){e=parseInt(e);t=parseInt(t);if(e<=0||t<=0||t>5)return false;s.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"voteHead",SESSION_ID:e,RATING:t,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});return true};s.MessengerCommon.prototype.linesGetSession=function(e){var s=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="lines")return s;s={};s.source=this.linesGetSource(e);var t=this.BXIM.messenger.chat[e].entity_id.toString().split("|");s.connector=t[0];s.canVoteHead=this.BXIM.messenger.openlines&&this.BXIM.messenger.openlines.canVoteAsHead&&this.BXIM.messenger.openlines.canVoteAsHead[t[1]]?this.BXIM.messenger.openlines.canVoteAsHead[t[1]]:false;var r=this.BXIM.messenger.chat[e].entity_data_1.toString().split("|");s.crm=typeof r[0]!="undefined"&&r[0]=="Y"?"Y":"N";s.crmEntityType=typeof r[1]!="undefined"?r[1]:"NONE";s.crmEntityId=typeof r[2]!="undefined"?r[2]:0;s.crmLink="";s.pin=typeof r[3]!="undefined"&&r[3]=="Y"?"Y":"N";s.wait=typeof r[4]!="undefined"&&r[4]=="Y"?"Y":"N";s.id=typeof r[5]!="undefined"?parseInt(r[5]):Math.round(new Date/1e3)+e;if(s.crmEntityType!="NONE"&&this.BXIM.path.crm[s.crmEntityType]){s.crmLink=this.BXIM.path.crm[s.crmEntityType].replace("#ID#",s.crmEntityId)}return s};s.MessengerCommon.prototype.linesSetSession=function(e,s){var t=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="lines")return t;t=this.linesGetSession(e);if(typeof s.crm!="undefined"){t.crm=s.crm}if(typeof s.crmEntityType!="undefined"){t.crmEntityType=s.crmEntityType}if(typeof s.crmEntityId!="undefined"){t.crmEntityId=s.crmEntityId}if(typeof s.pin!="undefined"){t.pin=s.pin}if(typeof s.wait!="undefined"){t.wait=s.wait}this.BXIM.messenger.chat[e].entity_data_1=[t.crm,t.crmEntityType,t.crmEntityId,t.pin,t.wait].join("|");return t};s.MessengerCommon.prototype.livechatGetSession=function(e){var s=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="livechat")return s;s={};var t=this.BXIM.messenger.chat[e].entity_data_1.toString().split("|");s.readed=typeof t[0]!="undefined"&&t[0]=="Y"?"Y":"N";s.readedId=typeof t[1]!="undefined"?t[1]:0;s.readedTime=typeof t[2]!="undefined"?t[2]:0;s.sessionId=typeof t[3]!="undefined"?t[3]:0;s.showForm=typeof t[4]!="undefined"?t[4]:"Y";return s};s.MessengerCommon.prototype.linesGetSource=function(e){var s="";if(!this.BXIM.messenger.chat[e])return s;if(this.BXIM.messenger.chat[e].type=="livechat"){s="livechat"}else{var t=this.BXIM.messenger.chat[e].entity_id.toString().split("|");s=t[0]}if(s=="skypebot"){s="skype"}else{s=s.replace(".","_")}return s};s.MessengerCommon.prototype.linesAnswer=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ANSWER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"answer",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.linesSkip=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_SKIP&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"skip",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.linesActivateSilentMode=function(e,t,r){if(!r)return false;if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;t=t=="Y"?"Y":"";if(this.BXIM.messenger.chat[e].entity_data_3==t)return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_SILENT_MODE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"silentMode",ACTIVATE:t?"Y":"N",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.chat[e].entity_data_3=t},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.linesActivatePinMode=function(e,t){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;t=t=="Y"?"Y":"N";this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_PIN_MODE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"pinMode",ACTIVATE:t,CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;s.MessengerCommon.linesSetSession(e,{pin:t})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.linesCloseDialog=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.MessengerCommon.dialogCloseCurrent();s.ajax({url:this.BXIM.pathToAjax+"?LINES_CLOSE_DIALOG&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"closeDialog",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;s.MessengerCommon.linesSetSession(e,{wait:"Y"});this.BXIM.messenger.redrawChatHeader({userRedraw:false})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.linesMarkAsSpam=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_MARK_SPAM&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"markSpam",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;s.MessengerCommon.linesSetSession(e,{wait:"Y"});this.BXIM.messenger.redrawChatHeader({userRedraw:false})},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.linesCreateLead=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;var t=this.linesGetSession(e);if(t.crm=="Y")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CREATE_LEAD&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"createLead",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};s.MessengerCommon.prototype.linesChangeCrmEntity=function(t){if(!this.BXIM.messenger.message[t])return false;var r=this.BXIM.messenger.message[t].chatId;if(this.BXIM.messenger.blockJoinChat[r])return false;if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(r))return false;var i=this.linesGetSession(r);if(i.crm=="N")return false;this.linesChangeCrmEntityMessageId=t;if(e.obCrm&&e.obCrm.olCrmSelector){e.obCrm.olCrmSelector.Open()}else{s.ajax({url:BXIM.pathToAjax+"?CRM_SELECTOR&V="+BXIM.revision,method:"POST",timeout:30,data:{IM_CRM_SELECTOR:"Y",sessid:s.bitrix_sessid()}});s.addCustomEvent("onCrmSelectorInit",function(t,r,i){if(r!="olCrmSelector")return true;setTimeout(function(){e.obCrm[r].Open();e.obCrm[r].AddOnSaveListener(function(e){s.MessengerCommon.linesChangeCrmEntityAjax(e)})},200)})}};s.MessengerCommon.prototype.linesChangeCrmEntityAjax=function(e){var t=false;for(var r in e["company"]){t=e["company"][r]}if(!t){for(var r in e["contact"]){t=e["contact"][r]}}if(!t){for(var r in e["lead"]){t=e["lead"][r]}}if(!t){return false}var i=this.linesChangeCrmEntityMessageId;if(!this.BXIM.messenger.message[i])return false;var n=this.BXIM.messenger.message[i].chatId;if(this.BXIM.messenger.blockJoinChat[n])return false;if(this.BXIM.messenger.chat[n]&&this.BXIM.messenger.chat[n].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(n))return false;var a=t.id.split("_")[1];var o=t.type;this.BXIM.messenger.blockJoinChat[n]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CHANGE_CRM_ENTITY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"changeCrmEntity",CHAT_ID:n,MESSAGE_ID:i,ENTITY_TYPE:o,ENTITY_ID:a,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[n]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[n]=false},this)})};s.MessengerCommon.prototype.linesCancelCrmExtend=function(e){if(!this.BXIM.messenger.message[e])return false;var t=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(t))return false;this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CANCEL_CRM_EXTEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"cancelCrmExtend",CHAT_ID:t,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this),onfailure:s.delegate(function(){this.BXIM.messenger.blockJoinChat[t]=false},this)});s.remove(s("im-message-keyboard-"+e))};s.MessengerCommon.prototype.getMessagePlural=function(e,t){var r,i;i=s.message("LANGUAGE_ID")||"en";t=parseInt(t);if(t<0){t=-1*t}if(i){switch(i){case"de":case"en":r=t!==1?1:0;break;case"ru":case"ua":r=t%10===1&&t%100!==11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;break;default:r=1;break}}else{r=1}return s.message(e+"_PLURAL_"+r)};s.MessengerCommon.prototype.openRenamePortal=function(e){if(e&&s.hasClass(e,"bx-messenger-keyboard-button-block")){return false}if(this.isMobile()){app.alert({text:s.message("IM_FUNCTION_FOR_BROWSER")})}if(this.isDesktop()){s.desktop.browse(this.BXIM.path.profile+"?b24renameform=1","desktopApp")}else if(typeof s.Bitrix24!="undefined"){s.Bitrix24.renamePortal()}else{this.BXIM.confirm(s.message("IM_UNKNOWN_ERROR"))}return true};s.MessengerCommon=new s.MessengerCommon})(window);
//# sourceMappingURL=common.map.js